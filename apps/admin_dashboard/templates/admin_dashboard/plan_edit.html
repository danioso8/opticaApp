{% extends 'admin_dashboard/base.html' %}

{% block title %}Editar Plan - Admin{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{% url 'admin_dashboard:plans_list' %}" class="text-indigo-600 hover:text-indigo-800 inline-flex items-center">
        <i class="fas fa-arrow-left mr-2"></i> Volver a planes
    </a>
</div>

<div class="max-w-3xl">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">
            <i class="fas fa-edit text-indigo-600 mr-2"></i>
            Editar Plan: {{ plan.name }}
        </h1>

        <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Nombre -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Plan *</label>
                <input type="text" name="name" value="{{ plan.name }}" required 
                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500">
            </div>

            <!-- Descripci칩n -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Plan</label>
                <select name="plan_type" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500">
                    <option value="free" {% if plan.plan_type == 'free' %}selected{% endif %}>Gratuito</option>
                    <option value="basic" {% if plan.plan_type == 'basic' %}selected{% endif %}>B치sico</option>
                    <option value="professional" {% if plan.plan_type == 'professional' %}selected{% endif %}>Profesional</option>
                    <option value="enterprise" {% if plan.plan_type == 'enterprise' %}selected{% endif %}>Empresarial</option>
                </select>
            </div>

            <!-- Precios -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Precio Mensual *</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" name="monthly_price" step="0.01" value="{{ plan.price_monthly }}" required 
                               class="w-full pl-8 pr-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Precio Anual *</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" name="yearly_price" step="0.01" value="{{ plan.price_yearly }}" required 
                               class="w-full pl-8 pr-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500">
                    </div>
                </div>
            </div>

            <!-- L칤mites -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">L칤mites del Plan</h3>
                <p class="text-sm text-gray-600 mb-4">
                    游눠 <strong>Tip:</strong> Usa <code class="bg-gray-100 px-2 py-1 rounded">999999</code> para indicar l칤mite ilimitado
                </p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-users text-indigo-600 mr-1"></i>
                            M치x. Usuarios *
                        </label>
                        <input type="number" name="max_users" value="{{ plan.max_users }}" required min="1"
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
                               placeholder="Ej: 5 o 999999 para ilimitado">
                        <p class="text-xs text-gray-500 mt-1">Usuarios que pueden acceder al sistema</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-building text-indigo-600 mr-1"></i>
                            M치x. Organizaciones/Sucursales *
                        </label>
                        <input type="number" name="max_organizations" value="{{ plan.max_organizations }}" required min="1"
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
                               placeholder="Ej: 2 o 999999 para ilimitado">
                        <p class="text-xs text-gray-500 mt-1">Cantidad de empresas/sucursales que puede crear</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar text-indigo-600 mr-1"></i>
                            M치x. Citas/mes *
                        </label>
                        <input type="number" name="max_appointments" value="{{ plan.max_appointments_month }}" required min="1"
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
                               placeholder="Ej: 100">
                        <p class="text-xs text-gray-500 mt-1">Citas que puede agendar por mes</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-injured text-indigo-600 mr-1"></i>
                            M치x. Pacientes *
                        </label>
                        <input type="number" name="max_patients" value="{{ plan.max_patients }}" required min="1"
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
                               placeholder="Ej: 500">
                        <p class="text-xs text-gray-500 mt-1">Pacientes que puede registrar</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-database text-indigo-600 mr-1"></i>
                            Almacenamiento (MB) *
                        </label>
                        <input type="number" name="max_storage_mb" value="{{ plan.max_storage_mb }}" required min="10"
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
                               placeholder="Ej: 1000">
                        <p class="text-xs text-gray-500 mt-1">Espacio para archivos e im치genes</p>
                    </div>
                </div>
            </div>

            <!-- Facturaci칩n Electr칩nica DIAN -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-file-invoice text-green-600 mr-2"></i>
                    Facturaci칩n Electr칩nica DIAN
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <div class="flex items-center">
                            <input type="checkbox" name="allow_electronic_invoicing" id="allow_invoicing" value="1"
                                   {% if plan.allow_electronic_invoicing %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="allow_invoicing" class="ml-2 block text-sm font-medium text-gray-700">
                                Permitir Facturaci칩n Electr칩nica
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-receipt text-indigo-600 mr-1"></i>
                            M치x. Facturas/Mes
                        </label>
                        <input type="number" name="max_invoices_month" value="{{ plan.max_invoices_month }}" min="0"
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500"
                               placeholder="0 para ilimitado">
                        <p class="text-xs text-gray-500 mt-1">0 = Ilimitado, N = cantidad espec칤fica</p>
                    </div>
                </div>
            </div>

            <!-- Caracter칤sticas -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Caracter칤sticas del Plan</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex items-center">
                        <input type="checkbox" name="whatsapp_integration" id="whatsapp" value="1"
                               {% if plan.whatsapp_integration %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="whatsapp" class="ml-2 block text-sm text-gray-700">
                            <i class="fab fa-whatsapp text-green-600 mr-1"></i>
                            Integraci칩n WhatsApp
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="custom_branding" id="branding" value="1"
                               {% if plan.custom_branding %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="branding" class="ml-2 block text-sm text-gray-700">
                            <i class="fas fa-palette text-purple-600 mr-1"></i>
                            Marca Personalizada
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="api_access" id="api" value="1"
                               {% if plan.api_access %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="api" class="ml-2 block text-sm text-gray-700">
                            <i class="fas fa-code text-blue-600 mr-1"></i>
                            Acceso API
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="priority_support" id="support" value="1"
                               {% if plan.priority_support %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="support" class="ml-2 block text-sm text-gray-700">
                            <i class="fas fa-headset text-orange-600 mr-1"></i>
                            Soporte Prioritario
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="analytics" id="analytics" value="1"
                               {% if plan.analytics %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="analytics" class="ml-2 block text-sm text-gray-700">
                            <i class="fas fa-chart-line text-teal-600 mr-1"></i>
                            An치lisis Avanzado
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="multi_location" id="multiloc" value="1"
                               {% if plan.multi_location %}checked{% endif %}
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="multiloc" class="ml-2 block text-sm text-gray-700">
                            <i class="fas fa-map-marker-alt text-red-600 mr-1"></i>
                            M칰ltiples Ubicaciones
                        </label>
                    </div>
                </div>
            </div>

            <!-- M칩dulos/Caracter칤sticas del Sistema -->
            <div class="border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">
                    <i class="fas fa-puzzle-piece text-indigo-600 mr-2"></i>
                    M칩dulos del Sistema
                </h3>
                <p class="text-sm text-gray-600 mb-4">Selecciona los m칩dulos que estar치n disponibles en este plan</p>
                
                <div class="bg-gray-50 p-4 rounded-lg max-h-64 overflow-y-auto">
                    {% if available_features %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {% for feature in available_features %}
                            <div class="flex items-start">
                                <input type="checkbox" name="features" id="feature_{{ feature.id }}" value="{{ feature.id }}"
                                       {% if feature.id in plan_feature_ids %}checked{% endif %}
                                       class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded mt-1">
                                <label for="feature_{{ feature.id }}" class="ml-2 block text-sm">
                                    {% if feature.icon %}<i class="{{ feature.icon }} mr-1"></i>{% endif %}
                                    <span class="font-medium text-gray-800">{{ feature.name }}</span>
                                    <span class="text-xs text-gray-500 block">{{ feature.get_category_display }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-500 text-center py-4">
                            No hay m칩dulos disponibles. 
                            <a href="{% url 'admin_dashboard:feature_create' %}" class="text-indigo-600 hover:underline">Crear m칩dulo</a>
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Estado -->
            <div class="flex items-center">
                <input type="checkbox" name="is_active" id="is_active" {% if plan.is_active %}checked{% endif %}
                       class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="is_active" class="ml-2 block text-sm text-gray-700">
                    Plan activo (disponible para nuevos usuarios)
                </label>
            </div>

            <!-- Advertencia sobre usuarios existentes -->
            {% if plan.usersubscription_set.count > 0 %}
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mt-1 mr-3"></i>
                    <div>
                        <p class="text-sm text-yellow-700">
                            <strong>Atenci칩n:</strong> Este plan tiene {{ plan.usersubscription_set.count }} usuarios suscritos.
                            Los cambios en los l칤mites afectar치n a todos los usuarios actuales.
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Botones -->
            <div class="flex gap-3 pt-4">
                <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium">
                    <i class="fas fa-save mr-2"></i>Guardar Cambios
                </button>
                <a href="{% url 'admin_dashboard:plans_list' %}" 
                   class="px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
