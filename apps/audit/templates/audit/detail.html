{% extends "dashboard/base.html" %}

{% block title %}Detalle de Auditoría{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-6xl">
    <!-- Breadcrumb -->
    <nav class="mb-4">
        <ol class="flex items-center space-x-2 text-sm text-gray-600">
            <li><a href="{% url 'audit:dashboard' %}" class="hover:text-indigo-600">Auditoría</a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li><a href="{% url 'audit:logs' %}" class="hover:text-indigo-600">Logs</a></li>
            <li><i class="fas fa-chevron-right text-xs"></i></li>
            <li class="text-gray-800 font-semibold">Detalle</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <div class="flex items-center space-x-3 mb-3">
                    {% if log.action == 'CREATE' %}
                    <span class="px-4 py-2 bg-green-100 text-green-800 font-semibold rounded-full">
                        <i class="fas fa-plus mr-1"></i> Crear
                    </span>
                    {% elif log.action == 'UPDATE' %}
                    <span class="px-4 py-2 bg-blue-100 text-blue-800 font-semibold rounded-full">
                        <i class="fas fa-edit mr-1"></i> Actualizar
                    </span>
                    {% elif log.action == 'DELETE' %}
                    <span class="px-4 py-2 bg-red-100 text-red-800 font-semibold rounded-full">
                        <i class="fas fa-trash mr-1"></i> Eliminar
                    </span>
                    {% elif log.action == 'LOGIN' %}
                    <span class="px-4 py-2 bg-purple-100 text-purple-800 font-semibold rounded-full">
                        <i class="fas fa-sign-in-alt mr-1"></i> Login
                    </span>
                    {% else %}
                    <span class="px-4 py-2 bg-gray-100 text-gray-800 font-semibold rounded-full">
                        {{ log.get_action_display }}
                    </span>
                    {% endif %}
                </div>

                <h1 class="text-2xl font-bold text-gray-800 mb-3">
                    {{ log.object_repr|default:"Acción del Sistema" }}
                </h1>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">Usuario:</span>
                        <p class="font-semibold">{{ log.user.get_full_name|default:log.user.username|default:"Sistema" }}</p>
                    </div>
                    <div>
                        <span class="text-gray-500">Fecha y Hora:</span>
                        <p class="font-semibold">{{ log.created_at|date:"d/m/Y H:i:s" }}</p>
                    </div>
                    {% if log.ip_address %}
                    <div>
                        <span class="text-gray-500">Dirección IP:</span>
                        <p class="font-semibold">{{ log.ip_address }}</p>
                    </div>
                    {% endif %}
                    {% if log.content_type %}
                    <div>
                        <span class="text-gray-500">Tipo de Objeto:</span>
                        <p class="font-semibold">{{ log.content_type.model }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="ml-4">
                <a href="{% url 'audit:logs' %}" 
                   class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Volver
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Columna Principal -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Detalles -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-info-circle text-indigo-600 mr-2"></i>
                        Detalles de la Acción
                    </h2>
                </div>
                <div class="p-6">
                    {% if log.description %}
                    <div class="mb-4">
                        <label class="text-sm text-gray-500 font-medium">Descripción</label>
                        <p class="text-gray-800 mt-1">{{ log.description }}</p>
                    </div>
                    {% endif %}

                    {% if log.user_agent %}
                    <div class="mb-4">
                        <label class="text-sm text-gray-500 font-medium">Navegador/Dispositivo</label>
                        <p class="text-gray-800 mt-1 text-sm">{{ log.user_agent|truncatewords:20 }}</p>
                    </div>
                    {% endif %}

                    {% if log.changes %}
                    <div class="mb-4">
                        <label class="text-sm text-gray-500 font-medium mb-2 block">Cambios Realizados</label>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <pre class="text-sm text-gray-800 whitespace-pre-wrap">{{ log.get_changes_display }}</pre>
                        </div>
                    </div>
                    {% endif %}

                    {% if log.metadata %}
                    <div>
                        <label class="text-sm text-gray-500 font-medium mb-2 block">Metadatos</label>
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <pre class="text-xs text-gray-700">{{ log.metadata|safe }}</pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Logs Relacionados -->
            {% if related_logs %}
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-link text-indigo-600 mr-2"></i>
                        Historial del Objeto
                    </h2>
                </div>
                <div class="divide-y divide-gray-200">
                    {% for related in related_logs %}
                    <div class="p-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    {% if related.action == 'CREATE' %}
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Crear</span>
                                    {% elif related.action == 'UPDATE' %}
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Actualizar</span>
                                    {% elif related.action == 'DELETE' %}
                                    <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Eliminar</span>
                                    {% endif %}
                                    <span class="text-sm text-gray-600">
                                        {{ related.user.get_full_name|default:related.user.username|default:"Sistema" }}
                                    </span>
                                </div>
                                <p class="text-xs text-gray-500">{{ related.created_at|date:"d/m/Y H:i:s" }}</p>
                            </div>
                            <a href="{% url 'audit:detail' related.pk %}" class="text-indigo-600 hover:text-indigo-800 text-sm">
                                Ver <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Columna Lateral -->
        <div class="space-y-6">
            <!-- Información del Usuario -->
            {% if log.user %}
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-semibold text-gray-800 mb-4">
                    <i class="fas fa-user text-indigo-600 mr-2"></i>
                    Usuario
                </h3>
                <div class="flex items-center mb-4">
                    <div class="bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center text-indigo-600 font-bold text-lg mr-3">
                        {{ log.user.first_name.0|default:log.user.username.0|upper }}
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">
                            {{ log.user.get_full_name|default:log.user.username }}
                        </p>
                        <p class="text-sm text-gray-500">{{ log.user.email }}</p>
                    </div>
                </div>
                <a href="#" class="block w-full text-center bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                    Ver Actividad del Usuario
                </a>
            </div>
            {% endif %}

            <!-- Actividad del Usuario en el Día -->
            {% if user_logs %}
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="font-semibold text-gray-800">
                        <i class="fas fa-calendar-day text-indigo-600 mr-2"></i>
                        Actividad del Día
                    </h3>
                </div>
                <div class="p-6 max-h-96 overflow-y-auto">
                    <div class="space-y-3">
                        {% for user_log in user_logs %}
                        <div class="text-sm">
                            <div class="flex items-center space-x-2">
                                {% if user_log.action == 'CREATE' %}
                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                {% elif user_log.action == 'UPDATE' %}
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                {% elif user_log.action == 'DELETE' %}
                                <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                                {% else %}
                                <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                {% endif %}
                                <span class="text-gray-700">{{ user_log.get_action_display }}</span>
                            </div>
                            <p class="text-xs text-gray-500 ml-4 mt-1">
                                {{ user_log.created_at|date:"H:i:s" }} - {{ user_log.object_repr|truncatewords:5 }}
                            </p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Información Técnica -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="font-semibold text-gray-800 mb-4">
                    <i class="fas fa-server text-indigo-600 mr-2"></i>
                    Información Técnica
                </h3>
                <div class="space-y-3 text-sm">
                    <div>
                        <label class="text-gray-500">ID de Registro</label>
                        <p class="font-mono text-gray-800">{{ log.pk }}</p>
                    </div>
                    {% if log.object_id %}
                    <div>
                        <label class="text-gray-500">ID de Objeto</label>
                        <p class="font-mono text-gray-800">{{ log.object_id }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <label class="text-gray-500">Timestamp</label>
                        <p class="font-mono text-gray-800">{{ log.created_at|date:"Y-m-d H:i:s.u" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
