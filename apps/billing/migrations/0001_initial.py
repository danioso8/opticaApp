# Generated by Django 3.2.25 on 2025-12-15 16:33

from decimal import Decimal
from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('sales', '0003_alter_category_organization_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('organizations', '0010_auto_20251211_1519'),
        ('patients', '0017_fix_clinical_history_fields'),
        ('appointments', '0012_appointment_unique_active_appointment_slot'),
    ]

    operations = [
        migrations.CreateModel(
            name='Invoice',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('prefijo', models.CharField(max_length=10, verbose_name='Prefijo')),
                ('numero', models.PositiveIntegerField(verbose_name='Número')),
                ('numero_completo', models.CharField(db_index=True, max_length=50, unique=True, verbose_name='Número Completo')),
                ('tipo', models.CharField(choices=[('exam', 'Examen Visual'), ('product', 'Venta de Productos'), ('mixed', 'Examen + Productos')], max_length=20, verbose_name='Tipo de Factura')),
                ('cliente_tipo_documento', models.CharField(max_length=10, verbose_name='Tipo Documento Cliente')),
                ('cliente_numero_documento', models.CharField(max_length=50, verbose_name='Número Documento Cliente')),
                ('cliente_nombre', models.CharField(max_length=300, verbose_name='Nombre Cliente')),
                ('cliente_email', models.EmailField(blank=True, max_length=254, verbose_name='Email Cliente')),
                ('cliente_telefono', models.CharField(blank=True, max_length=50, verbose_name='Teléfono Cliente')),
                ('cliente_direccion', models.TextField(blank=True, verbose_name='Dirección Cliente')),
                ('cliente_ciudad', models.CharField(blank=True, max_length=100, verbose_name='Ciudad Cliente')),
                ('cliente_departamento', models.CharField(blank=True, max_length=100, verbose_name='Departamento Cliente')),
                ('fecha_emision', models.DateTimeField(verbose_name='Fecha de Emisión')),
                ('fecha_vencimiento', models.DateTimeField(blank=True, null=True, verbose_name='Fecha de Vencimiento')),
                ('forma_pago', models.CharField(choices=[('1', 'Contado'), ('2', 'Crédito')], default='1', max_length=1, verbose_name='Forma de Pago')),
                ('medio_pago', models.CharField(choices=[('10', 'Efectivo'), ('42', 'Consignación bancaria'), ('47', 'Transferencia bancaria'), ('48', 'Tarjeta de crédito'), ('49', 'Tarjeta débito'), ('71', 'Múltiples medios de pago')], default='10', max_length=2, verbose_name='Medio de Pago')),
                ('subtotal', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Subtotal')),
                ('descuento', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Descuento')),
                ('base_imponible', models.DecimalField(decimal_places=2, default=Decimal('0.00'), help_text='Subtotal - Descuento', max_digits=15, verbose_name='Base Imponible')),
                ('iva_0', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='IVA 0%')),
                ('iva_5', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='IVA 5%')),
                ('iva_19', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='IVA 19%')),
                ('total_iva', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Total IVA')),
                ('total', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Total a Pagar')),
                ('total_pagado', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Total Pagado')),
                ('saldo_pendiente', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Saldo Pendiente')),
                ('estado_pago', models.CharField(choices=[('unpaid', 'Sin pagar'), ('partial', 'Pago parcial'), ('paid', 'Pagado completo')], default='unpaid', max_length=20, verbose_name='Estado de Pago')),
                ('estado_dian', models.CharField(choices=[('draft', 'Borrador'), ('pending', 'Pendiente de envío'), ('processing', 'Procesando en DIAN'), ('approved', 'Aprobada por DIAN'), ('rejected', 'Rechazada por DIAN')], default='draft', max_length=20, verbose_name='Estado DIAN')),
                ('cufe', models.CharField(blank=True, db_index=True, help_text='Código Único de Factura Electrónica', max_length=200, verbose_name='CUFE')),
                ('xml_sin_firmar', models.TextField(blank=True, verbose_name='XML sin Firmar')),
                ('xml_firmado', models.TextField(blank=True, verbose_name='XML Firmado')),
                ('xml_url', models.URLField(blank=True, verbose_name='URL del XML')),
                ('pdf_generado', models.BooleanField(default=False, verbose_name='PDF Generado')),
                ('pdf_url', models.URLField(blank=True, verbose_name='URL del PDF')),
                ('qr_code_base64', models.TextField(blank=True, verbose_name='Código QR (Base64)')),
                ('dian_response', models.JSONField(blank=True, help_text='JSON completo de la respuesta de la DIAN', null=True, verbose_name='Respuesta DIAN')),
                ('dian_enviado_en', models.DateTimeField(blank=True, null=True, verbose_name='Enviado a DIAN el')),
                ('dian_aprobado_en', models.DateTimeField(blank=True, null=True, verbose_name='Aprobado por DIAN el')),
                ('dian_error_mensaje', models.TextField(blank=True, verbose_name='Mensaje de Error DIAN')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Creado el')),
                ('updated_at', models.DateTimeField(auto_now=True, verbose_name='Actualizado el')),
                ('notas', models.TextField(blank=True, verbose_name='Notas')),
                ('appointment', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='invoices', to='appointments.appointment', verbose_name='Cita')),
                ('aprobado_por', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='invoices_approved', to=settings.AUTH_USER_MODEL, verbose_name='Aprobado por')),
                ('creado_por', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='invoices_created', to=settings.AUTH_USER_MODEL, verbose_name='Creado por')),
                ('organization', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='invoice_set', to='organizations.organization', verbose_name='Organización')),
                ('patient', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='invoices', to='patients.patient', verbose_name='Paciente')),
                ('sale', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='invoices', to='sales.sale', verbose_name='Venta')),
            ],
            options={
                'verbose_name': 'Factura Electrónica',
                'verbose_name_plural': 'Facturas Electrónicas',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='Payment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('payment_number', models.CharField(db_index=True, max_length=50, unique=True, verbose_name='Número de Pago')),
                ('tipo_pago', models.CharField(choices=[('deposit', 'Abono/Anticipo'), ('partial', 'Pago Parcial'), ('full', 'Pago Total')], default='partial', max_length=20, verbose_name='Tipo de Pago')),
                ('amount', models.DecimalField(decimal_places=2, max_digits=15, validators=[django.core.validators.MinValueValidator(Decimal('0.01'))], verbose_name='Monto')),
                ('payment_method', models.CharField(choices=[('cash', 'Efectivo'), ('card_credit', 'Tarjeta de Crédito'), ('card_debit', 'Tarjeta Débito'), ('transfer', 'Transferencia'), ('check', 'Cheque'), ('other', 'Otro')], max_length=20, verbose_name='Método de Pago')),
                ('reference_number', models.CharField(blank=True, help_text='# de transacción, aprobación, etc.', max_length=100, verbose_name='Número de Referencia')),
                ('bank_name', models.CharField(blank=True, max_length=100, verbose_name='Banco')),
                ('payment_date', models.DateTimeField(verbose_name='Fecha de Pago')),
                ('status', models.CharField(choices=[('pending', 'Pendiente'), ('approved', 'Aprobado'), ('rejected', 'Rechazado')], default='approved', max_length=20, verbose_name='Estado')),
                ('created_at', models.DateTimeField(auto_now_add=True, verbose_name='Registrado el')),
                ('notes', models.TextField(blank=True, verbose_name='Notas')),
                ('invoice', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='payments', to='billing.invoice', verbose_name='Factura')),
                ('organization', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='payment_set', to='organizations.organization', verbose_name='Organización')),
                ('processed_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, verbose_name='Procesado por')),
            ],
            options={
                'verbose_name': 'Pago',
                'verbose_name_plural': 'Pagos',
                'ordering': ['-payment_date'],
            },
        ),
        migrations.CreateModel(
            name='InvoiceItem',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('numero_linea', models.PositiveIntegerField(verbose_name='# Línea')),
                ('tipo', models.CharField(choices=[('exam', 'Examen Visual'), ('product', 'Producto'), ('service', 'Servicio')], max_length=20, verbose_name='Tipo')),
                ('codigo', models.CharField(max_length=50, verbose_name='Código')),
                ('descripcion', models.TextField(verbose_name='Descripción')),
                ('cantidad', models.DecimalField(decimal_places=2, default=Decimal('1.00'), max_digits=10, validators=[django.core.validators.MinValueValidator(Decimal('0.01'))], verbose_name='Cantidad')),
                ('unidad_medida', models.CharField(default='94', help_text='94 = Servicio/Unidad', max_length=10, verbose_name='Unidad de Medida')),
                ('valor_unitario', models.DecimalField(decimal_places=2, max_digits=15, validators=[django.core.validators.MinValueValidator(Decimal('0.00'))], verbose_name='Valor Unitario')),
                ('subtotal', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Subtotal')),
                ('descuento_porcentaje', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=5, validators=[django.core.validators.MinValueValidator(Decimal('0.00')), django.core.validators.MaxValueValidator(Decimal('100.00'))], verbose_name='% Descuento')),
                ('descuento_valor', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Valor Descuento')),
                ('iva_porcentaje', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=5, validators=[django.core.validators.MinValueValidator(Decimal('0.00')), django.core.validators.MaxValueValidator(Decimal('100.00'))], verbose_name='% IVA')),
                ('iva_base', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Base IVA')),
                ('valor_iva', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Valor IVA')),
                ('total_linea', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=15, verbose_name='Total Línea')),
                ('invoice', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='items', to='billing.invoice', verbose_name='Factura')),
                ('product', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, to='sales.product', verbose_name='Producto')),
            ],
            options={
                'verbose_name': 'Item de Factura',
                'verbose_name_plural': 'Items de Factura',
                'ordering': ['numero_linea'],
            },
        ),
        migrations.CreateModel(
            name='DianConfiguration',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nit', models.CharField(help_text='NIT sin dígito de verificación. Ej: 900123456', max_length=20, verbose_name='NIT')),
                ('dv', models.CharField(help_text='Dígito de verificación del NIT', max_length=1, verbose_name='DV')),
                ('razon_social', models.CharField(help_text='Nombre legal de la empresa', max_length=300, verbose_name='Razón Social')),
                ('nombre_comercial', models.CharField(blank=True, help_text='Nombre comercial (opcional)', max_length=300, verbose_name='Nombre Comercial')),
                ('direccion', models.CharField(max_length=500, verbose_name='Dirección')),
                ('ciudad_codigo', models.CharField(help_text='Ej: 11001 para Bogotá', max_length=10, verbose_name='Código Ciudad DIVIPOLA')),
                ('ciudad_nombre', models.CharField(max_length=100, verbose_name='Nombre Ciudad')),
                ('departamento_codigo', models.CharField(help_text='Ej: 11 para Cundinamarca', max_length=10, verbose_name='Código Departamento')),
                ('departamento_nombre', models.CharField(max_length=100, verbose_name='Nombre Departamento')),
                ('pais_codigo', models.CharField(default='CO', max_length=2, verbose_name='Código País')),
                ('codigo_postal', models.CharField(max_length=20, verbose_name='Código Postal')),
                ('telefono', models.CharField(max_length=50, verbose_name='Teléfono')),
                ('email_facturacion', models.EmailField(help_text='Email desde el cual se enviarán facturas', max_length=254, verbose_name='Email Facturación')),
                ('responsabilidades_fiscales', models.JSONField(default=list, help_text="Ej: ['O-13', 'O-15', 'R-99-PN']", verbose_name='Responsabilidades Fiscales')),
                ('tipo_regimen', models.CharField(default='49', help_text='49 = No responsable de IVA', max_length=2, verbose_name='Tipo de Régimen')),
                ('resolucion_numero', models.CharField(help_text='Número asignado por la DIAN', max_length=50, verbose_name='Número de Resolución')),
                ('resolucion_fecha', models.DateField(verbose_name='Fecha de Resolución')),
                ('resolucion_prefijo', models.CharField(default='FE', help_text='Prefijo para facturas. Ej: FE, FEPV', max_length=10, verbose_name='Prefijo')),
                ('resolucion_numero_inicio', models.PositiveIntegerField(help_text='Primer número del rango autorizado', verbose_name='Número Inicial')),
                ('resolucion_numero_fin', models.PositiveIntegerField(help_text='Último número del rango autorizado', verbose_name='Número Final')),
                ('resolucion_numero_actual', models.PositiveIntegerField(default=0, help_text='Último número utilizado', verbose_name='Número Actual')),
                ('resolucion_clave_tecnica', models.CharField(help_text='Clave técnica proporcionada por la DIAN', max_length=500, verbose_name='Clave Técnica')),
                ('resolucion_vigencia_inicio', models.DateField(verbose_name='Vigencia Desde')),
                ('resolucion_vigencia_fin', models.DateField(verbose_name='Vigencia Hasta')),
                ('certificado_archivo', models.FileField(blank=True, help_text='Archivo .p12 o .pfx del certificado digital', null=True, upload_to='certificates/%Y/%m/', verbose_name='Certificado Digital')),
                ('certificado_password', models.CharField(blank=True, help_text='Contraseña del archivo .p12/.pfx (se guardará cifrada)', max_length=500, verbose_name='Contraseña del Certificado')),
                ('certificado_vigencia_inicio', models.DateField(blank=True, null=True, verbose_name='Certificado Vigente Desde')),
                ('certificado_vigencia_fin', models.DateField(blank=True, null=True, verbose_name='Certificado Vigente Hasta')),
                ('ambiente', models.CharField(choices=[('2', 'Ambiente de Pruebas'), ('1', 'Producción')], default='2', max_length=1, verbose_name='Ambiente DIAN')),
                ('dian_url_webservice', models.URLField(default='https://vpfe-hab.dian.gov.co/WcfDianCustomerServices.svc', verbose_name='URL Web Service DIAN')),
                ('dian_url_validacion', models.URLField(default='https://catalogo-vpfe-hab.dian.gov.co/Document/FindDocument', verbose_name='URL Validación DIAN')),
                ('incluir_iva', models.BooleanField(default=True, help_text='¿Los productos llevan IVA?', verbose_name='Incluir IVA')),
                ('porcentaje_iva_defecto', models.DecimalField(decimal_places=2, default=Decimal('19.00'), max_digits=5, verbose_name='% IVA por Defecto')),
                ('precio_examen_visual', models.DecimalField(decimal_places=2, default=Decimal('50000.00'), help_text='Precio estándar del examen visual', max_digits=10, verbose_name='Precio Examen Visual')),
                ('codigo_examen_visual', models.CharField(default='EXA-VIS-001', max_length=50, verbose_name='Código Examen Visual')),
                ('is_active', models.BooleanField(default=False, verbose_name='Configuración Activa')),
                ('habilitado_dian', models.BooleanField(default=False, help_text='¿Ya fue habilitado ante la DIAN?', verbose_name='Habilitado ante DIAN')),
                ('fecha_habilitacion', models.DateTimeField(blank=True, null=True, verbose_name='Fecha de Habilitación')),
                ('configurado_en', models.DateTimeField(auto_now_add=True, verbose_name='Configurado el')),
                ('actualizado_en', models.DateTimeField(auto_now=True, verbose_name='Última Actualización')),
                ('notas', models.TextField(blank=True, help_text='Notas internas sobre la configuración', verbose_name='Notas')),
                ('configurado_por', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='dian_configs_created', to=settings.AUTH_USER_MODEL, verbose_name='Configurado por')),
                ('organization', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='dianconfiguration_set', to='organizations.organization', verbose_name='Organización')),
            ],
            options={
                'verbose_name': 'Configuración DIAN',
                'verbose_name_plural': 'Configuraciones DIAN',
            },
        ),
        migrations.AddIndex(
            model_name='payment',
            index=models.Index(fields=['organization', 'payment_date'], name='billing_pay_organiz_c5a873_idx'),
        ),
        migrations.AddIndex(
            model_name='payment',
            index=models.Index(fields=['invoice'], name='billing_pay_invoice_147afb_idx'),
        ),
        migrations.AddIndex(
            model_name='invoice',
            index=models.Index(fields=['organization', 'numero_completo'], name='billing_inv_organiz_2a9229_idx'),
        ),
        migrations.AddIndex(
            model_name='invoice',
            index=models.Index(fields=['organization', 'estado_dian'], name='billing_inv_organiz_b55059_idx'),
        ),
        migrations.AddIndex(
            model_name='invoice',
            index=models.Index(fields=['organization', 'estado_pago'], name='billing_inv_organiz_ffd5ab_idx'),
        ),
        migrations.AddIndex(
            model_name='invoice',
            index=models.Index(fields=['cufe'], name='billing_inv_cufe_15612b_idx'),
        ),
        migrations.AddIndex(
            model_name='invoice',
            index=models.Index(fields=['patient'], name='billing_inv_patient_a03932_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='invoice',
            unique_together={('organization', 'numero_completo')},
        ),
        migrations.AddIndex(
            model_name='dianconfiguration',
            index=models.Index(fields=['organization', 'is_active'], name='billing_dia_organiz_4b2719_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='dianconfiguration',
            unique_together={('organization',)},
        ),
    ]
