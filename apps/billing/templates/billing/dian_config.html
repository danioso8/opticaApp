{% extends 'dashboard/base.html' %}

{% block title %}Configuración DIAN{% endblock %}

{% block page_title %}Configuración DIAN - Facturación Electrónica{% endblock %}
{% block page_subtitle %}Configuración única de facturación electrónica según resolución DIAN{% endblock %}

{% block content %}

<!-- Alerta de Plan -->
{% if not can_use_invoicing %}
<div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-6 rounded-lg">
    <div class="flex items-start">
        <i class="fas fa-exclamation-triangle text-amber-600 text-2xl mr-3 mt-1"></i>
        <div>
            <h4 class="font-semibold text-amber-800 mb-1">Plan Requerido</h4>
            <p class="text-amber-700">{{ plan_message }}</p>
            <a href="/users/subscriptions/" class="mt-2 inline-block px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">
                <i class="fas fa-arrow-up mr-1"></i> Actualizar Plan
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Info del Plan Actual -->
{% if subscription %}
<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-lg">
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <i class="fas fa-crown text-blue-600 text-2xl mr-3"></i>
            <div>
                <h4 class="font-semibold text-blue-800">Plan Actual: {{ subscription.plan.name }}</h4>
                {% if subscription.plan.max_invoices_month == 0 %}
                <p class="text-sm text-blue-700">✅ Facturas Ilimitadas</p>
                {% else %}
                <p class="text-sm text-blue-700">✅ Hasta {{ subscription.plan.max_invoices_month }} facturas/mes</p>
                {% endif %}
            </div>
        </div>
        <span class="text-xs text-blue-600">{{ plan_message }}</span>
    </div>
</div>
{% endif %}

<!-- Nota informativa de configuración única -->
<div class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-6 rounded-lg">
    <div class="flex items-center">
        <i class="fas fa-info-circle text-indigo-600 text-xl mr-3"></i>
        <div>
            <h4 class="font-semibold text-indigo-800 text-sm">Configuración Única DIAN por Organización</h4>
            <p class="text-indigo-700 text-sm">Esta es la configuración de facturación electrónica para <strong>{{ organization.name }}</strong>. Solo puede haber una configuración DIAN activa.</p>
        </div>
    </div>
</div>

<!-- Formulario de Configuración -->
<div class="bg-white rounded-lg shadow p-6">
    <form method="POST" {% if not can_use_invoicing %}style="pointer-events: none; opacity: 0.6;"{% endif %}>
        {% csrf_token %}
        
        <!-- Sección 1: Información Básica -->
        <div class="mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-building mr-2 text-emerald-600"></i>
                1. Información de la Empresa
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Razón Social *</label>
                    <input 
                        type="text" 
                        name="razon_social" 
                        value="{{ dian_config.razon_social }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="Nombre completo de la empresa"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento *</label>
                    <select 
                        name="tipo_documento"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                    >
                        <option value="NIT" {% if dian_config.tipo_documento == 'NIT' or not dian_config.tipo_documento %}selected{% endif %}>NIT - Número de Identificación Tributaria</option>
                        <option value="RUT" {% if dian_config.tipo_documento == 'RUT' %}selected{% endif %}>RUT - Registro Único Tributario</option>
                        <option value="CC" {% if dian_config.tipo_documento == 'CC' %}selected{% endif %}>CC - Cédula de Ciudadanía</option>
                        <option value="CE" {% if dian_config.tipo_documento == 'CE' %}selected{% endif %}>CE - Cédula de Extranjería</option>
                        <option value="PA" {% if dian_config.tipo_documento == 'PA' %}selected{% endif %}>PA - Pasaporte</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Documento *</label>
                    <input 
                        type="text" 
                        name="nit" 
                        value="{{ dian_config.nit }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="900123456 o documento según tipo"
                        maxlength="20"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dígito de Verificación *</label>
                    <input 
                        type="text" 
                        name="dv" 
                        value="{{ dian_config.dv }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="1"
                        maxlength="1"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Organización *</label>
                    <select 
                        name="tipo_organizacion"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                    >
                        <option value="1" {% if dian_config.tipo_organizacion == '1' %}selected{% endif %}>Persona Jurídica</option>
                        <option value="2" {% if dian_config.tipo_organizacion == '2' %}selected{% endif %}>Persona Natural</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Sección 2: Dirección -->
        <div class="mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-map-marker-alt mr-2 text-emerald-600"></i>
                2. Dirección Fiscal
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dirección *</label>
                    <input 
                        type="text" 
                        name="direccion" 
                        value="{{ dian_config.direccion }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="Calle 123 # 45-67"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código Ciudad *</label>
                    <input 
                        type="text" 
                        name="ciudad_codigo" 
                        value="{{ dian_config.ciudad_codigo }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="Ej: 11001 (Bogotá)"
                    >
                    <small class="text-gray-500">Código DANE de 5 dígitos</small>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código Departamento *</label>
                    <input 
                        type="text" 
                        name="departamento_codigo" 
                        value="{{ dian_config.departamento_codigo }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="Ej: 11 (Bogotá D.C.)"
                    >
                    <small class="text-gray-500">Código DANE de 2 dígitos</small>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Código Postal *</label>
                    <input 
                        type="text" 
                        name="codigo_postal" 
                        value="{{ dian_config.codigo_postal }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="110111"
                    >
                </div>
            </div>
        </div>
        
        <!-- Sección 3: Contacto -->
        <div class="mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-phone mr-2 text-emerald-600"></i>
                3. Información de Contacto
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono *</label>
                    <input 
                        type="text" 
                        name="telefono" 
                        value="{{ dian_config.telefono }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="+57 300 123 4567"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email de Facturación *</label>
                    <input 
                        type="email" 
                        name="email_facturacion" 
                        value="{{ dian_config.email_facturacion }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="facturacion@empresa.com"
                    >
                    <small class="text-gray-500">Email desde el cual se enviarán las facturas</small>
                </div>
            </div>
        </div>
        
        <!-- Sección 4: Resolución DIAN -->
        <div class="mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-file-contract mr-2 text-emerald-600"></i>
                4. Resolución de Facturación DIAN
            </h3>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    Ingrese los datos de la resolución de facturación electrónica otorgada por la DIAN
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número de Resolución *</label>
                    <input 
                        type="text" 
                        name="resolucion_numero" 
                        value="{{ dian_config.resolucion_numero }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="18760000001"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Resolución *</label>
                    <input 
                        type="date" 
                        name="resolucion_fecha" 
                        value="{{ dian_config.resolucion_fecha|date:'Y-m-d' }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prefijo *</label>
                    <input 
                        type="text" 
                        name="resolucion_prefijo" 
                        value="{{ dian_config.resolucion_prefijo }}"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="FE"
                        maxlength="10"
                    >
                    <small class="text-gray-500">Ej: FE, FEPV</small>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número Inicial *</label>
                    <input 
                        type="number" 
                        name="resolucion_numero_inicio" 
                        value="{{ dian_config.resolucion_numero_inicio }}"
                        required
                        min="1"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="1"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Número Final *</label>
                    <input 
                        type="number" 
                        name="resolucion_numero_fin" 
                        value="{{ dian_config.resolucion_numero_fin }}"
                        required
                        min="1"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500"
                        placeholder="5000"
                    >
                </div>
                
                {% if dian_config.resolucion_numero_actual > 0 %}
                <div class="md:col-span-2">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <i class="fas fa-receipt mr-1"></i>
                            <strong>Número Actual:</strong> {{ dian_config.get_numero_completo }}
                        </p>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-emerald-600 h-2 rounded-full" style="width: {{ dian_config.porcentaje_numeracion }}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                {{ dian_config.numeros_disponibles }} números disponibles ({{ dian_config.porcentaje_numeracion }}% usado)
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Sección 5: Estado -->
        <div class="mb-8">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-toggle-on mr-2 text-emerald-600"></i>
                5. Estado de la Configuración
            </h3>
            
            <div class="space-y-3">
                <div class="flex items-center">
                    <input 
                        type="checkbox" 
                        name="is_active" 
                        id="is_active"
                        {% if dian_config.is_active %}checked{% endif %}
                        class="w-5 h-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500"
                    >
                    <label for="is_active" class="ml-2 block text-sm text-gray-700">
                        <strong>Configuración Activa</strong> - Activar esta configuración para usar facturación electrónica
                    </label>
                </div>
                
                <div class="flex items-center">
                    <input 
                        type="checkbox" 
                        name="habilitado_dian" 
                        id="habilitado_dian"
                        {% if dian_config.habilitado_dian %}checked{% endif %}
                        class="w-5 h-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500"
                    >
                    <label for="habilitado_dian" class="ml-2 block text-sm text-gray-700">
                        <strong>Habilitado ante la DIAN</strong> - Ya completó el proceso de habilitación con la DIAN
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Botones de Acción -->
        <div class="flex items-center justify-end space-x-3 pt-6 border-t">
            <a href="{% url 'dashboard:home' %}" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                <i class="fas fa-times mr-1"></i> Cancelar
            </a>
            <button 
                type="submit" 
                class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition"
                {% if not can_use_invoicing %}disabled{% endif %}
            >
                <i class="fas fa-sync-alt mr-1"></i> Actualizar Configuración
            </button>
        </div>
    </form>
</div>

<!-- Link a documentación -->
<div class="mt-6 bg-gray-50 rounded-lg p-4">
    <p class="text-sm text-gray-600">
        <i class="fas fa-book mr-1"></i>
        <strong>¿Necesita ayuda?</strong> 
        Consulte la documentación completa sobre facturación electrónica DIAN en el archivo 
        <code class="bg-white px-2 py-1 rounded text-xs">FACTURACION_ELECTRONICA_DIAN.md</code>
    </p>
</div>

{% endblock %}
