{% extends 'dashboard/base.html' %}

{% block title %}Dashboard Principal{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Resumen general del sistema{% endblock %}

{% block content %}
<!-- Secci√≥n de M√©tricas Principales -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-chart-line mr-2 text-indigo-600"></i>
        Resumen del D√≠a
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
        <!-- Ventas Diarias -->
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg shadow-lg p-4 md:p-6 text-white hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-emerald-100 text-xs md:text-sm font-medium">Ventas Hoy</p>
                    <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">${{ stats.sales.today_revenue|floatformat:0 }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                    <i class="fas fa-dollar-sign text-xl md:text-2xl"></i>
                </div>
            </div>
            <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-emerald-100">
                <i class="fas fa-shopping-bag mr-1"></i>
                <span class="font-medium">{{ stats.sales.today_count }} ventas</span>
            </div>
        </div>
        
        <!-- Citas Hoy -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-4 md:p-6 text-white hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-xs md:text-sm font-medium">Citas Hoy</p>
                    <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">{{ stats.today.total }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                    <i class="fas fa-calendar-day text-xl md:text-2xl"></i>
                </div>
            </div>
            <div class="mt-3 md:mt-4 text-xs md:text-sm text-blue-100">
                <span class="font-medium">{{ stats.today.confirmed }} confirmadas</span>
                <span class="mx-2">|</span>
                <span class="font-medium">{{ stats.today.pending }} pendientes</span>
            </div>
        </div>
        
        <!-- Completadas -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-4 md:p-6 text-white hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-xs md:text-sm font-medium">Completadas</p>
                    <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">{{ stats.today.completed }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                    <i class="fas fa-check-circle text-xl md:text-2xl"></i>
                </div>
            </div>
            <p class="mt-3 md:mt-4 text-xs md:text-sm text-green-100">
                Citas atendidas hoy
            </p>
        </div>
        
        <!-- Total Pacientes -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-4 md:p-6 text-white hover:shadow-xl transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-xs md:text-sm font-medium">Total Pacientes</p>
                    <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">{{ stats.total_patients }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                    <i class="fas fa-users text-xl md:text-2xl"></i>
                </div>
            </div>
            <p class="mt-3 md:mt-4 text-xs md:text-sm text-purple-100">
                Pacientes activos
            </p>
        </div>
    </div>
</div>


<!-- Secci√≥n de Ex√°menes Especiales -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-microscope mr-2 text-purple-600"></i>
        Estado de Ex√°menes Especiales
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- Ex√°menes Pendientes -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-4 md:p-6 text-white cursor-pointer hover:shadow-xl transition-shadow" onclick="window.location.href='{% url 'dashboard:exam_order_list' %}?status=pending'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-xs md:text-sm font-medium">Ex√°menes Pendientes</p>
                    <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">{{ stats.exams.pending }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                    <i class="fas fa-flask text-xl md:text-2xl"></i>
                </div>
            </div>
            <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-purple-100">
                <i class="fas fa-clock mr-1"></i>
                <span class="font-medium">Esperando realizaci√≥n</span>
            </div>
        </div>
        
        <!-- Ex√°menes Urgentes -->
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-4 md:p-6 text-white cursor-pointer hover:shadow-xl transition-shadow" onclick="window.location.href='{% url 'dashboard:exam_order_list' %}?priority=urgent'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-xs md:text-sm font-medium">Ex√°menes Urgentes</p>
                    <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">{{ stats.exams.urgent }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                    <i class="fas fa-exclamation-triangle text-xl md:text-2xl"></i>
                </div>
            </div>
            <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-orange-100">
                <i class="fas fa-bolt mr-1"></i>
                <span class="font-medium">Requieren atenci√≥n prioritaria</span>
            </div>
        </div>
        
        <!-- Ex√°menes Completados Hoy -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-4 md:p-6 text-white cursor-pointer hover:shadow-xl transition-shadow" onclick="window.location.href='{% url 'dashboard:exam_order_list' %}?status=completed'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-xs md:text-sm font-medium">Completados Hoy</p>
                    <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">{{ stats.exams.completed_today }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                    <i class="fas fa-check-circle text-xl md:text-2xl"></i>
                </div>
            </div>
            <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-green-100">
                <i class="fas fa-chart-line mr-1"></i>
                <span class="font-medium">Resultados disponibles</span>
            </div>
        </div>
    </div>
</div>


<!-- Secci√≥n de Facturaci√≥n y Finanzas -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-dollar-sign mr-2 text-green-600"></i>
        Resumen Financiero
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
        <!-- Facturado este mes -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-blue-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Facturado este mes</p>
                    <h3 class="text-xl md:text-2xl font-bold text-blue-600 mt-1 md:mt-2">${{ billing_stats.month.total_facturado|floatformat:0 }}</h3>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="fas fa-file-invoice-dollar text-blue-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-receipt mr-1"></i>
                <span>{{ billing_stats.month.total_invoices }} facturas</span>
            </div>
        </div>
        
        <!-- Cobrado este mes -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-green-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Cobrado este mes</p>
                    <h3 class="text-xl md:text-2xl font-bold text-green-600 mt-1 md:mt-2">${{ billing_stats.month.total_cobrado|floatformat:0 }}</h3>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-hand-holding-usd text-green-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-check-circle mr-1"></i>
                <span>Pagos recibidos</span>
            </div>
        </div>
        
        <!-- Por cobrar -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-orange-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Total por cobrar</p>
                    <h3 class="text-xl md:text-2xl font-bold text-orange-600 mt-1 md:mt-2">${{ billing_stats.total_por_cobrar|floatformat:0 }}</h3>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="fas fa-clock text-orange-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-exclamation-circle mr-1"></i>
                <span>{{ billing_stats.unpaid_count }} facturas pendientes</span>
            </div>
        </div>
        
        <!-- Acceso r√°pido a facturaci√≥n -->
        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg shadow-md p-4 md:p-6 text-white hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='{% url 'billing:invoice_list' %}'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-indigo-100 text-xs md:text-sm font-medium">M√≥dulo de</p>
                    <h3 class="text-lg md:text-xl font-bold mt-1 md:mt-2">Facturaci√≥n</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fas fa-file-invoice text-lg md:text-xl"></i>
                </div>
            </div>
            <p class="mt-3 text-xs md:text-sm font-medium">
                <i class="fas fa-arrow-right mr-1"></i>Ver todas las facturas
            </p>
        </div>
    </div>
</div>


<!-- Secci√≥n de Caja y Tesorer√≠a -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-cash-register mr-2 text-emerald-600"></i>
        Estado de Caja
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
        <!-- Cajas Abiertas -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-emerald-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Cajas Abiertas</p>
                    <h3 class="text-xl md:text-2xl font-bold text-emerald-600 mt-1 md:mt-2">{{ cash_stats.open_registers }}</h3>
                </div>
                <div class="bg-emerald-100 rounded-full p-3">
                    <i class="fas fa-cash-register text-emerald-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-check-circle mr-1"></i>
                <span>Activas hoy</span>
            </div>
        </div>
        
        <!-- Saldo Total -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-blue-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Saldo Total en Cajas</p>
                    <h3 class="text-xl md:text-2xl font-bold text-blue-600 mt-1 md:mt-2">${{ cash_stats.total_balance|floatformat:0 }}</h3>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="fas fa-wallet text-blue-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-coins mr-1"></i>
                <span>Efectivo disponible</span>
            </div>
        </div>
        
        <!-- Ingresos Hoy -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-green-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Ingresos Hoy</p>
                    <h3 class="text-xl md:text-2xl font-bold text-green-600 mt-1 md:mt-2">${{ cash_stats.cash_inflows|floatformat:0 }}</h3>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-arrow-down text-green-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-plus-circle mr-1"></i>
                <span>Movimientos de entrada</span>
            </div>
        </div>
        
        <!-- Egresos Hoy -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-red-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Egresos Hoy</p>
                    <h3 class="text-xl md:text-2xl font-bold text-red-600 mt-1 md:mt-2">${{ cash_stats.cash_outflows|floatformat:0 }}</h3>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <i class="fas fa-arrow-up text-red-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-minus-circle mr-1"></i>
                <span>Movimientos de salida</span>
            </div>
        </div>
    </div>
</div>


<!-- Secci√≥n de Inventario -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-boxes mr-2 text-indigo-600"></i>
        Estado de Inventario
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
        <!-- Total Productos -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-indigo-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Total Productos</p>
                    <h3 class="text-xl md:text-2xl font-bold text-indigo-600 mt-1 md:mt-2">{{ inventory_stats.total_products }}</h3>
                </div>
                <div class="bg-indigo-100 rounded-full p-3">
                    <i class="fas fa-box text-indigo-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-cubes mr-1"></i>
                <span>En cat√°logo</span>
            </div>
        </div>
        
        <!-- Valor del Inventario -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-purple-500 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Valor del Inventario</p>
                    <h3 class="text-xl md:text-2xl font-bold text-purple-600 mt-1 md:mt-2">${{ inventory_stats.inventory_value|floatformat:0 }}</h3>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <i class="fas fa-money-bill-wave text-purple-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-calculator mr-1"></i>
                <span>Valor total en stock</span>
            </div>
        </div>
        
        <!-- Stock Bajo -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-orange-500 hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='{% url 'inventory:dashboard' %}'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Stock Bajo</p>
                    <h3 class="text-xl md:text-2xl font-bold text-orange-600 mt-1 md:mt-2">{{ inventory_stats.low_stock }}</h3>
                </div>
                <div class="bg-orange-100 rounded-full p-3">
                    <i class="fas fa-exclamation-triangle text-orange-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-arrow-down mr-1"></i>
                <span>Requieren reabastecimiento</span>
            </div>
        </div>
        
        <!-- Sin Stock -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 border-t-4 border-red-500 hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='{% url 'inventory:dashboard' %}'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-xs md:text-sm font-medium">Sin Stock</p>
                    <h3 class="text-xl md:text-2xl font-bold text-red-600 mt-1 md:mt-2">{{ inventory_stats.out_of_stock }}</h3>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <i class="fas fa-times-circle text-red-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm text-gray-500">
                <i class="fas fa-ban mr-1"></i>
                <span>Agotados</span>
            </div>
        </div>
    </div>
</div>


<!-- Secci√≥n de Marketing y Comunicaci√≥n -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-bullhorn mr-2 text-pink-600"></i>
        Marketing y Comunicaci√≥n
    </h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- Mensajes WhatsApp -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-md p-4 md:p-6 text-white hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='{% url 'dashboard:notification_settings' %}'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-xs md:text-sm font-medium">WhatsApp este Mes</p>
                    <h3 class="text-xl md:text-2xl font-bold mt-1 md:mt-2">{{ whatsapp_usage.messages_sent|default:0 }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fab fa-whatsapp text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm flex justify-between items-center">
                <span>De {{ whatsapp_usage.monthly_limit|default:100 }} disponibles</span>
                <span class="font-semibold">{{ whatsapp_usage.percentage_used|default:0 }}%</span>
            </div>
        </div>
        
        <!-- Promociones Activas -->
        <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg shadow-md p-4 md:p-6 text-white hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='/dashboard/promociones/'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-pink-100 text-xs md:text-sm font-medium">Promociones Activas</p>
                    <h3 class="text-xl md:text-2xl font-bold mt-1 md:mt-2">{{ promotions_stats.active_campaigns }}</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fas fa-tags text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-3 text-xs md:text-sm">
                <i class="fas fa-chart-line mr-1"></i>
                <span>De {{ promotions_stats.total_campaigns }} campa√±as totales</span>
            </div>
        </div>
        
        <!-- Landing Page -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-md p-4 md:p-6 text-white hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='{% url 'dashboard:landing_page_config' %}'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-xs md:text-sm font-medium">Landing Page</p>
                    <h3 class="text-lg md:text-xl font-bold mt-1 md:mt-2">Configuraci√≥n</h3>
                </div>
                <div class="bg-white bg-opacity-20 rounded-full p-3">
                    <i class="fas fa-paint-brush text-lg md:text-xl"></i>
                </div>
            </div>
            <p class="mt-3 text-xs md:text-sm font-medium">
                <i class="fas fa-arrow-right mr-1"></i>Personalizar p√°gina web
            </p>
        </div>
    </div>
</div>


<!-- Secci√≥n de Actividad Reciente -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fas fa-history mr-2 text-gray-600"></i>
        Actividad Reciente
    </h2>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- Pr√≥ximas Citas -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
                <h3 class="text-base md:text-lg font-semibold text-gray-800">
                    <i class="fas fa-clock mr-2 text-indigo-600"></i>
                    Pr√≥ximas Citas
                </h3>
                <a href="{% url 'dashboard:appointments_list' %}" class="text-indigo-600 hover:text-indigo-800 text-xs md:text-sm font-medium">
                    Ver todas <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
        {% if upcoming_appointments %}
        <div class="space-y-2">
            {% for appointment in upcoming_appointments %}
            <div class="border-l-4 {% if appointment.status == 'confirmed' %}border-green-500{% elif appointment.status == 'pending' %}border-yellow-500{% else %}border-gray-300{% endif %} pl-3 py-2 hover:bg-gray-50 transition-colors rounded">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-gray-800">{{ appointment.full_name }}</p>
                        <p class="text-xs text-gray-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>{{ appointment.appointment_date|date:"d/m/Y" }}
                            <i class="fas fa-clock ml-2 mr-1"></i>{{ appointment.appointment_time|time:"H:i" }}
                        </p>
                    </div>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full whitespace-nowrap
                        {% if appointment.status == 'confirmed' %}bg-green-100 text-green-800
                        {% elif appointment.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ appointment.get_status_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-6 text-gray-500">
            <i class="fas fa-calendar-times text-3xl mb-2 opacity-50"></i>
            <p class="text-sm">No hay citas pr√≥ximas</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Ex√°menes Especiales Pendientes -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">
                <i class="fas fa-microscope mr-2 text-purple-600"></i>
                Ex√°menes Pendientes
            </h3>
            <a href="{% url 'dashboard:exam_order_list' %}" class="text-purple-600 hover:text-purple-800 text-xs md:text-sm font-medium">
                Ver todos <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        {% if pending_exams %}
        <div class="space-y-2">
            {% for exam in pending_exams %}
            <div class="border-l-4 {% if exam.priority == 'STAT' %}border-red-500{% elif exam.priority == 'urgent' %}border-orange-500{% else %}border-purple-500{% endif %} pl-3 py-2 cursor-pointer hover:bg-gray-50 transition-colors rounded" onclick="window.location.href='{% url 'dashboard:exam_order_detail' exam.id %}'">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-gray-800">{{ exam.clinical_history.patient.full_name }}</p>
                        <p class="text-xs text-gray-600 mt-1">
                            <i class="fas fa-flask mr-1"></i>{{ exam.get_exam_type_display }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-calendar mr-1"></i>{{ exam.order_date|date:"d/m/Y" }}
                        </p>
                    </div>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full whitespace-nowrap
                        {% if exam.priority == 'STAT' %}bg-red-100 text-red-800
                        {% elif exam.priority == 'urgent' %}bg-orange-100 text-orange-800
                        {% else %}bg-purple-100 text-purple-800{% endif %}">
                        {{ exam.get_priority_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-6 text-gray-500">
            <i class="fas fa-check-circle text-3xl mb-2 text-green-500 opacity-50"></i>
            <p class="text-sm">No hay ex√°menes pendientes</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Facturas Pendientes de Pago -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">
                <i class="fas fa-exclamation-triangle mr-2 text-orange-600"></i>
                Facturas Pendientes
            </h3>
            <a href="{% url 'billing:invoice_list' %}" class="text-orange-600 hover:text-orange-800 text-xs md:text-sm font-medium">
                Ver todas <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        {% if invoices_unpaid %}
        <div class="space-y-2">
            {% for invoice in invoices_unpaid %}
            <div class="border-l-4 {% if invoice.estado_pago == 'unpaid' %}border-red-500{% else %}border-orange-500{% endif %} pl-3 py-2 cursor-pointer hover:bg-gray-50 transition-colors rounded" onclick="window.location.href='{% url 'billing:invoice_detail' invoice.id %}'">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-gray-800">{{ invoice.numero_completo }}</p>
                        <p class="text-xs text-gray-600 mt-1">{{ invoice.cliente_nombre }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-calendar mr-1"></i>{{ invoice.fecha_emision|date:"d/m/Y" }}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm {% if invoice.estado_pago == 'unpaid' %}text-red-600{% else %}text-orange-600{% endif %}">
                            ${{ invoice.saldo_pendiente|floatformat:0 }}
                        </p>
                        <p class="text-xs text-gray-500">de ${{ invoice.total|floatformat:0 }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-6 text-gray-500">
            <i class="fas fa-check-circle text-3xl mb-2 text-green-500 opacity-50"></i>
            <p class="text-sm">¬°Todas las facturas est√°n al d√≠a!</p>
        </div>
        {% endif %}
    </div>
</div>
</div>

<!-- Secci√≥n de Uso de WhatsApp -->
<div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
        <i class="fab fa-whatsapp mr-2 text-green-600"></i>
        Uso de Mensajes WhatsApp
    </h2>
    <div class="grid grid-cols-1 gap-4 md:gap-6">
        {% include 'dashboard/widgets/whatsapp_usage_widget.html' with usage=whatsapp_usage current_month=current_month plan_name=plan_name %}
    </div>
</div>

<!-- Secci√≥n de Informaci√≥n Adicional -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
    <!-- Pagos Recientes -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">
                <i class="fas fa-money-bill-wave mr-2 text-green-600"></i>
                Pagos Recientes
            </h3>
            <a href="{% url 'billing:invoice_list' %}" class="text-green-600 hover:text-green-800 text-xs md:text-sm font-medium">
                Ver facturas <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        {% if recent_payments %}
        <div class="space-y-2">
            {% for payment in recent_payments %}
            <div class="border-l-4 border-green-500 pl-3 py-2 cursor-pointer hover:bg-gray-50 transition-colors rounded" onclick="window.location.href='{% url 'billing:invoice_detail' payment.invoice.id %}'">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-1">
                        <p class="font-semibold text-sm text-gray-800">{{ payment.invoice.numero_completo }}</p>
                        <p class="text-xs text-gray-600 mt-1">{{ payment.invoice.cliente_nombre }}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-calendar mr-1"></i>{{ payment.payment_date|date:"d/m/Y H:i" }}
                            <span class="ml-2">
                                <i class="fas fa-credit-card mr-1"></i>{{ payment.get_payment_method_display }}
                            </span>
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm text-green-600">
                            ${{ payment.amount|floatformat:0 }}
                        </p>
                        <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">
                            {{ payment.get_tipo_pago_display }}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-6 text-gray-500">
            <i class="fas fa-receipt text-3xl mb-2 opacity-50"></i>
            <p class="text-sm">No hay pagos registrados</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Accesos R√°pidos y Estado del Sistema -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-rocket mr-2 text-indigo-600"></i>
            Accesos R√°pidos
        </h3>
        
        <!-- Estado del Sistema -->
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0
                        {% if stats.system_open %}bg-green-100{% else %}bg-red-100{% endif %}">
                        <i class="fas {% if stats.system_open %}fa-check text-green-600{% else %}fa-times text-red-600{% endif %} text-sm"></i>
                    </div>
                    <div class="ml-3">
                        <p class="font-semibold text-sm text-gray-800">Sistema de Agendamiento</p>
                        <p class="text-xs text-gray-600">
                            {% if stats.system_open %}Abierto - Recibiendo citas{% else %}Cerrado - No se pueden agendar citas{% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botones de Acceso R√°pido -->
        <div class="grid grid-cols-2 gap-3">
            <a href="{% url 'dashboard:appointments_today' %}" class="p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors group">
                <i class="fas fa-calendar-day text-indigo-600 text-lg group-hover:scale-110 transition-transform inline-block"></i>
                <p class="mt-2 font-medium text-sm text-gray-800">Citas de Hoy</p>
            </a>
            
            <a href="{% url 'billing:invoice_create' %}" class="p-3 bg-emerald-50 rounded-lg hover:bg-emerald-100 transition-colors group">
                <i class="fas fa-plus-circle text-emerald-600 text-lg group-hover:scale-110 transition-transform inline-block"></i>
                <p class="mt-2 font-medium text-sm text-gray-800">Nueva Factura</p>
            </a>
            
            <a href="{% url 'dashboard:patients_list' %}" class="p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors group">
                <i class="fas fa-users text-blue-600 text-lg group-hover:scale-110 transition-transform inline-block"></i>
                <p class="mt-2 font-medium text-sm text-gray-800">Pacientes</p>
            </a>
            
            <a href="{% url 'dashboard:calendar' %}" class="p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-colors group">
                <i class="fas fa-calendar text-green-600 text-lg group-hover:scale-110 transition-transform inline-block"></i>
                <p class="mt-2 font-medium text-sm text-gray-800">Calendario</p>
            </a>
        </div>
    </div>
</div>

<!-- Modal de configuraci√≥n de WhatsApp -->
<div id="whatsappSetupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target === this) closeWhatsAppSetupModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                Activar Notificaciones por WhatsApp
            </h3>
            <button onclick="closeWhatsAppSetupModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6">
            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-gift text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-800">
                            ¬°100% Gratuito!
                        </p>
                        <p class="text-xs text-green-700 mt-1">
                            Sin costos mensuales, sin l√≠mites de mensajes. Solo necesitas un n√∫mero de WhatsApp.
                        </p>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Paso 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                        1
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Abre una nueva ventana de PowerShell</h4>
                        <p class="text-sm text-gray-600 mb-2">Haz clic en el men√∫ Inicio de Windows y busca "PowerShell"</p>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-xs text-gray-500 mb-2">O presiona:</p>
                            <div class="flex items-center gap-2">
                                <kbd class="px-3 py-1 bg-white border border-gray-300 rounded text-sm">Windows</kbd>
                                <span>+</span>
                                <kbd class="px-3 py-1 bg-white border border-gray-300 rounded text-sm">R</kbd>
                                <span class="text-sm text-gray-600">‚Üí escribe "powershell" ‚Üí Enter</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                        2
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Navega a la carpeta del bot</h4>
                        <p class="text-sm text-gray-600 mb-2">Copia y pega este comando:</p>
                        <div class="relative">
                            <code class="block bg-gray-900 text-green-400 p-3 rounded-lg text-sm" id="cmd1">cd D:\ESCRITORIO\OpticaApp\whatsapp-bot</code>
                            <button onclick="copyCommand('cmd1')" class="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Luego presiona Enter</p>
                    </div>
                </div>

                <!-- Paso 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                        3
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Instala las dependencias (solo la primera vez)</h4>
                        <p class="text-sm text-gray-600 mb-2">Ejecuta:</p>
                        <div class="relative">
                            <code class="block bg-gray-900 text-green-400 p-3 rounded-lg text-sm" id="cmd2">npm install</code>
                            <button onclick="copyCommand('cmd2')" class="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Espera a que termine (puede tardar 1-2 minutos)</p>
                    </div>
                </div>

                <!-- Paso 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">
                        4
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Inicia el servidor</h4>
                        <p class="text-sm text-gray-600 mb-2">Ejecuta:</p>
                        <div class="relative">
                            <code class="block bg-gray-900 text-green-400 p-3 rounded-lg text-sm" id="cmd3">npm start</code>
                            <button onclick="copyCommand('cmd3')" class="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <p class="text-xs text-green-600 mt-2 font-medium">
                            <i class="fas fa-info-circle mr-1"></i>
                            Ver√°s un mensaje "Servidor WhatsApp Bot iniciado"
                        </p>
                    </div>
                </div>

                <!-- Paso 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">
                        5
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Conecta tu WhatsApp</h4>
                        <p class="text-sm text-gray-600 mb-3">Abre en tu navegador:</p>
                        <a href="http://localhost:3000/qr" target="_blank" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-qrcode mr-2"></i>
                            Abrir p√°gina de conexi√≥n
                        </a>
                        <div class="mt-3 bg-blue-50 p-3 rounded-lg">
                            <p class="text-xs text-blue-800 font-medium mb-2">
                                <i class="fas fa-mobile-alt mr-1"></i> En tu tel√©fono:
                            </p>
                            <ol class="text-xs text-blue-700 space-y-1 ml-4 list-decimal">
                                <li>Abre WhatsApp</li>
                                <li>Ve a Men√∫ (‚ãÆ) ‚Üí Dispositivos vinculados</li>
                                <li>Toca "Vincular un dispositivo"</li>
                                <li>Escanea el c√≥digo QR que aparece en el navegador</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Paso 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-green-800 mb-2">¬°Listo!</h4>
                        <p class="text-sm text-gray-600">
                            Regresa a esta p√°gina y haz clic en "Actualizar". 
                            El estado cambiar√° a verde üü¢ y podr√°s probar enviando mensajes.
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200">
                <button onclick="closeWhatsAppSetupModal(); checkWhatsAppStatus();" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Cerrar y verificar estado
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de prueba de WhatsApp -->
<div id="testWhatsAppModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">
                <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                Enviar Mensaje de Prueba
            </h3>
            <button onclick="closeTestWhatsAppModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de tel√©fono</label>
            <input type="text" id="testPhone" placeholder="3001234567" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <p class="text-xs text-gray-500 mt-1">Ingresa el n√∫mero sin espacios ni guiones</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeTestWhatsAppModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                Cancelar
            </button>
            <button onclick="sendTestWhatsApp()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <i class="fas fa-paper-plane mr-2"></i>
                Enviar
            </button>
        </div>
        
        <div id="testWhatsAppResult" class="mt-4 hidden"></div>
    </div>
</div>

<script>
function checkWhatsAppStatus() {
    fetch('{% url "dashboard:whatsapp_status" %}')
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('whatsapp-status-content');
            
            if (data.connected) {
                content.innerHTML = `
                    <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-green-900">WhatsApp conectado y funcionando</p>
                            <p class="text-xs text-green-700 mt-1">Las notificaciones se enviar√°n autom√°ticamente</p>
                        </div>
                        <button onclick="showTestWhatsAppModal()" class="ml-4 px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                            <i class="fas fa-paper-plane mr-1"></i> Probar
                        </button>
                    </div>
                `;
            } else if (data.server_running) {
                content.innerHTML = `
                    <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-yellow-900">Servidor corriendo, pero WhatsApp no conectado</p>
                            <p class="text-xs text-yellow-700 mt-1">Escanea el c√≥digo QR para conectar</p>
                        </div>
                        <a href="${data.api_url}/qr" target="_blank" class="ml-4 px-4 py-2 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700">
                            <i class="fas fa-qrcode mr-1"></i> Ver QR
                        </a>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                            </div>
                            <div class="ml-4 flex-1">
                                <p class="text-sm font-medium text-red-900 mb-2">Servidor WhatsApp no est√° corriendo</p>
                                <p class="text-xs text-red-700 mb-3">Para activar las notificaciones autom√°ticas por WhatsApp, necesitas iniciar el servidor.</p>
                                <button onclick="showWhatsAppSetupModal()" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition">
                                    <i class="fas fa-rocket mr-2"></i>
                                    C√≥mo activar WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function showWhatsAppSetupModal() {
    document.getElementById('whatsappSetupModal').classList.remove('hidden');
}

function closeWhatsAppSetupModal() {
    document.getElementById('whatsappSetupModal').classList.add('hidden');
}

function copyCommand(cmdId) {
    const cmd = document.getElementById(cmdId);
    const text = cmd.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const btn = cmd.nextElementSibling;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check mr-1"></i> Copiado';
        btn.classList.add('bg-green-600');
        btn.classList.remove('bg-gray-700');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('bg-green-600');
            btn.classList.add('bg-gray-700');
        }, 2000);
    });
}

function showTestWhatsAppModal() {
    document.getElementById('testWhatsAppModal').classList.remove('hidden');
    document.getElementById('testPhone').value = '';
    document.getElementById('testWhatsAppResult').classList.add('hidden');
}

function closeTestWhatsAppModal() {
    document.getElementById('testWhatsAppModal').classList.add('hidden');
}

function sendTestWhatsApp() {
    const phone = document.getElementById('testPhone').value;
    const resultDiv = document.getElementById('testWhatsAppResult');
    
    if (!phone) {
        resultDiv.innerHTML = `
            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Por favor ingresa un n√∫mero de tel√©fono
            </div>
        `;
        resultDiv.classList.remove('hidden');
        return;
    }
    
    resultDiv.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            Enviando mensaje...
        </div>
    `;
    resultDiv.classList.remove('hidden');
    
    fetch('{% url "dashboard:whatsapp_test_send" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ phone: phone })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-800">
                    <i class="fas fa-check-circle mr-2"></i>
                    ${data.message}
                </div>
            `;
            setTimeout(() => {
                closeTestWhatsAppModal();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    ${data.message}
                    ${data.help ? '<br><small class="mt-1 block">' + data.help + '</small>' : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Error al enviar mensaje
            </div>
        `;
    });
}

// Auto-actualizar estado cada 30 segundos
setInterval(checkWhatsAppStatus, 30000);
</script>
{% endblock %}
