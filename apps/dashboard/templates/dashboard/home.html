{% extends 'dashboard/base.html' %}

{% block title %}Dashboard Principal{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Resumen general del sistema{% endblock %}

{% block content %}
<!-- Tarjetas de Estad√≠sticas -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
    <!-- Ventas Diarias -->
    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg shadow-lg p-4 md:p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-emerald-100 text-xs md:text-sm font-medium">Ventas Hoy</p>
                <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">${{ stats.sales.today_revenue|floatformat:0 }}</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                <i class="fas fa-dollar-sign text-xl md:text-2xl"></i>
            </div>
        </div>
        <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-emerald-100">
            <i class="fas fa-shopping-bag mr-1"></i>
            <span class="font-medium">{{ stats.sales.today_count }} ventas</span>
        </div>
    </div>
    
    <!-- Citas Hoy -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs md:text-sm font-medium">Citas Hoy</p>
                <h3 class="text-2xl md:text-3xl font-bold text-gray-800 mt-1 md:mt-2">{{ stats.today.total }}</h3>
            </div>
            <div class="bg-blue-100 rounded-full p-3 md:p-4">
                <i class="fas fa-calendar-day text-blue-600 text-xl md:text-2xl"></i>
            </div>
        </div>
        <div class="mt-3 md:mt-4 flex flex-col sm:flex-row items-start sm:items-center text-xs md:text-sm gap-1 sm:gap-0">
            <span class="text-green-600 font-medium">{{ stats.today.confirmed }} confirmadas</span>
            <span class="text-gray-400 mx-2 hidden sm:inline">|</span>
            <span class="text-yellow-600 font-medium">{{ stats.today.pending }} pendientes</span>
        </div>
    </div>
    
    <!-- Completadas -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs md:text-sm font-medium">Completadas</p>
                <h3 class="text-2xl md:text-3xl font-bold text-green-600 mt-1 md:mt-2">{{ stats.today.completed }}</h3>
            </div>
            <div class="bg-green-100 rounded-full p-3 md:p-4">
                <i class="fas fa-check-circle text-green-600 text-xl md:text-2xl"></i>
            </div>
        </div>
        <p class="mt-3 md:mt-4 text-xs md:text-sm text-gray-600">
            Citas atendidas hoy
        </p>
    </div>
    
    <!-- Total Pacientes -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs md:text-sm font-medium">Total Pacientes</p>
                <h3 class="text-2xl md:text-3xl font-bold text-purple-600 mt-1 md:mt-2">{{ stats.total_patients }}</h3>
            </div>
            <div class="bg-purple-100 rounded-full p-3 md:p-4">
                <i class="fas fa-users text-purple-600 text-xl md:text-2xl"></i>
            </div>
        </div>
        <p class="mt-3 md:mt-4 text-xs md:text-sm text-gray-600">
            Pacientes activos
        </p>
    </div>
</div>

<!-- Tarjetas de Facturaci√≥n -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
    <!-- Facturado este mes -->
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-4 md:p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 text-xs md:text-sm font-medium">Facturado este mes</p>
                <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">${{ billing_stats.month.total_facturado|floatformat:0 }}</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                <i class="fas fa-file-invoice-dollar text-xl md:text-2xl"></i>
            </div>
        </div>
        <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-blue-100">
            <i class="fas fa-receipt mr-1"></i>
            <span class="font-medium">{{ billing_stats.month.total_invoices }} facturas</span>
        </div>
    </div>
    
    <!-- Cobrado este mes -->
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-4 md:p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-100 text-xs md:text-sm font-medium">Cobrado este mes</p>
                <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">${{ billing_stats.month.total_cobrado|floatformat:0 }}</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                <i class="fas fa-hand-holding-usd text-xl md:text-2xl"></i>
            </div>
        </div>
        <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-green-100">
            <i class="fas fa-check-circle mr-1"></i>
            <span class="font-medium">Pagos recibidos</span>
        </div>
    </div>
    
    <!-- Por cobrar -->
    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-4 md:p-6 text-white">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-orange-100 text-xs md:text-sm font-medium">Total por cobrar</p>
                <h3 class="text-2xl md:text-3xl font-bold mt-1 md:mt-2">${{ billing_stats.total_por_cobrar|floatformat:0 }}</h3>
            </div>
            <div class="bg-white bg-opacity-20 rounded-full p-3 md:p-4">
                <i class="fas fa-clock text-xl md:text-2xl"></i>
            </div>
        </div>
        <div class="mt-3 md:mt-4 flex items-center text-xs md:text-sm text-orange-100">
            <i class="fas fa-exclamation-circle mr-1"></i>
            <span class="font-medium">{{ billing_stats.unpaid_count }} facturas pendientes</span>
        </div>
    </div>
    
    <!-- Acceso r√°pido a facturaci√≥n -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6 hover:shadow-lg transition cursor-pointer" onclick="window.location.href='{% url 'billing:invoice_list' %}'">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-xs md:text-sm font-medium">Facturaci√≥n</p>
                <h3 class="text-lg md:text-xl font-bold text-gray-800 mt-1 md:mt-2">Ver facturas</h3>
            </div>
            <div class="bg-indigo-100 rounded-full p-3 md:p-4">
                <i class="fas fa-file-invoice text-indigo-600 text-xl md:text-2xl"></i>
            </div>
        </div>
        <p class="mt-3 md:mt-4 text-xs md:text-sm text-indigo-600 font-medium">
            <i class="fas fa-arrow-right mr-1"></i>Ir al m√≥dulo
        </p>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
    <!-- Pr√≥ximas Citas -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">
                <i class="fas fa-clock mr-2 text-indigo-600"></i>
                Pr√≥ximas Citas
            </h3>
            <a href="{% url 'dashboard:appointments_list' %}" class="text-indigo-600 hover:text-indigo-800 text-xs md:text-sm font-medium">
                Ver todas <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        {% if upcoming_appointments %}
        <div class="space-y-2 md:space-y-3">
            {% for appointment in upcoming_appointments %}
            <div class="border-l-4 {% if appointment.status == 'confirmed' %}border-green-500{% elif appointment.status == 'pending' %}border-yellow-500{% else %}border-gray-300{% endif %} pl-3 md:pl-4 py-2">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-1">
                        <p class="font-semibold text-sm md:text-base text-gray-800">{{ appointment.full_name }}</p>
                        <p class="text-xs md:text-sm text-gray-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>
                            {{ appointment.appointment_date|date:"d/m/Y" }}
                            <i class="fas fa-clock ml-2 mr-1"></i>
                            {{ appointment.appointment_time|time:"H:i" }}
                        </p>
                    </div>
                    <span class="px-2 md:px-3 py-1 text-xs font-semibold rounded-full whitespace-nowrap
                        {% if appointment.status == 'confirmed' %}bg-green-100 text-green-800
                        {% elif appointment.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ appointment.get_status_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-calendar-times text-4xl mb-3"></i>
            <p>No hay citas pr√≥ximas</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Facturas Pendientes de Pago -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">
                <i class="fas fa-exclamation-triangle mr-2 text-orange-600"></i>
                Facturas Pendientes
            </h3>
            <a href="{% url 'billing:invoice_list' %}" class="text-orange-600 hover:text-orange-800 text-xs md:text-sm font-medium">
                Ver todas <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        {% if invoices_unpaid %}
        <div class="space-y-2 md:space-y-3">
            {% for invoice in invoices_unpaid %}
            <div class="border-l-4 {% if invoice.estado_pago == 'unpaid' %}border-red-500{% else %}border-orange-500{% endif %} pl-3 md:pl-4 py-2 cursor-pointer hover:bg-gray-50 transition" onclick="window.location.href='{% url 'billing:invoice_detail' invoice.id %}'">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-1">
                        <p class="font-semibold text-sm md:text-base text-gray-800">{{ invoice.numero_completo }}</p>
                        <p class="text-xs md:text-sm text-gray-600 mt-1">
                            {{ invoice.cliente_nombre }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-calendar mr-1"></i>{{ invoice.fecha_emision|date:"d/m/Y" }}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm md:text-base {% if invoice.estado_pago == 'unpaid' %}text-red-600{% else %}text-orange-600{% endif %}">
                            ${{ invoice.saldo_pendiente|floatformat:0 }}
                        </p>
                        <p class="text-xs text-gray-500">
                            Total: ${{ invoice.total|floatformat:0 }}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-check-circle text-4xl mb-3 text-green-500"></i>
            <p>¬°Todas las facturas est√°n al d√≠a!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Segunda fila: Pagos recientes y Estado del sistema -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">
    <!-- Pagos Recientes -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <h3 class="text-base md:text-lg font-semibold text-gray-800">
                <i class="fas fa-money-bill-wave mr-2 text-green-600"></i>
                Pagos Recientes
            </h3>
            <a href="{% url 'billing:invoice_list' %}" class="text-green-600 hover:text-green-800 text-xs md:text-sm font-medium">
                Ver facturas <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        
        {% if recent_payments %}
        <div class="space-y-2 md:space-y-3">
            {% for payment in recent_payments %}
            <div class="border-l-4 border-green-500 pl-3 md:pl-4 py-2 cursor-pointer hover:bg-gray-50 transition" onclick="window.location.href='{% url 'billing:invoice_detail' payment.invoice.id %}'">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                    <div class="flex-1">
                        <p class="font-semibold text-sm md:text-base text-gray-800">{{ payment.invoice.numero_completo }}</p>
                        <p class="text-xs md:text-sm text-gray-600 mt-1">
                            {{ payment.invoice.cliente_nombre }}
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-calendar mr-1"></i>{{ payment.payment_date|date:"d/m/Y H:i" }}
                            <span class="ml-2">
                                <i class="fas fa-credit-card mr-1"></i>{{ payment.get_payment_method_display }}
                            </span>
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm md:text-base text-green-600">
                            ${{ payment.amount|floatformat:0 }}
                        </p>
                        <span class="text-xs px-2 py-1 bg-green-100 text-green-800 rounded-full">
                            {{ payment.get_tipo_pago_display }}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-receipt text-4xl mb-3"></i>
            <p>No hay pagos registrados</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Estado del Sistema -->
    <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
        <h3 class="text-base md:text-lg font-semibold text-gray-800 mb-4">
            <i class="fas fa-info-circle mr-2 text-indigo-600"></i>
            Estado del Sistema
        </h3>
        
        <div class="space-y-3 md:space-y-4">
            <!-- Sistema Abierto/Cerrado -->
            <div class="flex items-center justify-between p-3 md:p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center">
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center flex-shrink-0
                        {% if stats.system_open %}bg-green-100{% else %}bg-red-100{% endif %}">
                        <i class="fas {% if stats.system_open %}fa-check text-green-600{% else %}fa-times text-red-600{% endif %} text-sm md:text-base"></i>
                    </div>
                    <div class="ml-3 md:ml-4">
                        <p class="font-semibold text-sm md:text-base text-gray-800">Sistema de Agendamiento</p>
                        <p class="text-xs md:text-sm text-gray-600">
                            {% if stats.system_open %}
                            Abierto - Recibiendo citas
                            {% else %}
                            Cerrado - No se pueden agendar citas
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Accesos R√°pidos -->
            <div class="grid grid-cols-2 gap-2 md:gap-3 mt-3 md:mt-4">
                <a href="{% url 'dashboard:appointments_today' %}" class="p-3 md:p-4 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition">
                    <i class="fas fa-calendar-day text-indigo-600 text-lg md:text-xl"></i>
                    <p class="mt-2 font-medium text-xs md:text-sm text-gray-800">Citas de Hoy</p>
                </a>
                
                <a href="{% url 'billing:invoice_create' %}" class="p-3 md:p-4 bg-emerald-50 rounded-lg hover:bg-emerald-100 transition">
                    <i class="fas fa-plus-circle text-emerald-600 text-lg md:text-xl"></i>
                    <p class="mt-2 font-medium text-xs md:text-sm text-gray-800">Nueva Factura</p>
                </a>
                
                <a href="{% url 'dashboard:configuration' %}" class="p-3 md:p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition">
                    <i class="fas fa-cog text-purple-600 text-lg md:text-xl"></i>
                    <p class="mt-2 font-medium text-xs md:text-sm text-gray-800">Configuraci√≥n</p>
                </a>
                
                <a href="{% url 'dashboard:patients_list' %}" class="p-3 md:p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                    <i class="fas fa-users text-blue-600 text-lg md:text-xl"></i>
                    <p class="mt-2 font-medium text-xs md:text-sm text-gray-800">Pacientes</p>
                </a>
                
                <a href="{% url 'dashboard:calendar' %}" class="p-3 md:p-4 bg-green-50 rounded-lg hover:bg-green-100 transition">
                    <i class="fas fa-calendar text-green-600 text-lg md:text-xl"></i>
                    <p class="mt-2 font-medium text-xs md:text-sm text-gray-800">Calendario</p>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal de configuraci√≥n de WhatsApp -->
<div id="whatsappSetupModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50" onclick="if(event.target === this) closeWhatsAppSetupModal()">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-800">
                <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                Activar Notificaciones por WhatsApp
            </h3>
            <button onclick="closeWhatsAppSetupModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div class="p-6">
            <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-gift text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-green-800">
                            ¬°100% Gratuito!
                        </p>
                        <p class="text-xs text-green-700 mt-1">
                            Sin costos mensuales, sin l√≠mites de mensajes. Solo necesitas un n√∫mero de WhatsApp.
                        </p>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Paso 1 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                        1
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Abre una nueva ventana de PowerShell</h4>
                        <p class="text-sm text-gray-600 mb-2">Haz clic en el men√∫ Inicio de Windows y busca "PowerShell"</p>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-xs text-gray-500 mb-2">O presiona:</p>
                            <div class="flex items-center gap-2">
                                <kbd class="px-3 py-1 bg-white border border-gray-300 rounded text-sm">Windows</kbd>
                                <span>+</span>
                                <kbd class="px-3 py-1 bg-white border border-gray-300 rounded text-sm">R</kbd>
                                <span class="text-sm text-gray-600">‚Üí escribe "powershell" ‚Üí Enter</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 2 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                        2
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Navega a la carpeta del bot</h4>
                        <p class="text-sm text-gray-600 mb-2">Copia y pega este comando:</p>
                        <div class="relative">
                            <code class="block bg-gray-900 text-green-400 p-3 rounded-lg text-sm" id="cmd1">cd D:\ESCRITORIO\OpticaApp\whatsapp-bot</code>
                            <button onclick="copyCommand('cmd1')" class="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Luego presiona Enter</p>
                    </div>
                </div>

                <!-- Paso 3 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">
                        3
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Instala las dependencias (solo la primera vez)</h4>
                        <p class="text-sm text-gray-600 mb-2">Ejecuta:</p>
                        <div class="relative">
                            <code class="block bg-gray-900 text-green-400 p-3 rounded-lg text-sm" id="cmd2">npm install</code>
                            <button onclick="copyCommand('cmd2')" class="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Espera a que termine (puede tardar 1-2 minutos)</p>
                    </div>
                </div>

                <!-- Paso 4 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">
                        4
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Inicia el servidor</h4>
                        <p class="text-sm text-gray-600 mb-2">Ejecuta:</p>
                        <div class="relative">
                            <code class="block bg-gray-900 text-green-400 p-3 rounded-lg text-sm" id="cmd3">npm start</code>
                            <button onclick="copyCommand('cmd3')" class="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600">
                                <i class="fas fa-copy mr-1"></i> Copiar
                            </button>
                        </div>
                        <p class="text-xs text-green-600 mt-2 font-medium">
                            <i class="fas fa-info-circle mr-1"></i>
                            Ver√°s un mensaje "Servidor WhatsApp Bot iniciado"
                        </p>
                    </div>
                </div>

                <!-- Paso 5 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">
                        5
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 mb-2">Conecta tu WhatsApp</h4>
                        <p class="text-sm text-gray-600 mb-3">Abre en tu navegador:</p>
                        <a href="http://localhost:3000/qr" target="_blank" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-qrcode mr-2"></i>
                            Abrir p√°gina de conexi√≥n
                        </a>
                        <div class="mt-3 bg-blue-50 p-3 rounded-lg">
                            <p class="text-xs text-blue-800 font-medium mb-2">
                                <i class="fas fa-mobile-alt mr-1"></i> En tu tel√©fono:
                            </p>
                            <ol class="text-xs text-blue-700 space-y-1 ml-4 list-decimal">
                                <li>Abre WhatsApp</li>
                                <li>Ve a Men√∫ (‚ãÆ) ‚Üí Dispositivos vinculados</li>
                                <li>Toca "Vincular un dispositivo"</li>
                                <li>Escanea el c√≥digo QR que aparece en el navegador</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Paso 6 -->
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-green-800 mb-2">¬°Listo!</h4>
                        <p class="text-sm text-gray-600">
                            Regresa a esta p√°gina y haz clic en "Actualizar". 
                            El estado cambiar√° a verde üü¢ y podr√°s probar enviando mensajes.
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200">
                <button onclick="closeWhatsAppSetupModal(); checkWhatsAppStatus();" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Cerrar y verificar estado
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de prueba de WhatsApp -->
<div id="testWhatsAppModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">
                <i class="fab fa-whatsapp text-green-600 mr-2"></i>
                Enviar Mensaje de Prueba
            </h3>
            <button onclick="closeTestWhatsAppModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de tel√©fono</label>
            <input type="text" id="testPhone" placeholder="3001234567" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <p class="text-xs text-gray-500 mt-1">Ingresa el n√∫mero sin espacios ni guiones</p>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeTestWhatsAppModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                Cancelar
            </button>
            <button onclick="sendTestWhatsApp()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <i class="fas fa-paper-plane mr-2"></i>
                Enviar
            </button>
        </div>
        
        <div id="testWhatsAppResult" class="mt-4 hidden"></div>
    </div>
</div>

<script>
function checkWhatsAppStatus() {
    fetch('{% url "dashboard:whatsapp_status" %}')
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('whatsapp-status-content');
            
            if (data.connected) {
                content.innerHTML = `
                    <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-green-900">WhatsApp conectado y funcionando</p>
                            <p class="text-xs text-green-700 mt-1">Las notificaciones se enviar√°n autom√°ticamente</p>
                        </div>
                        <button onclick="showTestWhatsAppModal()" class="ml-4 px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                            <i class="fas fa-paper-plane mr-1"></i> Probar
                        </button>
                    </div>
                `;
            } else if (data.server_running) {
                content.innerHTML = `
                    <div class="flex items-center p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="text-sm font-medium text-yellow-900">Servidor corriendo, pero WhatsApp no conectado</p>
                            <p class="text-xs text-yellow-700 mt-1">Escanea el c√≥digo QR para conectar</p>
                        </div>
                        <a href="${data.api_url}/qr" target="_blank" class="ml-4 px-4 py-2 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700">
                            <i class="fas fa-qrcode mr-1"></i> Ver QR
                        </a>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                            </div>
                            <div class="ml-4 flex-1">
                                <p class="text-sm font-medium text-red-900 mb-2">Servidor WhatsApp no est√° corriendo</p>
                                <p class="text-xs text-red-700 mb-3">Para activar las notificaciones autom√°ticas por WhatsApp, necesitas iniciar el servidor.</p>
                                <button onclick="showWhatsAppSetupModal()" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition">
                                    <i class="fas fa-rocket mr-2"></i>
                                    C√≥mo activar WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function showWhatsAppSetupModal() {
    document.getElementById('whatsappSetupModal').classList.remove('hidden');
}

function closeWhatsAppSetupModal() {
    document.getElementById('whatsappSetupModal').classList.add('hidden');
}

function copyCommand(cmdId) {
    const cmd = document.getElementById(cmdId);
    const text = cmd.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const btn = cmd.nextElementSibling;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check mr-1"></i> Copiado';
        btn.classList.add('bg-green-600');
        btn.classList.remove('bg-gray-700');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('bg-green-600');
            btn.classList.add('bg-gray-700');
        }, 2000);
    });
}

function showTestWhatsAppModal() {
    document.getElementById('testWhatsAppModal').classList.remove('hidden');
    document.getElementById('testPhone').value = '';
    document.getElementById('testWhatsAppResult').classList.add('hidden');
}

function closeTestWhatsAppModal() {
    document.getElementById('testWhatsAppModal').classList.add('hidden');
}

function sendTestWhatsApp() {
    const phone = document.getElementById('testPhone').value;
    const resultDiv = document.getElementById('testWhatsAppResult');
    
    if (!phone) {
        resultDiv.innerHTML = `
            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Por favor ingresa un n√∫mero de tel√©fono
            </div>
        `;
        resultDiv.classList.remove('hidden');
        return;
    }
    
    resultDiv.innerHTML = `
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            Enviando mensaje...
        </div>
    `;
    resultDiv.classList.remove('hidden');
    
    fetch('{% url "dashboard:whatsapp_test_send" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ phone: phone })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-800">
                    <i class="fas fa-check-circle mr-2"></i>
                    ${data.message}
                </div>
            `;
            setTimeout(() => {
                closeTestWhatsAppModal();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    ${data.message}
                    ${data.help ? '<br><small class="mt-1 block">' + data.help + '</small>' : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-800">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Error al enviar mensaje
            </div>
        `;
    });
}

// Auto-actualizar estado cada 30 segundos
setInterval(checkWhatsAppStatus, 30000);
</script>
{% endblock %}
