{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{% if history %}Editar{% else %}Nueva{% endif %} Historia Clínica - {{ patient.full_name }}{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <!-- Header -->
    <div class="mb-6 pb-6 border-b">
        <div class="flex items-center gap-3 mb-2">
            <a href="{% url 'dashboard:clinical_history_list' patient.id %}" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-file-medical text-purple-600 mr-2"></i>
                {% if history %}Editar Historia Clínica{% else %}Nueva Historia Clínica{% endif %}
            </h1>
        </div>
        <p class="text-gray-600 ml-9">
            <strong>Paciente:</strong> {{ patient.full_name }}
            {% if patient.age %} | <strong>Edad:</strong> {{ patient.age }} años{% endif %}
        </p>
    </div>

    <!-- Formulario -->
    <form id="clinicalHistoryForm" method="POST">
        {% csrf_token %}
        
        <!-- Información General -->
        <div class="bg-gray-50 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                Información General del Examen
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha del Examen <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="date" required
                           value="{% if history %}{{ history.date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Médico/Optómetra <span class="text-red-500">*</span>
                    </label>
                    <select name="doctor" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Seleccione un doctor...</option>
                        {% for doctor in doctors %}
                        <option value="{{ doctor.id }}" 
                                {% if history and history.doctor and history.doctor.id == doctor.id %}selected{% endif %}>
                            {{ doctor.full_name }} - {{ doctor.get_specialty_display }}
                            {% if doctor.professional_card %} (T.P: {{ doctor.professional_card }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    {% if not doctors %}
                    <p class="text-sm text-amber-600 mt-2">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        No hay doctores registrados. <a href="{% url 'dashboard:doctor_create' %}" class="underline font-medium">Crear doctor</a>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ANAMNESIS -->
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-file-medical-alt text-blue-600 mr-2"></i>
                ANAMNESIS
            </h3>
            
            <div class="space-y-4">
                <!-- Motivo de Consulta -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 uppercase">
                        Motivo de Consulta
                    </label>
                    <textarea name="chief_complaint" rows="2" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Ej: Control visual, Paciente no usaría de corrección óptica que asiste a consulta para control visual">{% if history %}{{ history.chief_complaint }}{% endif %}</textarea>
                </div>

                <!-- Enfermedad Actual -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 uppercase">
                        Enfermedad Actual
                    </label>
                    <textarea name="current_illness" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Ej: Paciente no usaría de corrección óptica que asiste a consulta para control visual">{% if history %}{{ history.current_illness }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- ANTECEDENTES GENERALES -->
        <div class="bg-gradient-to-r from-amber-50 to-amber-100 border-l-4 border-amber-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-notes-medical text-amber-600 mr-2"></i>
                ANTECEDENTES GENERALES
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Patológicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-disease text-red-600 mr-1"></i> Patológicos
                    </label>
                    <textarea name="pathological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Diabetes, hipertensión, enfermedades crónicas... o escriba N/A">{% if history %}{{ history.pathological_history }}{% endif %}</textarea>
                </div>

                <!-- Farmacológicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-pills text-green-600 mr-1"></i> Farmacológicos
                    </label>
                    <textarea name="pharmacological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Medicamentos que toma actualmente... o escriba N/A">{% if history %}{{ history.pharmacological_history }}{% endif %}</textarea>
                </div>

                <!-- Quirúrgicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-procedures text-blue-600 mr-1"></i> Quirúrgicos
                    </label>
                    <textarea name="surgical_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Cirugías previas generales... o escriba N/A">{% if history %}{{ history.surgical_history }}{% endif %}</textarea>
                </div>

                <!-- Alérgicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-allergies text-orange-600 mr-1"></i> Alérgicos
                    </label>
                    <textarea name="allergic_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Alergias conocidas... o escriba N/A">{% if history %}{{ history.allergic_history }}{% endif %}</textarea>
                </div>

                <!-- Traumatológicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-band-aid text-purple-600 mr-1"></i> Traumatológicos
                    </label>
                    <textarea name="trauma_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Traumatismos previos... o escriba N/A">{% if history %}{{ history.trauma_history }}{% endif %}</textarea>
                </div>

                <!-- Otros -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-notes-medical text-gray-600 mr-1"></i> Otros
                    </label>
                    <textarea name="other_general_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Otros antecedentes generales... o escriba N/A">{% if history %}{{ history.other_general_history }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- ANTECEDENTES OCULARES -->
        <div class="bg-gradient-to-r from-teal-50 to-teal-100 border-l-4 border-teal-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-eye text-teal-600 mr-2"></i>
                ANTECEDENTES OCULARES
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Patológicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-eye-slash text-red-600 mr-1"></i> Patológicos Oculares
                    </label>
                    <textarea name="ocular_pathological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="Glaucoma, cataratas, enfermedades oculares previas... o escriba N/A">{% if history %}{{ history.ocular_pathological_history }}{% endif %}</textarea>
                </div>

                <!-- Farmacológicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-eye-dropper text-green-600 mr-1"></i> Farmacológicos Oculares
                    </label>
                    <textarea name="ocular_pharmacological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="Gotas, medicamentos oculares actuales... o escriba N/A">{% if history %}{{ history.ocular_pharmacological_history }}{% endif %}</textarea>
                </div>

                <!-- Quirúrgicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-scalpel text-blue-600 mr-1"></i> Quirúrgicos Oculares
                    </label>
                    <textarea name="ocular_surgical_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="LASIK, cirugía de cataratas, cirugías oculares previas... o escriba N/A">{% if history %}{{ history.ocular_surgical_history }}{% endif %}</textarea>
                </div>

                <!-- Traumatológicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-user-injured text-purple-600 mr-1"></i> Traumatológicos Oculares
                    </label>
                    <textarea name="ocular_trauma_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="Traumatismos oculares previos... o escriba N/A">{% if history %}{{ history.ocular_trauma_history }}{% endif %}</textarea>
                </div>

                <!-- Terapéuticos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-glasses text-indigo-600 mr-1"></i> Terapéuticos
                    </label>
                    <div class="space-y-2">
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" name="previous_glasses" {% if history.previous_glasses %}checked{% endif %}
                                       class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                <span class="text-sm text-gray-700 font-medium">Usa Lentes</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" name="previous_contact_lenses" {% if history.previous_contact_lenses %}checked{% endif %}
                                       class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                <span class="text-sm text-gray-700 font-medium">Lentes de Contacto</span>
                            </label>
                        </div>
                        <textarea name="ocular_therapeutic_history" rows="1"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                                  placeholder="Detalles de uso de lentes, terapias visuales... o escriba N/A">{% if history %}{{ history.ocular_therapeutic_history }}{% endif %}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANTECEDENTES FAMILIARES -->
        <div class="bg-gradient-to-r from-pink-50 to-pink-100 border-l-4 border-pink-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-users text-pink-600 mr-2"></i>
                ANTECEDENTES FAMILIARES
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Generales -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-heartbeat text-pink-600 mr-1"></i> Generales
                    </label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_diabetes" {% if history.family_diabetes %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Diabetes</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_hypertension" {% if history.family_hypertension %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Hipertensión</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_heart_disease" {% if history.family_heart_disease %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Cardiopatías</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_cancer" {% if history.family_cancer %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Cáncer</span>
                        </label>
                    </div>
                    <textarea name="family_general_notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Otros antecedentes familiares generales... o escriba N/A">{% if history %}{{ history.family_general_notes }}{% endif %}</textarea>
                </div>

                <!-- Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2">
                        <i class="fas fa-eye text-pink-600 mr-1"></i> Oculares
                    </label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_glaucoma" {% if history.family_glaucoma %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Glaucoma</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_cataracts" {% if history.family_cataracts %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Cataratas</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_macular_degeneration" {% if history.family_macular_degeneration %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Deg. Macular</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_retinal_detachment" {% if history.family_retinal_detachment %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Desp. Retina</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_myopia" {% if history.family_myopia %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Miopía</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_strabismus" {% if history.family_strabismus %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Estrabismo</span>
                        </label>
                    </div>
                    <textarea name="family_ocular_notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Otros antecedentes familiares oculares... o escriba N/A">{% if history %}{{ history.family_ocular_notes }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- OPTOMETRÍA -->
        <div class="bg-purple-50 border-l-4 border-purple-600 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-glasses text-purple-600 mr-2"></i>
                OPTOMETRÍA
            </h3>
            
            <!-- Agudeza Visual -->
            <div class="mb-5">
                <h4 class="font-semibold text-gray-700 mb-3 bg-white p-2 rounded">Agudeza Visual</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- OD -->
                    <div class="bg-white p-3 rounded">
                        <div class="flex items-center mb-2">
                            <span class="bg-blue-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OD</span>
                            <span class="font-semibold">Ojo Derecho</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">SC Lejos</label>
                                <input type="text" name="va_od_sc_distance"
                                       value="{% if history %}{{ history.va_od_sc_distance }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="20/20">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">CC Lejos</label>
                                <input type="text" name="va_od_cc_distance"
                                       value="{% if history %}{{ history.va_od_cc_distance }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="20/20">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">SC Cerca</label>
                                <input type="text" name="va_od_sc_near"
                                       value="{% if history %}{{ history.va_od_sc_near }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="J1">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">CC Cerca</label>
                                <input type="text" name="va_od_cc_near"
                                       value="{% if history %}{{ history.va_od_cc_near }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="J1">
                            </div>
                        </div>
                    </div>
                    <!-- OS -->
                    <div class="bg-white p-3 rounded">
                        <div class="flex items-center mb-2">
                            <span class="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OS</span>
                            <span class="font-semibold">Ojo Izquierdo</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">SC Lejos</label>
                                <input type="text" name="va_os_sc_distance"
                                       value="{% if history %}{{ history.va_os_sc_distance }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="20/20">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">CC Lejos</label>
                                <input type="text" name="va_os_cc_distance"
                                       value="{% if history %}{{ history.va_os_cc_distance }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="20/20">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">SC Cerca</label>
                                <input type="text" name="va_os_sc_near"
                                       value="{% if history %}{{ history.va_os_sc_near }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="J1">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">CC Cerca</label>
                                <input type="text" name="va_os_cc_near"
                                       value="{% if history %}{{ history.va_os_cc_near }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="J1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Refracción -->
            <div class="mb-4">
                <h4 class="font-semibold text-gray-700 mb-3 bg-white p-2 rounded">Refracción</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- OD -->
                    <div class="bg-white p-3 rounded">
                        <div class="flex items-center mb-2">
                            <span class="bg-blue-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OD</span>
                            <span class="font-semibold">Ojo Derecho</span>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Esf</label>
                                <input type="number" step="0.25" name="refraction_od_sphere"
                                       value="{% if history %}{{ history.refraction_od_sphere }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="±0.00">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Cil</label>
                                <input type="number" step="0.25" name="refraction_od_cylinder"
                                       value="{% if history %}{{ history.refraction_od_cylinder }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="±0.00">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Eje</label>
                                <input type="number" min="0" max="180" name="refraction_od_axis"
                                       value="{% if history %}{{ history.refraction_od_axis }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="0°">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Add</label>
                                <input type="number" step="0.25" name="refraction_od_add"
                                       value="{% if history %}{{ history.refraction_od_add }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="+0.00">
                            </div>
                        </div>
                    </div>
                    <!-- OS -->
                    <div class="bg-white p-3 rounded">
                        <div class="flex items-center mb-2">
                            <span class="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OS</span>
                            <span class="font-semibold">Ojo Izquierdo</span>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Esf</label>
                                <input type="number" step="0.25" name="refraction_os_sphere"
                                       value="{% if history %}{{ history.refraction_os_sphere }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="±0.00">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Cil</label>
                                <input type="number" step="0.25" name="refraction_os_cylinder"
                                       value="{% if history %}{{ history.refraction_os_cylinder }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="±0.00">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Eje</label>
                                <input type="number" min="0" max="180" name="refraction_os_axis"
                                       value="{% if history %}{{ history.refraction_os_axis }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="0°">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Add</label>
                                <input type="number" step="0.25" name="refraction_os_add"
                                       value="{% if history %}{{ history.refraction_os_add }}{% endif %}"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                       placeholder="+0.00">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distancia Pupilar -->
            <div class="bg-white p-3 rounded">
                <h4 class="font-semibold text-gray-700 mb-2">Distancia Pupilar (mm)</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">DP Lejos</label>
                        <input type="number" step="0.5" name="pd_distance"
                               value="{% if history %}{{ history.pd_distance }}{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                               placeholder="63.0">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">DP Cerca</label>
                        <input type="number" step="0.5" name="pd_near"
                               value="{% if history %}{{ history.pd_near }}{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                               placeholder="59.0">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">DP OD</label>
                        <input type="number" step="0.5" name="pd_od"
                               value="{% if history %}{{ history.pd_od }}{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                               placeholder="31.5">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">DP OS</label>
                        <input type="number" step="0.5" name="pd_os"
                               value="{% if history %}{{ history.pd_os }}{% endif %}"
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                               placeholder="31.5">
                    </div>
                </div>
            </div>

            <!-- Gráfico Visual de Refracción -->
            <div class="bg-white p-3 rounded mt-3">
                <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-chart-bar text-purple-600 mr-2"></i>
                    Representación Visual
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Gráfico OD -->
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-700 mb-2">
                            <span class="bg-blue-500 text-white w-6 h-6 rounded-full inline-flex items-center justify-center text-xs mr-1">OD</span>
                            Ojo Derecho
                        </p>
                        <div class="relative w-32 h-32 mx-auto border-4 border-blue-500 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-blue-100">
                            <div id="od-visual" class="text-center">
                                <p class="text-xs text-gray-500">Vista Esquemática</p>
                                <p class="text-2xl font-bold text-blue-600 mt-1" id="od-sphere-display">--</p>
                                <p class="text-xs text-gray-600" id="od-cyl-display">--</p>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-600">
                            <p><strong>AV:</strong> <span id="od-av-display">--</span></p>
                        </div>
                    </div>
                    
                    <!-- Gráfico OS -->
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-700 mb-2">
                            <span class="bg-green-500 text-white w-6 h-6 rounded-full inline-flex items-center justify-center text-xs mr-1">OS</span>
                            Ojo Izquierdo
                        </p>
                        <div class="relative w-32 h-32 mx-auto border-4 border-green-500 rounded-full flex items-center justify-center bg-gradient-to-br from-green-50 to-green-100">
                            <div id="os-visual" class="text-center">
                                <p class="text-xs text-gray-500">Vista Esquemática</p>
                                <p class="text-2xl font-bold text-green-600 mt-1" id="os-sphere-display">--</p>
                                <p class="text-xs text-gray-600" id="os-cyl-display">--</p>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-600">
                            <p><strong>AV:</strong> <span id="os-av-display">--</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Interpretación -->
                <div class="mt-3 p-2 bg-purple-50 rounded text-xs text-center">
                    <p class="font-medium text-purple-800">
                        <i class="fas fa-info-circle mr-1"></i>
                        <span id="refraction-interpretation">Ingrese valores de refracción para ver la interpretación</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- SEGMENTO ANTERIOR -->
        <div class="bg-green-50 border-l-4 border-green-600 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-eye text-green-600 mr-2"></i>
                SEGMENTO ANTERIOR
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- OD -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-blue-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OD</span>
                        <span class="font-semibold">Ojo Derecho</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Párpados</label>
                            <input type="text" name="biomicroscopy_od_lids"
                                   value="{% if history %}{{ history.biomicroscopy_od_lids }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Conjuntiva</label>
                            <input type="text" name="biomicroscopy_od_conjunctiva"
                                   value="{% if history %}{{ history.biomicroscopy_od_conjunctiva }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Córnea</label>
                            <input type="text" name="biomicroscopy_od_cornea"
                                   value="{% if history %}{{ history.biomicroscopy_od_cornea }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cámara Anterior</label>
                            <input type="text" name="biomicroscopy_od_anterior_chamber"
                                   value="{% if history %}{{ history.biomicroscopy_od_anterior_chamber }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Formada, profunda">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Iris</label>
                            <input type="text" name="biomicroscopy_od_iris"
                                   value="{% if history %}{{ history.biomicroscopy_od_iris }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cristalino</label>
                            <input type="text" name="biomicroscopy_od_lens"
                                   value="{% if history %}{{ history.biomicroscopy_od_lens }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Pupila</label>
                            <input type="text" name="biomicroscopy_od_pupil"
                                   value="{% if history %}{{ history.biomicroscopy_od_pupil }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Redonda, reactiva">
                        </div>
                    </div>
                </div>
                
                <!-- OS -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OS</span>
                        <span class="font-semibold">Ojo Izquierdo</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Párpados</label>
                            <input type="text" name="biomicroscopy_os_lids"
                                   value="{% if history %}{{ history.biomicroscopy_os_lids }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Conjuntiva</label>
                            <input type="text" name="biomicroscopy_os_conjunctiva"
                                   value="{% if history %}{{ history.biomicroscopy_os_conjunctiva }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Córnea</label>
                            <input type="text" name="biomicroscopy_os_cornea"
                                   value="{% if history %}{{ history.biomicroscopy_os_cornea }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cámara Anterior</label>
                            <input type="text" name="biomicroscopy_os_anterior_chamber"
                                   value="{% if history %}{{ history.biomicroscopy_os_anterior_chamber }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Formada, profunda">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Iris</label>
                            <input type="text" name="biomicroscopy_os_iris"
                                   value="{% if history %}{{ history.biomicroscopy_os_iris }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cristalino</label>
                            <input type="text" name="biomicroscopy_os_lens"
                                   value="{% if history %}{{ history.biomicroscopy_os_lens }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Pupila</label>
                            <input type="text" name="biomicroscopy_os_pupil"
                                   value="{% if history %}{{ history.biomicroscopy_os_pupil }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Redonda, reactiva">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEGMENTO POSTERIOR -->
        <div class="bg-indigo-50 border-l-4 border-indigo-600 rounded-lg p-5 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-circle text-indigo-600 mr-2"></i>
                    SEGMENTO POSTERIOR (FONDO DE OJO)
                </h3>
                <button type="button" onclick="loadPreviousFundoscopy()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded">
                    <i class="fas fa-history mr-1"></i>Cargar último registro
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- OD -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-blue-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OD</span>
                        <span class="font-semibold">Ojo Derecho</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vítreo</label>
                            <input type="text" name="fundoscopy_od_vitreous"
                                   value="{% if history %}{{ history.fundoscopy_od_vitreous }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Disco Óptico</label>
                            <input type="text" name="fundoscopy_od_optic_disc"
                                   value="{% if history %}{{ history.fundoscopy_od_optic_disc }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Rosado, bien definido">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Relación Copa/Disco</label>
                            <input type="text" name="fundoscopy_od_cup_disc_ratio"
                                   value="{% if history %}{{ history.fundoscopy_od_cup_disc_ratio }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="0.3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Mácula</label>
                            <input type="text" name="fundoscopy_od_macula"
                                   value="{% if history %}{{ history.fundoscopy_od_macula }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Reflejo foveolar presente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vasos</label>
                            <input type="text" name="fundoscopy_od_vessels"
                                   value="{% if history %}{{ history.fundoscopy_od_vessels }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Normales, AV 2:3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Retina/Periferia</label>
                            <input type="text" name="fundoscopy_od_retina"
                                   value="{% if history %}{{ history.fundoscopy_od_retina }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Aplicada, sin lesiones">
                        </div>
                    </div>
                </div>
                
                <!-- OS -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OS</span>
                        <span class="font-semibold">Ojo Izquierdo</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vítreo</label>
                            <input type="text" name="fundoscopy_os_vitreous"
                                   value="{% if history %}{{ history.fundoscopy_os_vitreous }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Disco Óptico</label>
                            <input type="text" name="fundoscopy_os_optic_disc"
                                   value="{% if history %}{{ history.fundoscopy_os_optic_disc }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Rosado, bien definido">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Relación Copa/Disco</label>
                            <input type="text" name="fundoscopy_os_cup_disc_ratio"
                                   value="{% if history %}{{ history.fundoscopy_os_cup_disc_ratio }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="0.3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Mácula</label>
                            <input type="text" name="fundoscopy_os_macula"
                                   value="{% if history %}{{ history.fundoscopy_os_macula }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Reflejo foveolar presente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vasos</label>
                            <input type="text" name="fundoscopy_os_vessels"
                                   value="{% if history %}{{ history.fundoscopy_os_vessels }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Normales, AV 2:3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Retina/Periferia</label>
                            <input type="text" name="fundoscopy_os_retina"
                                   value="{% if history %}{{ history.fundoscopy_os_retina }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Aplicada, sin lesiones">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DIAGNÓSTICO -->
        <div class="bg-red-50 border-l-4 border-red-600 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-stethoscope text-red-600 mr-2"></i>
                DIAGNÓSTICO
            </h3>
            
            <div class="space-y-4">
                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Diagnósticos Comunes
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_myopia" {% if history.dx_myopia %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Miopía</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_hyperopia" {% if history.dx_hyperopia %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Hipermetropía</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_astigmatism" {% if history.dx_astigmatism %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Astigmatismo</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_presbyopia" {% if history.dx_presbyopia %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Presbicia</span>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Diagnóstico Detallado
                    </label>
                    <textarea name="diagnosis" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                              placeholder="Descripción completa del diagnóstico...">{% if history %}{{ history.diagnosis }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- OBSERVACIONES / CONDUCTA -->
        <div class="bg-pink-50 border-l-4 border-pink-600 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-clipboard-list text-pink-600 mr-2"></i>
                OBSERVACIONES / CONDUCTA
            </h3>
            
            <div class="space-y-4">
                <!-- Prescripción -->
                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-glasses mr-1"></i> Prescripción
                    </label>
                    <div class="flex flex-wrap gap-4 mb-3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="prescription_glasses" {% if history.prescription_glasses %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Lentes</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="prescription_contact_lenses" {% if history.prescription_contact_lenses %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Lentes de Contacto</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="prescription_medication" {% if history.prescription_medication %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Medicación</span>
                        </label>
                    </div>

                    <!-- Tipo de lentes y Material -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Tipo de Lentes</label>
                            <select name="lens_type"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                <option value="single" {% if history.lens_type == 'single' %}selected{% endif %}>Monofocales</option>
                                <option value="bifocal" {% if history.lens_type == 'bifocal' %}selected{% endif %}>Bifocales</option>
                                <option value="progressive" {% if history.lens_type == 'progressive' %}selected{% endif %}>Progresivos</option>
                                <option value="occupational" {% if history.lens_type == 'occupational' %}selected{% endif %}>Ocupacionales</option>
                                <option value="reading" {% if history.lens_type == 'reading' %}selected{% endif %}>Lectura</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                Material
                                <button type="button" onclick="openMaterialModal()" class="text-pink-600 hover:text-pink-700 ml-1" title="Agregar nuevo material">
                                    <i class="fas fa-plus-circle text-xs"></i>
                                </button>
                            </label>
                            <select name="lens_material" id="lens_material"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                                    onchange="showMaterialDetails(this)">
                                <option value="">Seleccionar...</option>
                                {% for material in lens_materials %}
                                <option value="{{ material.name }}" 
                                        data-description="{{ material.description }}"
                                        data-category="{{ material.category }}"
                                        {% if history and history.lens_material == material.name %}selected{% endif %}>
                                    {{ material.name }}
                                </option>
                                {% endfor %}
                                {% if not lens_materials %}
                                <option value="" disabled>No hay materiales configurados</option>
                                {% endif %}
                            </select>
                            <div id="material-details" class="mt-1 text-xs text-gray-600 hidden"></div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                Tratamientos
                                <button type="button" onclick="openTreatmentModal()" class="text-pink-600 hover:text-pink-700 ml-1" title="Agregar nuevo tratamiento">
                                    <i class="fas fa-plus-circle text-xs"></i>
                                </button>
                            </label>
                            <div id="selected-treatments" class="mb-2 flex flex-wrap gap-1"></div>
                            <select name="lens_coating" id="lens_coating" multiple
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                                    style="height: 80px;"
                                    onchange="updateSelectedTreatments()">
                                {% for coating in lens_coatings %}
                                <option value="{{ coating.name }}" 
                                        data-description="{{ coating.description }}"
                                        data-category="{{ coating.category }}"
                                        {% if history and coating.name in history.lens_coating %}selected{% endif %}>
                                    {{ coating.name }}
                                </option>
                                {% endfor %}
                                {% if not lens_coatings %}
                                <option value="" disabled>No hay tratamientos configurados</option>
                                {% endif %}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle"></i> Mantén Ctrl/Cmd para seleccionar múltiples
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Medicamentos -->
                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-pills mr-1"></i> Medicamentos
                        <button type="button" onclick="openMedicationModal()" class="text-pink-600 hover:text-pink-700 ml-1 text-xs" title="Agregar nuevo medicamento">
                            <i class="fas fa-plus-circle"></i> Agregar nuevo
                        </button>
                    </label>
                    <div id="selected-medications" class="mb-2 space-y-2"></div>
                    <select name="medication_details" id="medication_details" multiple
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                            style="height: 100px;"
                            onchange="updateSelectedMedications()">
                        {% for medication in medications %}
                        <option value="{{ medication.name }}" 
                                data-dosage="{{ medication.dosage }}"
                                data-frequency="{{ medication.frequency }}"
                                data-duration="{{ medication.duration }}"
                                data-route="{{ medication.get_administration_route_display }}"
                                {% if history and medication.name in history.medication_details %}selected{% endif %}>
                            {{ medication.name }}
                        </option>
                        {% endfor %}
                        {% if not medications %}
                        <option value="" disabled>No hay medicamentos configurados</option>
                        {% endif %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle"></i> Mantén Ctrl/Cmd para seleccionar múltiples medicamentos
                    </p>
                </div>

                <!-- Observaciones -->
                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-comment-dots mr-1"></i> Observaciones / Plan de Tratamiento
                    </label>
                    <textarea name="treatment_plan" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                              placeholder="Indicaciones, recomendaciones, plan de seguimiento, próxima cita...">{% if history %}{{ history.treatment_plan }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex gap-3 pt-4 border-t">
            <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors font-medium">
                <i class="fas fa-save mr-2"></i>
                {% if history %}Actualizar Historia Clínica{% else %}Guardar Historia Clínica{% endif %}
            </button>
            <a href="{% url 'dashboard:clinical_history_list' patient.id %}" 
               class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors font-medium">
                <i class="fas fa-times mr-2"></i>Cancelar
            </a>
        </div>

        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Nota:</strong> Puedes guardar estos datos principales ahora y actualizar información adicional (agudeza visual, tonometría, biomicroscopía, etc.) editando la historia clínica después.
            </p>
        </div>
    </form>
</div>

<script>
document.getElementById('clinicalHistoryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    
    this.submit();
});

// Actualizar gráficos visuales en tiempo real
function updateRefractionDisplay() {
    // OD (Ojo Derecho)
    const odSphere = parseFloat(document.querySelector('input[name="refraction_od_sphere"]').value) || 0;
    const odCyl = parseFloat(document.querySelector('input[name="refraction_od_cylinder"]').value) || 0;
    const odAxis = parseFloat(document.querySelector('input[name="refraction_od_axis"]').value) || 0;
    const odAV = document.querySelector('input[name="va_od_cc_distance"]').value || '--';
    
    // OS (Ojo Izquierdo)
    const osSphere = parseFloat(document.querySelector('input[name="refraction_os_sphere"]').value) || 0;
    const osCyl = parseFloat(document.querySelector('input[name="refraction_os_cylinder"]').value) || 0;
    const osAxis = parseFloat(document.querySelector('input[name="refraction_os_axis"]').value) || 0;
    const osAV = document.querySelector('input[name="va_os_cc_distance"]').value || '--';
    
    // Actualizar displays OD
    document.getElementById('od-sphere-display').textContent = odSphere !== 0 ? (odSphere > 0 ? '+' : '') + odSphere.toFixed(2) : '--';
    document.getElementById('od-cyl-display').textContent = odCyl !== 0 ? 'Cil: ' + (odCyl > 0 ? '+' : '') + odCyl.toFixed(2) + ' x ' + odAxis + '°' : '--';
    document.getElementById('od-av-display').textContent = odAV;
    
    // Actualizar displays OS
    document.getElementById('os-sphere-display').textContent = osSphere !== 0 ? (osSphere > 0 ? '+' : '') + osSphere.toFixed(2) : '--';
    document.getElementById('os-cyl-display').textContent = osCyl !== 0 ? 'Cil: ' + (osCyl > 0 ? '+' : '') + osCyl.toFixed(2) + ' x ' + osAxis + '°' : '--';
    document.getElementById('os-av-display').textContent = osAV;
    
    // Interpretación
    let interpretation = '';
    const avgSphere = (odSphere + osSphere) / 2;
    const avgCyl = (Math.abs(odCyl) + Math.abs(osCyl)) / 2;
    
    if (avgSphere < -0.5) {
        interpretation += 'Miopía';
    } else if (avgSphere > 0.5) {
        interpretation += 'Hipermetropía';
    } else {
        interpretation += 'Emetropía';
    }
    
    if (avgCyl >= 0.5) {
        interpretation += ' con Astigmatismo';
        if (avgCyl >= 2.0) interpretation += ' Alto';
        else if (avgCyl >= 1.0) interpretation += ' Moderado';
        else interpretation += ' Bajo';
    }
    
    // Verificar presbicia (si hay adición)
    const odAdd = parseFloat(document.querySelector('input[name="refraction_od_add"]').value) || 0;
    const osAdd = parseFloat(document.querySelector('input[name="refraction_os_add"]').value) || 0;
    if (odAdd > 0 || osAdd > 0) {
        interpretation += ' + Presbicia';
    }
    
    if (interpretation === '') {
        interpretation = 'Ingrese valores de refracción para ver la interpretación';
    }
    
    document.getElementById('refraction-interpretation').innerHTML = '<i class="fas fa-info-circle mr-1"></i>' + interpretation;
}

// Agregar event listeners a los campos de refracción
const refractionInputs = [
    'refraction_od_sphere', 'refraction_od_cylinder', 'refraction_od_axis', 'refraction_od_add',
    'refraction_os_sphere', 'refraction_os_cylinder', 'refraction_os_axis', 'refraction_os_add',
    'va_od_cc_distance', 'va_os_cc_distance'
];

refractionInputs.forEach(function(inputName) {
    const input = document.querySelector('input[name="' + inputName + '"]');
    if (input) {
        input.addEventListener('input', updateRefractionDisplay);
        input.addEventListener('change', updateRefractionDisplay);
    }
});

// Actualizar al cargar la página si hay valores
document.addEventListener('DOMContentLoaded', function() {
    updateRefractionDisplay();
    updateSelectedTreatments();
    updateSelectedMedications();
});

// Mostrar detalles del material seleccionado
function showMaterialDetails(select) {
    const option = select.options[select.selectedIndex];
    const detailsDiv = document.getElementById('material-details');
    
    if (option.value) {
        const description = option.getAttribute('data-description');
        const category = option.getAttribute('data-category');
        let details = '';
        
        if (description && description !== 'None') {
            details += description;
        }
        if (category && category !== 'None') {
            details += (details ? ' | ' : '') + 'Categoría: ' + category;
        }
        
        if (details) {
            detailsDiv.textContent = details;
            detailsDiv.classList.remove('hidden');
        } else {
            detailsDiv.classList.add('hidden');
        }
    } else {
        detailsDiv.classList.add('hidden');
    }
}

// Actualizar tratamientos seleccionados
function updateSelectedTreatments() {
    const select = document.getElementById('lens_coating');
    const container = document.getElementById('selected-treatments');
    container.innerHTML = '';
    
    const selectedOptions = Array.from(select.selectedOptions);
    selectedOptions.forEach(option => {
        const badge = document.createElement('span');
        badge.className = 'inline-flex items-center px-2 py-1 bg-pink-100 text-pink-800 text-xs rounded-full';
        badge.innerHTML = `
            ${option.text}
            <button type="button" onclick="removeTreatment('${option.value}')" class="ml-1 text-pink-600 hover:text-pink-800">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(badge);
    });
}

function removeTreatment(value) {
    const select = document.getElementById('lens_coating');
    const option = Array.from(select.options).find(opt => opt.value === value);
    if (option) {
        option.selected = false;
        updateSelectedTreatments();
    }
}

// Actualizar medicamentos seleccionados con detalles
function updateSelectedMedications() {
    const select = document.getElementById('medication_details');
    const container = document.getElementById('selected-medications');
    container.innerHTML = '';
    
    const selectedOptions = Array.from(select.selectedOptions);
    selectedOptions.forEach(option => {
        const dosage = option.getAttribute('data-dosage');
        const frequency = option.getAttribute('data-frequency');
        const duration = option.getAttribute('data-duration');
        const route = option.getAttribute('data-route');
        
        const card = document.createElement('div');
        card.className = 'bg-pink-50 border border-pink-200 rounded p-2 text-xs';
        
        let details = '<div class="flex justify-between items-start">';
        details += `<div class="flex-1">`;
        details += `<p class="font-semibold text-pink-900">${option.text}</p>`;
        if (dosage && dosage !== 'None') details += `<p class="text-gray-600"><i class="fas fa-pills mr-1"></i>${dosage}</p>`;
        if (frequency && frequency !== 'None') details += `<p class="text-gray-600"><i class="fas fa-clock mr-1"></i>${frequency}</p>`;
        if (duration && duration !== 'None') details += `<p class="text-gray-600"><i class="fas fa-calendar mr-1"></i>${duration}</p>`;
        if (route && route !== 'None') details += `<p class="text-gray-600"><i class="fas fa-syringe mr-1"></i>${route}</p>`;
        details += '</div>';
        details += `<button type="button" onclick="removeMedication('${option.value}')" class="text-pink-600 hover:text-pink-800 ml-2">
            <i class="fas fa-times"></i>
        </button>`;
        details += '</div>';
        
        card.innerHTML = details;
        container.appendChild(card);
    });
}

function removeMedication(value) {
    const select = document.getElementById('medication_details');
    const option = Array.from(select.options).find(opt => opt.value === value);
    if (option) {
        option.selected = false;
        updateSelectedMedications();
    }
}

// Cargar datos previos del fondo de ojo
function loadPreviousFundoscopy() {
    if (!confirm('¿Desea cargar los datos del último examen de fondo de ojo?')) {
        return;
    }
    
    fetch(`/dashboard/patients/{{ patient.id }}/clinical-history/latest-fundoscopy/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.fundoscopy) {
                // OD
                if (data.fundoscopy.od_vitreous) document.querySelector('input[name="fundoscopy_od_vitreous"]').value = data.fundoscopy.od_vitreous;
                if (data.fundoscopy.od_optic_disc) document.querySelector('input[name="fundoscopy_od_optic_disc"]').value = data.fundoscopy.od_optic_disc;
                if (data.fundoscopy.od_cup_disc_ratio) document.querySelector('input[name="fundoscopy_od_cup_disc_ratio"]').value = data.fundoscopy.od_cup_disc_ratio;
                if (data.fundoscopy.od_macula) document.querySelector('input[name="fundoscopy_od_macula"]').value = data.fundoscopy.od_macula;
                if (data.fundoscopy.od_vessels) document.querySelector('input[name="fundoscopy_od_vessels"]').value = data.fundoscopy.od_vessels;
                if (data.fundoscopy.od_retina) document.querySelector('input[name="fundoscopy_od_retina"]').value = data.fundoscopy.od_retina;
                
                // OS
                if (data.fundoscopy.os_vitreous) document.querySelector('input[name="fundoscopy_os_vitreous"]').value = data.fundoscopy.os_vitreous;
                if (data.fundoscopy.os_optic_disc) document.querySelector('input[name="fundoscopy_os_optic_disc"]').value = data.fundoscopy.os_optic_disc;
                if (data.fundoscopy.os_cup_disc_ratio) document.querySelector('input[name="fundoscopy_os_cup_disc_ratio"]').value = data.fundoscopy.os_cup_disc_ratio;
                if (data.fundoscopy.os_macula) document.querySelector('input[name="fundoscopy_os_macula"]').value = data.fundoscopy.os_macula;
                if (data.fundoscopy.os_vessels) document.querySelector('input[name="fundoscopy_os_vessels"]').value = data.fundoscopy.os_vessels;
                if (data.fundoscopy.os_retina) document.querySelector('input[name="fundoscopy_os_retina"]').value = data.fundoscopy.os_retina;
                
                alert('Datos del fondo de ojo cargados exitosamente');
            } else {
                alert(data.message || 'No hay registros previos de fondo de ojo');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los datos previos');
        });
}

// MODALES
function openMaterialModal() {
    document.getElementById('materialModal').classList.remove('hidden');
}

function closeMaterialModal() {
    document.getElementById('materialModal').classList.add('hidden');
    document.getElementById('materialForm').reset();
}

function openTreatmentModal() {
    document.getElementById('treatmentModal').classList.remove('hidden');
}

function closeTreatmentModal() {
    document.getElementById('treatmentModal').classList.add('hidden');
    document.getElementById('treatmentForm').reset();
}

function openMedicationModal() {
    document.getElementById('medicationModal').classList.remove('hidden');
}

function closeMedicationModal() {
    document.getElementById('medicationModal').classList.add('hidden');
    document.getElementById('medicationForm').reset();
}

// Guardar nuevo material
function saveMaterial() {
    const form = document.getElementById('materialForm');
    const formData = new FormData(form);
    
    const submitBtn = document.getElementById('saveMaterialBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    
    fetch('{% url "dashboard:clinical_parameter_create" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar al select
            const select = document.getElementById('lens_material');
            const option = document.createElement('option');
            option.value = data.parameter.name;
            option.text = data.parameter.name;
            option.selected = true;
            select.appendChild(option);
            
            closeMaterialModal();
            showMaterialDetails(select);
            alert('Material agregado exitosamente');
        } else {
            alert('Error: ' + (data.message || 'No se pudo guardar'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el material');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar';
    });
}

// Guardar nuevo tratamiento
function saveTreatment() {
    const form = document.getElementById('treatmentForm');
    const formData = new FormData(form);
    
    const submitBtn = document.getElementById('saveTreatmentBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    
    fetch('{% url "dashboard:clinical_parameter_create" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar al select
            const select = document.getElementById('lens_coating');
            const option = document.createElement('option');
            option.value = data.parameter.name;
            option.text = data.parameter.name;
            option.selected = true;
            select.appendChild(option);
            
            closeTreatmentModal();
            updateSelectedTreatments();
            alert('Tratamiento agregado exitosamente');
        } else {
            alert('Error: ' + (data.message || 'No se pudo guardar'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el tratamiento');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar';
    });
}

// Guardar nuevo medicamento
function saveMedication() {
    const form = document.getElementById('medicationForm');
    const formData = new FormData(form);
    
    const submitBtn = document.getElementById('saveMedicationBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    
    fetch('{% url "dashboard:clinical_parameter_create" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar al select
            const select = document.getElementById('medication_details');
            const option = document.createElement('option');
            option.value = data.parameter.name;
            option.text = data.parameter.name;
            option.setAttribute('data-dosage', data.parameter.dosage || '');
            option.setAttribute('data-frequency', data.parameter.frequency || '');
            option.setAttribute('data-duration', data.parameter.duration || '');
            option.setAttribute('data-route', data.parameter.administration_route || '');
            option.selected = true;
            select.appendChild(option);
            
            closeMedicationModal();
            updateSelectedMedications();
            alert('Medicamento agregado exitosamente');
        } else {
            alert('Error: ' + (data.message || 'No se pudo guardar'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el medicamento');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar';
    });
}

// Cerrar modales con ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMaterialModal();
        closeTreatmentModal();
        closeMedicationModal();
    }
});
</script>

<!-- Modal Material -->
<div id="materialModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-plus-circle text-pink-600 mr-2"></i>Agregar Material
            </h3>
            <button onclick="closeMaterialModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="materialForm" onsubmit="event.preventDefault(); saveMaterial();">
            <input type="hidden" name="parameter_type" value="lens_material">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Policarbonato">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Características del material"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <input type="text" name="category"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Alto índice">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="submit" id="saveMaterialBtn"
                        class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <button type="button" onclick="closeMaterialModal()"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Tratamiento -->
<div id="treatmentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-plus-circle text-pink-600 mr-2"></i>Agregar Tratamiento
            </h3>
            <button onclick="closeTreatmentModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="treatmentForm" onsubmit="event.preventDefault(); saveTreatment();">
            <input type="hidden" name="parameter_type" value="lens_coating">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Antireflejo">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Beneficios del tratamiento"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <input type="text" name="category"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Protección">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="submit" id="saveTreatmentBtn"
                        class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <button type="button" onclick="closeTreatmentModal()"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Medicamento -->
<div id="medicationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-plus-circle text-pink-600 mr-2"></i>Agregar Medicamento
            </h3>
            <button onclick="closeMedicationModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="medicationForm" onsubmit="event.preventDefault(); saveMedication();">
            <input type="hidden" name="parameter_type" value="medication">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Medicamento *</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Dorzolamida 2%">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dosis</label>
                        <input type="text" name="dosage"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                               placeholder="1 gota">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                        <input type="text" name="frequency"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                               placeholder="Cada 8 horas">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Duración</label>
                        <input type="text" name="duration"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                               placeholder="7 días">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vía</label>
                        <select name="administration_route"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                            <option value="">Seleccionar...</option>
                            <option value="topical">Tópico</option>
                            <option value="oral">Oral</option>
                            <option value="parenteral">Parenteral</option>
                            <option value="sublingual">Sublingual</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción / Indicaciones</label>
                    <textarea name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Indicaciones especiales"></textarea>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="submit" id="saveMedicationBtn"
                        class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <button type="button" onclick="closeMedicationModal()"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
