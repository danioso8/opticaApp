{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ title }} - {{ patient.full_name }}{% endblock %}

{% block content %}
<!-- Header Principal -->
<div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg shadow-lg p-6 mb-6 text-white">
    <div class="flex justify-between items-center">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-file-medical text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Nueva Orden de Examen</h1>
                    <p class="text-purple-100 text-sm">{{ patient.full_name }}</p>
                </div>
            </div>
        </div>
        <a href="{% url 'dashboard:clinical_history_detail' patient.id history.id %}" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 backdrop-blur-sm text-white rounded-lg transition-all flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            <span class="hidden md:inline">Volver</span>
        </a>
    </div>
</div>

<!-- Información del Paciente -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-5 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-user text-blue-600"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500">Paciente</p>
                <p class="font-semibold text-gray-800">{{ patient.full_name }}</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-id-card text-green-600"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500">Identificación</p>
                <p class="font-semibold text-gray-800">{{ patient.identification|default:"N/A" }}</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-notes-medical text-purple-600"></i>
            </div>
            <div>
                <p class="text-xs text-gray-500">Historia Clínica</p>
                <p class="font-semibold text-gray-800">#{{ history.id }} - {{ history.date|date:"d/m/Y" }}</p>
            </div>
        </div>
    </div>
</div>


<!-- Formulario -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-6 flex items-center">
        <i class="fas fa-edit mr-2 text-purple-600"></i>
        Datos de la Orden
    </h2>

    <form method="post" id="orderForm">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
            <div class="flex">
                <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                <div class="text-sm text-red-700">
                    {{ form.non_field_errors }}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Tipo de Examen -->
            <div class="lg:col-span-2">
                <label for="{{ form.exam_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-flask text-purple-600 mr-1"></i>
                    {{ form.exam_type.label }} <span class="text-red-500">*</span>
                </label>
                {{ form.exam_type }}
                {% if form.exam_type.errors %}
                <p class="mt-1 text-sm text-red-600">
                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form.exam_type.errors.0 }}
                </p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Seleccione el tipo de examen a realizar</p>
            </div>

            <!-- Prioridad -->
            <div>
                <label for="{{ form.priority.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-exclamation-triangle text-orange-600 mr-1"></i>
                    {{ form.priority.label }}
                </label>
                {{ form.priority }}
                {% if form.priority.errors %}
                <p class="mt-1 text-sm text-red-600">
                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form.priority.errors.0 }}
                </p>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <!-- Fecha de Orden -->
            <div>
                <label for="{{ form.order_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-calendar text-blue-600 mr-1"></i>
                    {{ form.order_date.label }} <span class="text-red-500">*</span>
                </label>
                {{ form.order_date }}
                {% if form.order_date.errors %}
                <p class="mt-1 text-sm text-red-600">
                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form.order_date.errors.0 }}
                </p>
                {% endif %}
            </div>

            <!-- Ordenado por -->
            <div>
                <label for="{{ form.ordered_by.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user-md text-green-600 mr-1"></i>
                    {{ form.ordered_by.label }}
                </label>
                {{ form.ordered_by }}
                {% if form.ordered_by.errors %}
                <p class="mt-1 text-sm text-red-600">
                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form.ordered_by.errors.0 }}
                </p>
                {% endif %}
            </div>
        </div>

        <div class="mt-6">
            <!-- Indicación Clínica -->
            <div>
                <label for="{{ form.clinical_indication.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-notes-medical text-indigo-600 mr-1"></i>
                    {{ form.clinical_indication.label }} <span class="text-red-500">*</span>
                </label>
                {{ form.clinical_indication }}
                {% if form.clinical_indication.errors %}
                <p class="mt-1 text-sm text-red-600">
                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form.clinical_indication.errors.0 }}
                </p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Motivo por el cual se solicita el examen</p>
            </div>
        </div>

        <div class="mt-6">
            <!-- Instrucciones Especiales -->
            <div>
                <label for="{{ form.special_instructions.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-clipboard-list text-teal-600 mr-1"></i>
                    {{ form.special_instructions.label }}
                </label>
                {{ form.special_instructions }}
                {% if form.special_instructions.errors %}
                <p class="mt-1 text-sm text-red-600">
                    <i class="fas fa-exclamation-circle mr-1"></i>{{ form.special_instructions.errors.0 }}
                </p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-500">Instrucciones especiales para el técnico o paciente (opcional)</p>
            </div>
        </div>

        <!-- Botones -->
        <div class="flex flex-wrap gap-3 mt-8 pt-6 border-t border-gray-200">
            <button type="submit" name="save_and_print" class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-lg transition-all flex items-center gap-2 font-medium shadow-lg">
                <i class="fas fa-print"></i>
                Guardar e Imprimir
            </button>
            <button type="submit" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center gap-2 font-medium">
                <i class="fas fa-save"></i>
                Guardar
            </button>
            <a href="{% url 'dashboard:clinical_history_detail' patient.id history.id %}" class="px-6 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors flex items-center gap-2 font-medium">
                <i class="fas fa-times"></i>
                Cancelar
            </a>
        </div>
    </form>
</div>

<style>
    select, input[type="date"], textarea {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: all 0.2s;
    }
    
    select:focus, input[type="date"]:focus, textarea:focus {
        outline: none;
        border-color: #9333ea;
        box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }
    
    textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .form-select, .form-control {
        width: 100%;
        padding: 0.625rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}
