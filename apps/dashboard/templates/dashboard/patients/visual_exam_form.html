{% extends 'dashboard/base.html' %}
{% load static %}
{% load form_extras %}

{% block title %}Nuevo Examen Visual - {{ patient.full_name }}{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
    @keyframes fade-in-down {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fade-out {
        0% {
            opacity: 1;
            transform: translateY(0);
        }
        100% {
            opacity: 0;
            transform: translateY(-20px);
        }
    }
    
    .animate-fade-in-down {
        animation: fade-in-down 0.5s ease-out;
    }
    
    /* Resaltar campos pre-cargados */
    input[data-preloaded="true"], textarea[data-preloaded="true"], select[data-preloaded="true"] {
        background-color: #eff6ff !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        transition: all 0.3s ease;
    }
    
    input[data-preloaded="true"]:hover, textarea[data-preloaded="true"]:hover {
        background-color: #dbeafe !important;
    }
    
    .quick-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.2s;
    }
    .quick-btn:hover {
        transform: scale(1.05);
    }
    .value-indicator {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.75rem;
    }
    .field-group {
        position: relative;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        opacity: 1;
    }
    
    /* Fijar textarea para que no se redimensionen */
    textarea {
        resize: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <!-- Header Mejorado -->
    <div class="mb-6 pb-6 border-b">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="{% url 'dashboard:patient_detail' patient.id %}" class="text-gray-600 hover:text-gray-800">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-eye text-purple-600 mr-2"></i>
                        Examen Visual Rápido
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        <strong>{{ patient.full_name }}</strong>
                        {% if patient.age %} | {{ patient.age }} años{% endif %}
                        {% if patient.date_of_birth %} | {{ patient.date_of_birth|date:"d/m/Y" }}{% endif %}
                    </p>
                </div>
            </div>
            <!-- Atajos de teclado -->
            <div class="text-xs text-gray-500 text-right">
                <p><kbd class="px-2 py-1 bg-gray-100 rounded">Tab</kbd> Siguiente campo</p>
                <p><kbd class="px-2 py-1 bg-gray-100 rounded">Ctrl+S</kbd> Guardar</p>
            </div>
        </div>
    </div>

    <!-- Formulario -->
    <form id="visualExamForm" method="POST">
        {% csrf_token %}
        
        <!-- Información General -->
        <div class="bg-gray-50 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                Información General
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha del Examen <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="date" required
                           value="{% if history %}{{ history.date|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Tiempo del Último Control de Ojos
                    </label>
                    <input type="text" name="last_eye_checkup" 
                           value="{% if history %}{{ history.last_eye_checkup }}{% endif %}"
                           placeholder="Ej: Hace 1 año, Hace 6 meses, Primera vez"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <p class="text-xs text-gray-500 mt-1">Indique cuánto tiempo hace del último examen visual</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Médico/Optómetra <span class="text-red-500">*</span>
                    </label>
                    <select name="doctor" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">Seleccione un doctor...</option>
                        {% for doctor in doctors %}
                        <option value="{{ doctor.id }}" {% if history and history.doctor and history.doctor.id == doctor.id %}selected{% endif %}>
                            {{ doctor.full_name }} - {{ doctor.get_specialty_display }}
                            {% if doctor.professional_card %} (T.P: {{ doctor.professional_card }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Información Médica del Paciente (Alertas) -->
        {% if patient.allergies or patient.medical_conditions or patient.current_medications %}
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-orange-500 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-exclamation-triangle text-orange-600 mr-2"></i>
                INFORMACIÓN MÉDICA IMPORTANTE
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                {% if patient.allergies %}
                <div class="bg-white rounded-lg p-4 border-2 border-red-200">
                    <h4 class="text-sm font-bold text-red-700 mb-2 flex items-center">
                        <i class="fas fa-allergies mr-2"></i>Alergias
                    </h4>
                    <p class="text-sm text-gray-700 whitespace-pre-line">{{ patient.allergies }}</p>
                </div>
                {% endif %}
                
                {% if patient.medical_conditions %}
                <div class="bg-white rounded-lg p-4 border-2 border-blue-200">
                    <h4 class="text-sm font-bold text-blue-700 mb-2 flex items-center">
                        <i class="fas fa-heartbeat mr-2"></i>Condiciones Médicas
                    </h4>
                    <p class="text-sm text-gray-700 whitespace-pre-line">{{ patient.medical_conditions }}</p>
                </div>
                {% endif %}
                
                {% if patient.current_medications %}
                <div class="bg-white rounded-lg p-4 border-2 border-green-200">
                    <h4 class="text-sm font-bold text-green-700 mb-2 flex items-center">
                        <i class="fas fa-pills mr-2"></i>Medicamentos Actuales
                    </h4>
                    <p class="text-sm text-gray-700 whitespace-pre-line">{{ patient.current_medications }}</p>
                </div>
                {% endif %}
            </div>
            
            <div class="mt-4 flex items-center text-xs text-orange-700 bg-orange-100 rounded px-3 py-2">
                <i class="fas fa-info-circle mr-2"></i>
                <span>Esta información fue registrada en la ficha del paciente. Considera estos datos durante el examen.</span>
            </div>
        </div>
        {% endif %}

        <!-- ANAMNESIS -->
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-file-medical-alt text-blue-600 mr-2"></i>
                ANAMNESIS
            </h3>
            
            <div class="space-y-4">
                <!-- Motivo de Consulta -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 uppercase">
                        Motivo de Consulta
                    </label>
                    <textarea name="chief_complaint" rows="2" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Ej: Control visual, Paciente no usaría de corrección óptica que asiste a consulta para control visual">{% if history %}{{ history.chief_complaint }}{% endif %}</textarea>
                </div>

                <!-- Enfermedad Actual -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 uppercase">
                        Enfermedad Actual
                    </label>
                    <textarea name="current_illness" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Ej: Paciente no usaría de corrección óptica que asiste a consulta para control visual">{% if history %}{{ history.current_illness }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- ANTECEDENTES GENERALES -->
        <div class="bg-gradient-to-r from-amber-50 to-amber-100 border-l-4 border-amber-600 rounded-lg p-6 mb-6 shadow-sm">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-800 flex items-center uppercase tracking-wide">
                    <i class="fas fa-notes-medical text-amber-600 mr-2"></i>
                    ANTECEDENTES GENERALES
                </h3>
                <button type="button" onclick="fillGeneralHistoryWithNA()" 
                        class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-black rounded-lg shadow transition-all duration-200 flex items-center gap-2 text-sm font-medium">
                    <i class="fas fa-magic"></i>
                    <span>Rellenar Sección con N/A</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Patológicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-disease text-red-600 mr-1"></i> Patológicos</span>
                        <button type="button" onclick="fillWithNA('pathological_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="pathological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Diabetes, hipertensión, enfermedades crónicas... o escriba N/A">{% if history %}{{ history.pathological_history }}{% endif %}</textarea>
                </div>

                <!-- Farmacológicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-pills text-green-600 mr-1"></i> Farmacológicos</span>
                        <button type="button" onclick="fillWithNA('pharmacological_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="pharmacological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Medicamentos que toma actualmente... o escriba N/A">{% if history %}{{ history.pharmacological_history }}{% endif %}</textarea>
                </div>

                <!-- Quirúrgicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-procedures text-blue-600 mr-1"></i> Quirúrgicos</span>
                        <button type="button" onclick="fillWithNA('surgical_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="surgical_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Cirugías previas generales... o escriba N/A">{% if history %}{{ history.surgical_history }}{% endif %}</textarea>
                </div>

                <!-- Alérgicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-allergies text-orange-600 mr-1"></i> Alérgicos</span>
                        <button type="button" onclick="fillWithNA('allergic_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="allergic_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Alergias conocidas... o escriba N/A">{% if history %}{{ history.allergic_history }}{% endif %}</textarea>
                </div>

                <!-- Traumatológicos -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-band-aid text-purple-600 mr-1"></i> Traumatológicos</span>
                        <button type="button" onclick="fillWithNA('trauma_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="trauma_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Traumatismos previos... o escriba N/A">{% if history %}{{ history.trauma_history }}{% endif %}</textarea>
                </div>

                <!-- Otros -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-notes-medical text-gray-600 mr-1"></i> Otros</span>
                        <button type="button" onclick="fillWithNA('other_general_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="other_general_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                              placeholder="Otros antecedentes generales... o escriba N/A">{% if history %}{{ history.other_general_history }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- ANTECEDENTES OCULARES -->
        <div class="bg-gradient-to-r from-teal-50 to-teal-100 border-l-4 border-teal-600 rounded-lg p-6 mb-6 shadow-sm">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-xl font-bold text-gray-800 flex items-center uppercase tracking-wide">
                    <i class="fas fa-eye text-teal-600 mr-2"></i>
                    ANTECEDENTES OCULARES
                </h3>
                <button type="button" onclick="fillOcularHistoryWithNA()" 
                        class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-black rounded-lg shadow transition-all duration-200 flex items-center gap-2 text-sm font-medium">
                    <i class="fas fa-magic"></i>
                    <span>Rellenar Sección con N/A</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Patológicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-eye-slash text-red-600 mr-1"></i> Patológicos Oculares</span>
                        <button type="button" onclick="fillWithNA('ocular_pathological_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="ocular_pathological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="Glaucoma, cataratas, enfermedades oculares previas... o escriba N/A">{% if history %}{{ history.ocular_pathological_history }}{% endif %}</textarea>
                </div>

                <!-- Farmacológicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-eye-dropper text-green-600 mr-1"></i> Farmacológicos Oculares</span>
                        <button type="button" onclick="fillWithNA('ocular_pharmacological_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="ocular_pharmacological_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="Gotas, medicamentos oculares actuales... o escriba N/A">{% if history %}{{ history.ocular_pharmacological_history }}{% endif %}</textarea>
                </div>

                <!-- Quirúrgicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-scalpel text-blue-600 mr-1"></i> Quirúrgicos Oculares</span>
                        <button type="button" onclick="fillWithNA('ocular_surgical_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="ocular_surgical_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="LASIK, cirugía de cataratas, cirugías oculares previas... o escriba N/A">{% if history %}{{ history.ocular_surgical_history }}{% endif %}</textarea>
                </div>

                <!-- Traumatológicos Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex justify-between items-center">
                        <span><i class="fas fa-user-injured text-purple-600 mr-1"></i> Traumatológicos Oculares</span>
                        <button type="button" onclick="fillWithNA('ocular_trauma_history')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <textarea name="ocular_trauma_history" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500"
                              placeholder="Traumatismos oculares previos... o escriba N/A">{% if history %}{{ history.ocular_trauma_history }}{% endif %}</textarea>
                </div>

                <!-- Lensometría y Fórmula Actual - 2 Cards -->
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Card 1: Lensometría -->
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center justify-between">
                            <span><i class="fas fa-glasses text-indigo-600 mr-1"></i> Lensometría</span>
                            <button type="button" onclick="fillWithNA('lensometry_notes')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                                N/A
                            </button>
                        </label>
                        <div class="space-y-2">
                            <!-- Tipo de Lente con opción de crear nuevo -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Tipo de Lente</label>
                                <div class="flex gap-2">
                                    <select name="lensometry_lens_type" id="lensometry_lens_type"
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-sm">
                                        <option value="">-- Seleccione tipo de lente --</option>
                                        {% for lens_type in lens_types %}
                                        <option value="{{ lens_type.id }}" 
                                                {% if history and history.lensometry_lens_type and history.lensometry_lens_type.id == lens_type.id %}selected{% endif %}>
                                            {{ lens_type.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" onclick="showCreateLensTypeModal()" 
                                            class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium whitespace-nowrap">
                                        <i class="fas fa-plus mr-1"></i> Crear
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Checkboxes de uso de lentes -->
                            <div class="flex items-center space-x-4 mt-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="previous_glasses" {% if history.previous_glasses %}checked{% endif %}
                                           class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                    <span class="text-xs text-gray-700 font-medium">Usa Lentes</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="previous_contact_lenses" {% if history.previous_contact_lenses %}checked{% endif %}
                                           class="w-4 h-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                                    <span class="text-xs text-gray-700 font-medium">LC</span>
                                </label>
                            </div>
                            
                            <!-- Notas de Lensometría -->
                            <textarea name="lensometry_notes" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-xs"
                                      placeholder="Notas adicionales...">{% if history %}{{ history.lensometry_notes }}{% endif %}</textarea>
                        </div>
                    </div>

                    <!-- Card 2: Fórmula de Lentes Actuales -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border-2 border-indigo-200">
                        <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-prescription text-indigo-600 mr-1"></i> Fórmula Lentes Actuales
                        </label>
                        
                        <!-- OD -->
                        <div class="mb-3">
                            <div class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded mb-2">OD (Ojo Derecho)</div>
                            <div class="grid grid-cols-4 gap-2">
                                <div>
                                    <label class="text-xs text-gray-600">Esfera</label>
                                    <input type="text" name="current_rx_od_sphere" 
                                           value="{% if history.current_rx_od_sphere %}{{ history.current_rx_od_sphere }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-blue-500"
                                           placeholder="±0.00">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">Cilindro</label>
                                    <input type="text" name="current_rx_od_cylinder" 
                                           value="{% if history.current_rx_od_cylinder %}{{ history.current_rx_od_cylinder }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-blue-500"
                                           placeholder="±0.00">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">Eje</label>
                                    <input type="text" name="current_rx_od_axis" 
                                           value="{% if history.current_rx_od_axis %}{{ history.current_rx_od_axis }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-blue-500"
                                           placeholder="0-180">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">ADD</label>
                                    <input type="text" name="current_rx_od_add" 
                                           value="{% if history.current_rx_od_add %}{{ history.current_rx_od_add }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-blue-500"
                                           placeholder="+0.00">
                                </div>
                            </div>
                        </div>

                        <!-- OS -->
                        <div>
                            <div class="text-xs font-bold text-white bg-green-500 px-2 py-1 rounded mb-2">OS (Ojo Izquierdo)</div>
                            <div class="grid grid-cols-4 gap-2">
                                <div>
                                    <label class="text-xs text-gray-600">Esfera</label>
                                    <input type="text" name="current_rx_os_sphere" 
                                           value="{% if history.current_rx_os_sphere %}{{ history.current_rx_os_sphere }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-green-500"
                                           placeholder="±0.00">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">Cilindro</label>
                                    <input type="text" name="current_rx_os_cylinder" 
                                           value="{% if history.current_rx_os_cylinder %}{{ history.current_rx_os_cylinder }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-green-500"
                                           placeholder="±0.00">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">Eje</label>
                                    <input type="text" name="current_rx_os_axis" 
                                           value="{% if history.current_rx_os_axis %}{{ history.current_rx_os_axis }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-green-500"
                                           placeholder="0-180">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600">ADD</label>
                                    <input type="text" name="current_rx_os_add" 
                                           value="{% if history.current_rx_os_add %}{{ history.current_rx_os_add }}{% endif %}"
                                           class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-green-500"
                                           placeholder="+0.00">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DISTANCIA PUPILAR -->
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center uppercase tracking-wide">
                <i class="fas fa-ruler-horizontal text-blue-600 mr-2"></i>
                DISTANCIA PUPILAR (mm)
            </h3>
            
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-arrows-alt-h text-blue-600 mr-1"></i> DP Lejos
                        </label>
                        <input type="number" step="0.5" name="pd_distance"
                               value="{% if history.pd_distance %}{{ history.pd_distance|stringformat:'g' }}{% endif %}"
                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="63.0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-eye text-blue-600 mr-1"></i> DNP OD
                        </label>
                        <input type="number" step="0.5" name="pd_od"
                               value="{% if history.pd_od %}{{ history.pd_od|stringformat:'g' }}{% endif %}"
                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="31.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-eye text-green-600 mr-1"></i> DNP OI
                        </label>
                        <input type="number" step="0.5" name="pd_os"
                               value="{% if history.pd_os %}{{ history.pd_os|stringformat:'g' }}{% endif %}"
                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="31.5">
                    </div>
                </div>
            </div>
        </div>

        <!-- EXÁMENES REFRACTIVOS ADICIONALES -->
        <div class="bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-eye text-purple-600 mr-2"></i>
                EXÁMENES REFRACTIVOS ADICIONALES
            </h3>
            
            <!-- Checkboxes de selección -->
            <div class="bg-white rounded-lg p-4 shadow-sm mb-4">
                <label class="block text-sm font-bold text-gray-800 mb-3">
                    <i class="fas fa-tasks text-purple-600 mr-1"></i> Selecciona los exámenes realizados:
                </label>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <label class="flex items-center space-x-2 cursor-pointer bg-purple-50 hover:bg-purple-100 p-2 rounded transition">
                        <input type="checkbox" name="exam_retinoscopy_done" id="check_retinoscopy" 
                               {% if history.exam_retinoscopy_done %}checked{% endif %}
                               onchange="toggleExamSection('retinoscopy', this.checked)"
                               class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Retinoscopia</span>
                    </label>
                    
                    <label class="flex items-center space-x-2 cursor-pointer bg-purple-50 hover:bg-purple-100 p-2 rounded transition">
                        <input type="checkbox" name="exam_subjective_done" id="check_subjective"
                               {% if history.exam_subjective_done %}checked{% endif %}
                               onchange="toggleExamSection('subjective', this.checked)"
                               class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Subjetivo</span>
                    </label>
                    
                    <label class="flex items-center space-x-2 cursor-pointer bg-purple-50 hover:bg-purple-100 p-2 rounded transition">
                        <input type="checkbox" name="exam_refinement_done" id="check_refinement"
                               {% if history.exam_refinement_done %}checked{% endif %}
                               onchange="toggleExamSection('refinement', this.checked)"
                               class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Afinación</span>
                    </label>
                    
                    <label class="flex items-center space-x-2 cursor-pointer bg-purple-50 hover:bg-purple-100 p-2 rounded transition">
                        <input type="checkbox" name="exam_cycloplegic_done" id="check_cycloplegic"
                               {% if history.exam_cycloplegic_done %}checked{% endif %}
                               onchange="toggleExamSection('cycloplegic', this.checked)"
                               class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">Subj. Ciclopléjico</span>
                    </label>
                    
                    <label class="flex items-center space-x-2 cursor-pointer bg-purple-50 hover:bg-purple-100 p-2 rounded transition">
                        <input type="checkbox" name="exam_final_rx_done" id="check_final_rx"
                               {% if history.exam_final_rx_done %}checked{% endif %}
                               onchange="toggleExamSection('final_rx', this.checked)"
                               class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm font-medium text-gray-700">RX Final</span>
                    </label>
                </div>
            </div>
            
            <!-- RETINOSCOPIA -->
            <div id="section_retinoscopy" class="bg-white rounded-lg p-4 shadow-sm border-2 border-purple-200 mb-4" style="display: {% if history.exam_retinoscopy_done %}block{% else %}none{% endif %};">
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-eye-dropper text-purple-600 mr-1"></i> RETINOSCOPIA
                </label>
                
                <!-- OD -->
                <div class="mb-3">
                    <div class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded mb-2">OD (Ojo Derecho)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="retinoscopy_od_sphere" 
                                   value="{% if history.retinoscopy_od_sphere %}{{ history.retinoscopy_od_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="retinoscopy_od_cylinder" 
                                   value="{% if history.retinoscopy_od_cylinder %}{{ history.retinoscopy_od_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="retinoscopy_od_axis" 
                                   value="{% if history.retinoscopy_od_axis %}{{ history.retinoscopy_od_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="retinoscopy_od_add" 
                                   value="{% if history.retinoscopy_od_add %}{{ history.retinoscopy_od_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>

                <!-- OS -->
                <div>
                    <div class="text-xs font-bold text-white bg-green-500 px-2 py-1 rounded mb-2">OS (Ojo Izquierdo)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="retinoscopy_os_sphere" 
                                   value="{% if history.retinoscopy_os_sphere %}{{ history.retinoscopy_os_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="retinoscopy_os_cylinder" 
                                   value="{% if history.retinoscopy_os_cylinder %}{{ history.retinoscopy_os_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="retinoscopy_os_axis" 
                                   value="{% if history.retinoscopy_os_axis %}{{ history.retinoscopy_os_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="retinoscopy_os_add" 
                                   value="{% if history.retinoscopy_os_add %}{{ history.retinoscopy_os_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SUBJETIVO -->
            <div id="section_subjective" class="bg-white rounded-lg p-4 shadow-sm border-2 border-purple-200 mb-4" style="display: {% if history.exam_subjective_done %}block{% else %}none{% endif %};">
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-user-check text-purple-600 mr-1"></i> SUBJETIVO
                </label>
                
                <!-- OD -->
                <div class="mb-3">
                    <div class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded mb-2">OD (Ojo Derecho)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="subjective_od_sphere" 
                                   value="{% if history.subjective_od_sphere %}{{ history.subjective_od_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="subjective_od_cylinder" 
                                   value="{% if history.subjective_od_cylinder %}{{ history.subjective_od_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="subjective_od_axis" 
                                   value="{% if history.subjective_od_axis %}{{ history.subjective_od_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="subjective_od_add" 
                                   value="{% if history.subjective_od_add %}{{ history.subjective_od_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>

                <!-- OS -->
                <div>
                    <div class="text-xs font-bold text-white bg-green-500 px-2 py-1 rounded mb-2">OS (Ojo Izquierdo)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="subjective_os_sphere" 
                                   value="{% if history.subjective_os_sphere %}{{ history.subjective_os_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="subjective_os_cylinder" 
                                   value="{% if history.subjective_os_cylinder %}{{ history.subjective_os_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="subjective_os_axis" 
                                   value="{% if history.subjective_os_axis %}{{ history.subjective_os_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="subjective_os_add" 
                                   value="{% if history.subjective_os_add %}{{ history.subjective_os_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AFINACIÓN -->
            <div id="section_refinement" class="bg-white rounded-lg p-4 shadow-sm border-2 border-purple-200 mb-4" style="display: {% if history.exam_refinement_done %}block{% else %}none{% endif %};">
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-adjust text-purple-600 mr-1"></i> AFINACIÓN
                </label>
                
                <!-- OD -->
                <div class="mb-3">
                    <div class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded mb-2">OD (Ojo Derecho)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="refinement_od_sphere" 
                                   value="{% if history.refinement_od_sphere %}{{ history.refinement_od_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="refinement_od_cylinder" 
                                   value="{% if history.refinement_od_cylinder %}{{ history.refinement_od_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="refinement_od_axis" 
                                   value="{% if history.refinement_od_axis %}{{ history.refinement_od_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="refinement_od_add" 
                                   value="{% if history.refinement_od_add %}{{ history.refinement_od_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>

                <!-- OS -->
                <div>
                    <div class="text-xs font-bold text-white bg-green-500 px-2 py-1 rounded mb-2">OS (Ojo Izquierdo)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="refinement_os_sphere" 
                                   value="{% if history.refinement_os_sphere %}{{ history.refinement_os_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="refinement_os_cylinder" 
                                   value="{% if history.refinement_os_cylinder %}{{ history.refinement_os_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="refinement_os_axis" 
                                   value="{% if history.refinement_os_axis %}{{ history.refinement_os_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="refinement_os_add" 
                                   value="{% if history.refinement_os_add %}{{ history.refinement_os_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SUBJETIVO BAJO CICLOPLEJIA -->
            <div id="section_cycloplegic" class="bg-white rounded-lg p-4 shadow-sm border-2 border-purple-200 mb-4" style="display: {% if history.exam_cycloplegic_done %}block{% else %}none{% endif %};">
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-flask text-purple-600 mr-1"></i> SUBJETIVO BAJO CICLOPLEJIA
                </label>
                
                <!-- OD -->
                <div class="mb-3">
                    <div class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded mb-2">OD (Ojo Derecho)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="cycloplegic_od_sphere" 
                                   value="{% if history.cycloplegic_od_sphere %}{{ history.cycloplegic_od_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="cycloplegic_od_cylinder" 
                                   value="{% if history.cycloplegic_od_cylinder %}{{ history.cycloplegic_od_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="cycloplegic_od_axis" 
                                   value="{% if history.cycloplegic_od_axis %}{{ history.cycloplegic_od_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="cycloplegic_od_add" 
                                   value="{% if history.cycloplegic_od_add %}{{ history.cycloplegic_od_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>

                <!-- OS -->
                <div>
                    <div class="text-xs font-bold text-white bg-green-500 px-2 py-1 rounded mb-2">OS (Ojo Izquierdo)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="cycloplegic_os_sphere" 
                                   value="{% if history.cycloplegic_os_sphere %}{{ history.cycloplegic_os_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="cycloplegic_os_cylinder" 
                                   value="{% if history.cycloplegic_os_cylinder %}{{ history.cycloplegic_os_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="cycloplegic_os_axis" 
                                   value="{% if history.cycloplegic_os_axis %}{{ history.cycloplegic_os_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="cycloplegic_os_add" 
                                   value="{% if history.cycloplegic_os_add %}{{ history.cycloplegic_os_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RX FINAL -->
            <div id="section_final_rx" class="bg-white rounded-lg p-4 shadow-sm border-2 border-purple-200 mb-4" style="display: {% if history.exam_final_rx_done %}block{% else %}none{% endif %};">
                <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-check-circle text-purple-600 mr-1"></i> RX FINAL
                </label>
                
                <!-- Selector de examen a copiar -->
                <div class="bg-gradient-to-r from-purple-100 to-indigo-100 border-2 border-purple-300 rounded-lg p-4 mb-4">
                    <label class="block text-sm font-bold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-copy text-indigo-600 mr-2"></i> Copiar datos desde examen:
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button type="button" onclick="copyToFinalRx('retinoscopy')" 
                                class="flex items-center justify-center space-x-2 bg-white hover:bg-purple-50 border-2 border-purple-300 hover:border-purple-500 px-4 py-2 rounded-lg transition-all shadow-sm">
                            <i class="fas fa-eye-dropper text-purple-600"></i>
                            <span class="text-sm font-medium text-gray-700">Retinoscopia</span>
                        </button>
                        
                        <button type="button" onclick="copyToFinalRx('subjective')" 
                                class="flex items-center justify-center space-x-2 bg-white hover:bg-purple-50 border-2 border-purple-300 hover:border-purple-500 px-4 py-2 rounded-lg transition-all shadow-sm">
                            <i class="fas fa-user-check text-blue-600"></i>
                            <span class="text-sm font-medium text-gray-700">Subjetivo</span>
                        </button>
                        
                        <button type="button" onclick="copyToFinalRx('refinement')" 
                                class="flex items-center justify-center space-x-2 bg-white hover:bg-purple-50 border-2 border-purple-300 hover:border-purple-500 px-4 py-2 rounded-lg transition-all shadow-sm">
                            <i class="fas fa-adjust text-green-600"></i>
                            <span class="text-sm font-medium text-gray-700">Afinación</span>
                        </button>
                        
                        <button type="button" onclick="copyToFinalRx('cycloplegic')" 
                                class="flex items-center justify-center space-x-2 bg-white hover:bg-purple-50 border-2 border-purple-300 hover:border-purple-500 px-4 py-2 rounded-lg transition-all shadow-sm">
                            <i class="fas fa-flask text-orange-600"></i>
                            <span class="text-sm font-medium text-gray-700">Ciclopléjico</span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-2 italic">
                        <i class="fas fa-info-circle mr-1"></i> Haz clic en un botón para copiar automáticamente los datos de ese examen a RX Final
                    </p>
                </div>
                
                <!-- OD -->
                <div class="mb-3">
                    <div class="text-xs font-bold text-white bg-blue-500 px-2 py-1 rounded mb-2">OD (Ojo Derecho)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="final_rx_od_sphere" 
                                   value="{% if history.final_rx_od_sphere %}{{ history.final_rx_od_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="final_rx_od_cylinder" 
                                   value="{% if history.final_rx_od_cylinder %}{{ history.final_rx_od_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="final_rx_od_axis" 
                                   value="{% if history.final_rx_od_axis %}{{ history.final_rx_od_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="final_rx_od_add" 
                                   value="{% if history.final_rx_od_add %}{{ history.final_rx_od_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>

                <!-- OS -->
                <div>
                    <div class="text-xs font-bold text-white bg-green-500 px-2 py-1 rounded mb-2">OS (Ojo Izquierdo)</div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs text-gray-600">Esfera</label>
                            <input type="text" name="final_rx_os_sphere" 
                                   value="{% if history.final_rx_os_sphere %}{{ history.final_rx_os_sphere }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Cilindro</label>
                            <input type="text" name="final_rx_os_cylinder" 
                                   value="{% if history.final_rx_os_cylinder %}{{ history.final_rx_os_cylinder }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="±0.00">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Eje</label>
                            <input type="text" name="final_rx_os_axis" 
                                   value="{% if history.final_rx_os_axis %}{{ history.final_rx_os_axis }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="0-180">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">ADD</label>
                            <input type="text" name="final_rx_os_add" 
                                   value="{% if history.final_rx_os_add %}{{ history.final_rx_os_add }}{% endif %}"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-purple-500"
                                   placeholder="+0.00">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANTECEDENTES FAMILIARES -->
        <div class="bg-gradient-to-r from-pink-50 to-pink-100 border-l-4 border-pink-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-users text-pink-600 mr-2"></i>
                ANTECEDENTES FAMILIARES
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Generales -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center justify-between">
                        <span><i class="fas fa-heartbeat text-pink-600 mr-1"></i> Generales</span>
                        <button type="button" onclick="fillWithNA('family_general_notes')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_diabetes" {% if history.family_diabetes %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Diabetes</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_hypertension" {% if history.family_hypertension %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Hipertensión</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_heart_disease" {% if history.family_heart_disease %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Cardiopatías</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_cancer" {% if history.family_cancer %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Cáncer</span>
                        </label>
                    </div>
                    <textarea name="family_general_notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Otros antecedentes familiares generales... o escriba N/A">{% if history %}{{ history.family_general_notes }}{% endif %}</textarea>
                </div>

                <!-- Oculares -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <label class="block text-sm font-bold text-gray-800 mb-2 flex items-center justify-between">
                        <span><i class="fas fa-eye text-pink-600 mr-1"></i> Oculares</span>
                        <button type="button" onclick="fillWithNA('family_ocular_notes')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded" title="Rellenar con N/A">
                            N/A
                        </button>
                    </label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_glaucoma" {% if history.family_glaucoma %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Glaucoma</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_cataracts" {% if history.family_cataracts %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Cataratas</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_macular_degeneration" {% if history.family_macular_degeneration %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Deg. Macular</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_retinal_detachment" {% if history.family_retinal_detachment %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Desp. Retina</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_myopia" {% if history.family_myopia %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Miopía</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="family_strabismus" {% if history.family_strabismus %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Estrabismo</span>
                        </label>
                    </div>
                    <textarea name="family_ocular_notes" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Otros antecedentes familiares oculares... o escriba N/A">{% if history %}{{ history.family_ocular_notes }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- PANEL DE VISUALIZACIÓN MÉDICA AVANZADA -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- GRÁFICO RADAR: COMPARACIÓN OD vs OI -->
            <div class="bg-white border-2 border-blue-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-area text-blue-600 mr-2"></i>
                    Análisis Comparativo OD vs OI
                </h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="radarChart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                        <span class="text-gray-600">Ojo Derecho (OD)</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                        <span class="text-gray-600">Ojo Izquierdo (OI)</span>
                    </div>
                </div>
            </div>

            <!-- DIAGRAMA POLAR: EJE DE ASTIGMATISMO -->
            <div class="bg-white border-2 border-purple-200 rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-compass text-purple-600 mr-2"></i>
                    Eje de Astigmatismo (0-180°)
                </h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="polarChart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                        <span class="text-gray-600">OD: <span id="odAxisLabel">--°</span></span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                        <span class="text-gray-600">OI: <span id="oiAxisLabel">--°</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- INDICADORES VISUALES DE SEVERIDAD -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <!-- Indicador Miopía/Hipermetropía -->
            <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 border-2 border-indigo-300 rounded-xl p-4 shadow-md">
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-adjust text-indigo-600 mr-2"></i>
                    Refracción Esférica
                </h4>
                <div class="space-y-2">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">OD</span>
                            <span id="odSphereStatus" class="font-semibold">Normal</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="odSphereBar" class="h-full bg-gradient-to-r from-green-400 to-green-500 transition-all duration-500" style="width: 50%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">OI</span>
                            <span id="oiSphereStatus" class="font-semibold">Normal</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="oiSphereBar" class="h-full bg-gradient-to-r from-green-400 to-green-500 transition-all duration-500" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicador Astigmatismo -->
            <div class="bg-gradient-to-br from-amber-50 to-amber-100 border-2 border-amber-300 rounded-xl p-4 shadow-md">
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-wave-square text-amber-600 mr-2"></i>
                    Astigmatismo
                </h4>
                <div class="space-y-2">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">OD</span>
                            <span id="odCylStatus" class="font-semibold">Sin astigmatismo</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="odCylBar" class="h-full bg-gradient-to-r from-green-400 to-green-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">OI</span>
                            <span id="oiCylStatus" class="font-semibold">Sin astigmatismo</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="oiCylBar" class="h-full bg-gradient-to-r from-green-400 to-green-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicador Agudeza Visual -->
            <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border-2 border-emerald-300 rounded-xl p-4 shadow-md">
                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-eye text-emerald-600 mr-2"></i>
                    Agudeza Visual CC
                </h4>
                <div class="space-y-2">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">OD</span>
                            <span id="odVaStatus" class="font-semibold">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="odVaBar" class="h-full bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-600">OI</span>
                            <span id="oiVaStatus" class="font-semibold">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="oiVaBar" class="h-full bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OPTOMETRÍA / AGUDEZA VISUAL CON BOTONES RÁPIDOS -->
        <div class="bg-purple-50 border-l-4 border-purple-600 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-glasses text-purple-600 mr-2"></i>
                OPTOMETRÍA
            </h3>
            
            <!-- Agudeza Visual -->
            <div class="mb-5">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-700 bg-white p-2 rounded">Agudeza Visual</h4>
                    <!-- BOTONES RÁPIDOS AQUÍ -->
                    <div class="flex gap-2">
                        <button type="button" onclick="setAllVA('20/20')" class="quick-btn bg-green-600 text-white border-green-700 hover:bg-green-700">
                            <i class="fas fa-bolt mr-1"></i>20/20 Todo
                        </button>
                        <button type="button" onclick="setAllVA('20/30')" class="quick-btn bg-yellow-500 text-white border-yellow-600 hover:bg-yellow-600">
                            20/30 Todo
                        </button>
                        <button type="button" onclick="clearVA()" class="quick-btn bg-gray-500 text-white border-gray-600 hover:bg-gray-600">
                            <i class="fas fa-eraser mr-1"></i>Limpiar
                        </button>
                    </div>
                </div>
                
                <!-- Cartillas en una fila -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <!-- Cartilla de Visión Lejana -->
                    <div class="bg-blue-50 p-3 rounded">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-eye mr-2"></i>Cartilla Visión Lejana (6 metros)
                        </label>
                        <select name="distance_chart" id="distance_chart" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Seleccionar cartilla --</option>
                            <option value="Snellen metros" {% if history and history.distance_chart == "Snellen metros" %}selected{% endif %}>Snellen (metros) - 6/6, 6/9, 6/12...</option>
                            <option value="Snellen pies" {% if history and history.distance_chart == "Snellen pies" %}selected{% endif %}>Snellen (pies) - 20/20, 20/40, 20/60...</option>
                            <option value="ETDRS logMAR" {% if history and history.distance_chart == "ETDRS logMAR" %}selected{% endif %}>ETDRS logMAR - 0.0, 0.1, 0.2...</option>
                            <option value="Decimal" {% if history and history.distance_chart == "Decimal" %}selected{% endif %}>Decimal - 1.0, 0.8, 0.5...</option>
                            <option value="Anillos Landolt" {% if history and history.distance_chart == "Anillos Landolt" %}selected{% endif %}>Anillos de Landolt</option>
                            <option value="Figuras" {% if history and history.distance_chart == "Figuras" %}selected{% endif %}>Figuras (pediatría)</option>
                        </select>
                    </div>
                    
                    <!-- Cartilla de Visión Próxima -->
                    <div class="bg-green-50 p-3 rounded">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-book-open mr-2"></i>Cartilla Visión Próxima (40 cm)
                        </label>
                        <select name="near_chart" id="near_chart" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500">
                            <option value="">-- Seleccionar cartilla --</option>
                            <option value="Jaeger" {% if history and history.near_chart == "Jaeger" %}selected{% endif %}>Tabla de Jaeger (J) - J1, J2... a 40cm</option>
                            <option value="Rosenbaum" {% if history and history.near_chart == "Rosenbaum" %}selected{% endif %}>Cartilla Rosenbaum - a 35-40cm</option>
                            <option value="Snellen cerca" {% if history and history.near_chart == "Snellen cerca" %}selected{% endif %}>Snellen cerca - a 40cm</option>
                        </select>
                    </div>
                </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- OD -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-2">
                        <span class="bg-blue-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OD</span>
                        <span class="font-semibold">Ojo Derecho</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">SC Lejos</label>
                            <input type="text" name="va_od_sc_distance" id="va_od_sc"
                                   value="{% if history %}{{ history.va_od_sc_distance }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="20/20">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">CC Lejos</label>
                            <input type="text" name="va_od_cc_distance" id="va_od_cc"
                                   value="{% if history %}{{ history.va_od_cc_distance }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="20/20">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">SC Cerca</label>
                            <input type="text" name="va_od_sc_near"
                                   value="{% if history %}{{ history.va_od_sc_near }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="J1 a 40cm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">CC Cerca</label>
                            <input type="text" name="va_od_cc_near"
                                   value="{% if history %}{{ history.va_od_cc_near }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="J1 a 40cm">
                        </div>
                    </div>
                </div>
                <!-- OS -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-2">
                        <span class="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OS</span>
                        <span class="font-semibold">Ojo Izquierdo</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">SC Lejos</label>
                            <input type="text" name="va_os_sc_distance" id="va_os_sc"
                                   value="{% if history %}{{ history.va_os_sc_distance }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="20/20">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">CC Lejos</label>
                            <input type="text" name="va_os_cc_distance" id="va_os_cc"
                                   value="{% if history %}{{ history.va_os_cc_distance }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="20/20">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">SC Cerca</label>
                            <input type="text" name="va_os_sc_near"
                                   value="{% if history %}{{ history.va_os_sc_near }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="J1 a 40cm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">CC Cerca</label>
                            <input type="text" name="va_os_cc_near"
                                   value="{% if history %}{{ history.va_os_cc_near }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500"
                                   placeholder="J1 a 40cm">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QUERATOMETRÍA -->
        <div class="bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-600 rounded-lg p-6 mb-6 shadow-sm">
            <h3 class="text-xl font-bold text-gray-800 mb-5 flex items-center uppercase tracking-wide">
                <i class="fas fa-circle-notch text-purple-600 mr-2"></i>
                QUERATOMETRÍA
            </h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- OD -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-4 text-center">OD (Ojo Derecho)</h4>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">K1 (D)</label>
                                <input type="number" step="0.25" name="keratometry_od_k1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                       placeholder="43.00"
                                       value="{% if history.keratometry_od_k1 %}{{ history.keratometry_od_k1|stringformat:'g' }}{% endif %}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">K2 (D)</label>
                                <input type="number" step="0.25" name="keratometry_od_k2"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                       placeholder="44.00"
                                       value="{% if history.keratometry_od_k2 %}{{ history.keratometry_od_k2|stringformat:'g' }}{% endif %}">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Eje</label>
                            <input type="number" min="0" max="180" name="keratometry_od_axis"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                   placeholder="0"
                                   value="{% if history.keratometry_od_k1_axis %}{{ history.keratometry_od_k1_axis }}{% endif %}">
                        </div>
                    </div>
                </div>

                <!-- OS -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-4 text-center">OI (Ojo Izquierdo)</h4>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">K1 (D)</label>
                                <input type="number" step="0.25" name="keratometry_os_k1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                       placeholder="43.00"
                                       value="{% if history.keratometry_os_k1 %}{{ history.keratometry_os_k1|stringformat:'g' }}{% endif %}">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">K2 (D)</label>
                                <input type="number" step="0.25" name="keratometry_os_k2"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                       placeholder="44.00"
                                       value="{% if history.keratometry_os_k2 %}{{ history.keratometry_os_k2|stringformat:'g' }}{% endif %}">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Eje</label>
                            <input type="number" min="0" max="180" name="keratometry_os_axis"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                   placeholder="0"
                                   value="{% if history.keratometry_os_k1_axis %}{{ history.keratometry_os_k1_axis }}{% endif %}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEGMENTO ANTERIOR -->
        <div class="bg-green-50 border-l-4 border-green-600 rounded-lg p-5 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-eye text-green-600 mr-2"></i>
                    SEGMENTO ANTERIOR
                </h3>
                <button type="button" onclick="fillAnteriorSegmentDefaults()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                    <i class="fas fa-magic mr-1"></i>Rellenar valores normales
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- OD -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-blue-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OD</span>
                        <span class="font-semibold">Ojo Derecho</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Párpados</label>
                            <input type="text" name="biomicroscopy_od_lids"
                                   value="{% if history %}{{ history.biomicroscopy_od_lids }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Conjuntiva</label>
                            <input type="text" name="biomicroscopy_od_conjunctiva"
                                   value="{% if history %}{{ history.biomicroscopy_od_conjunctiva }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Córnea</label>
                            <input type="text" name="biomicroscopy_od_cornea"
                                   value="{% if history %}{{ history.biomicroscopy_od_cornea }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cámara Anterior</label>
                            <input type="text" name="biomicroscopy_od_anterior_chamber"
                                   value="{% if history %}{{ history.biomicroscopy_od_anterior_chamber }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Formada, profunda">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Iris</label>
                            <input type="text" name="biomicroscopy_od_iris"
                                   value="{% if history %}{{ history.biomicroscopy_od_iris }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cristalino</label>
                            <input type="text" name="biomicroscopy_od_lens"
                                   value="{% if history %}{{ history.biomicroscopy_od_lens }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Pupila</label>
                            <input type="text" name="biomicroscopy_od_pupil"
                                   value="{% if history %}{{ history.biomicroscopy_od_pupil }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Redonda, reactiva">
                        </div>
                    </div>
                </div>
                
                <!-- OS -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OS</span>
                        <span class="font-semibold">Ojo Izquierdo</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Párpados</label>
                            <input type="text" name="biomicroscopy_os_lids"
                                   value="{% if history %}{{ history.biomicroscopy_os_lids }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Conjuntiva</label>
                            <input type="text" name="biomicroscopy_os_conjunctiva"
                                   value="{% if history %}{{ history.biomicroscopy_os_conjunctiva }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Córnea</label>
                            <input type="text" name="biomicroscopy_os_cornea"
                                   value="{% if history %}{{ history.biomicroscopy_os_cornea }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cámara Anterior</label>
                            <input type="text" name="biomicroscopy_os_anterior_chamber"
                                   value="{% if history %}{{ history.biomicroscopy_os_anterior_chamber }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Formada, profunda">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Iris</label>
                            <input type="text" name="biomicroscopy_os_iris"
                                   value="{% if history %}{{ history.biomicroscopy_os_iris }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Normal">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cristalino</label>
                            <input type="text" name="biomicroscopy_os_lens"
                                   value="{% if history %}{{ history.biomicroscopy_os_lens }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Pupila</label>
                            <input type="text" name="biomicroscopy_os_pupil"
                                   value="{% if history %}{{ history.biomicroscopy_os_pupil }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Redonda, reactiva">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEGMENTO POSTERIOR -->
        <div class="bg-indigo-50 border-l-4 border-indigo-600 rounded-lg p-5 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-circle text-indigo-600 mr-2"></i>
                    SEGMENTO POSTERIOR (FONDO DE OJO)
                </h3>
                <div class="flex gap-2">
                    <button type="button" onclick="fillPosteriorSegmentDefaults()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                        <i class="fas fa-magic mr-1"></i>Rellenar valores normales
                    </button>
                    <button type="button" onclick="loadPreviousFundoscopy()" class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded">
                        <i class="fas fa-history mr-1"></i>Cargar último registro
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- OD -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-blue-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OD</span>
                        <span class="font-semibold">Ojo Derecho</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vítreo</label>
                            <input type="text" name="fundoscopy_od_vitreous"
                                   value="{% if history %}{{ history.fundoscopy_od_vitreous }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Disco Óptico</label>
                            <input type="text" name="fundoscopy_od_optic_disc"
                                   value="{% if history %}{{ history.fundoscopy_od_optic_disc }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Rosado, bien definido">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Relación Copa/Disco</label>
                            <input type="text" name="fundoscopy_od_cup_disc_ratio"
                                   value="{% if history %}{{ history.fundoscopy_od_cup_disc_ratio }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="0.3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Mácula</label>
                            <input type="text" name="fundoscopy_od_macula"
                                   value="{% if history %}{{ history.fundoscopy_od_macula }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Reflejo foveolar presente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vasos</label>
                            <input type="text" name="fundoscopy_od_vessels"
                                   value="{% if history %}{{ history.fundoscopy_od_vessels }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Normales, AV 2:3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Retina/Periferia</label>
                            <input type="text" name="fundoscopy_od_retina"
                                   value="{% if history %}{{ history.fundoscopy_od_retina }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Aplicada, sin lesiones">
                        </div>
                    </div>
                </div>
                
                <!-- OS -->
                <div class="bg-white p-3 rounded">
                    <div class="flex items-center mb-3">
                        <span class="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 font-bold">OS</span>
                        <span class="font-semibold">Ojo Izquierdo</span>
                    </div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vítreo</label>
                            <input type="text" name="fundoscopy_os_vitreous"
                                   value="{% if history %}{{ history.fundoscopy_os_vitreous }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Transparente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Disco Óptico</label>
                            <input type="text" name="fundoscopy_os_optic_disc"
                                   value="{% if history %}{{ history.fundoscopy_os_optic_disc }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Rosado, bien definido">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Relación Copa/Disco</label>
                            <input type="text" name="fundoscopy_os_cup_disc_ratio"
                                   value="{% if history %}{{ history.fundoscopy_os_cup_disc_ratio }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="0.3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Mácula</label>
                            <input type="text" name="fundoscopy_os_macula"
                                   value="{% if history %}{{ history.fundoscopy_os_macula }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Reflejo foveolar presente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Vasos</label>
                            <input type="text" name="fundoscopy_os_vessels"
                                   value="{% if history %}{{ history.fundoscopy_os_vessels }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Normales, AV 2:3">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Retina/Periferia</label>
                            <input type="text" name="fundoscopy_os_retina"
                                   value="{% if history %}{{ history.fundoscopy_os_retina }}{% endif %}"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500"
                                   placeholder="Aplicada, sin lesiones">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DIAGNÓSTICO -->
        <div class="bg-red-50 border-l-4 border-red-600 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-stethoscope text-red-600 mr-2"></i>
                DIAGNÓSTICO
            </h3>
            
            <div class="space-y-4">
                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Diagnósticos Comunes
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_myopia" {% if history.dx_myopia %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Miopía</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_hyperopia" {% if history.dx_hyperopia %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Hipermetropía</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_astigmatism" {% if history.dx_astigmatism %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Astigmatismo</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="dx_presbyopia" {% if history.dx_presbyopia %}checked{% endif %}
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-sm text-gray-700">Presbicia</span>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Diagnóstico Detallado
                    </label>
                    <textarea name="diagnosis" rows="2"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                              placeholder="Descripción completa del diagnóstico...">{% if history %}{{ history.diagnosis }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- OBSERVACIONES / CONDUCTA -->
        <div class="bg-pink-50 border-l-4 border-pink-600 rounded-lg p-5 mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-clipboard-list text-pink-600 mr-2"></i>
                OBSERVACIONES / CONDUCTA
            </h3>
            
            <div class="space-y-4">
                <!-- Prescripción -->
                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-glasses mr-1"></i> Prescripción
                    </label>
                    <div class="flex flex-wrap gap-4 mb-3">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="prescription_glasses" {% if history.prescription_glasses %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Lentes</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="prescription_contact_lenses" {% if history.prescription_contact_lenses %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Lentes de Contacto</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" name="prescription_medication" {% if history.prescription_medication %}checked{% endif %}
                                   class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                            <span class="text-sm text-gray-700">Medicación</span>
                        </label>
                    </div>

                    <!-- Tipo de lentes, Material y Tratamientos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Tipo de Lentes</label>
                            <select name="lens_type"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% if lens_types %}
                                    {% for lt in lens_types %}
                                    <option value="{{ lt.name }}" {% if history and history.lens_type == lt.name %}selected{% endif %}>{{ lt.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="single" {% if history and history.lens_type == 'single' %}selected{% endif %}>Monofocales</option>
                                    <option value="bifocal" {% if history and history.lens_type == 'bifocal' %}selected{% endif %}>Bifocales</option>
                                    <option value="progressive" {% if history and history.lens_type == 'progressive' %}selected{% endif %}>Progresivos</option>
                                    <option value="occupational" {% if history and history.lens_type == 'occupational' %}selected{% endif %}>Ocupacionales</option>
                                    <option value="reading" {% if history and history.lens_type == 'reading' %}selected{% endif %}>Lectura</option>
                                {% endif %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                Material
                                <button type="button" onclick="openMaterialModal()" class="text-pink-600 hover:text-pink-700 ml-1" title="Agregar nuevo material">
                                    <i class="fas fa-plus-circle"></i>
                                </button>
                            </label>
                            <select name="lens_material" id="lens_material"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                                    onchange="showMaterialDetails(this)">
                                <option value="">Seleccionar...</option>
                                {% for material in lens_materials %}
                                <option value="{{ material.name }}" 
                                        data-description="{{ material.description|default:'' }}"
                                        data-category="{{ material.category|default:'' }}"
                                        {% if history and history.lens_material == material.name %}selected{% endif %}>
                                    {{ material.name }}{% if material.category %} ({{ material.category }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="material-details" class="text-xs"></div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                Tratamientos
                                <button type="button" onclick="openTreatmentModal()" class="text-pink-600 hover:text-pink-700 ml-1" title="Agregar nuevo tratamiento">
                                    <i class="fas fa-plus-circle"></i>
                                </button>
                            </label>
                            <select name="lens_coating" id="lens_coating" multiple
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                                    style="height: 60px;"
                                    onchange="updateSelectedTreatmentsVisual()">
                                {% for coating in lens_coatings %}
                                <option value="{{ coating.name }}" 
                                        data-description="{{ coating.description|default:'' }}"
                                        data-category="{{ coating.category|default:'' }}"
                                        {% if history %}
                                            {% if coating.name in history.lens_coating or coating.name|lower in history.lens_coating|lower %}selected{% endif %}
                                        {% endif %}>
                                    {{ coating.name }}{% if coating.category %} - {{ coating.category }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle"></i> Mantén Ctrl/Cmd para múltiples
                            </p>
                            <!-- Área de tratamientos seleccionados con botones X -->
                            <div id="selected-treatments-visual" class="mt-2 space-y-2"></div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Marca de Lentes (Opcional)</label>
                            <select name="lens_brand" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% for brand in lens_brands %}
                                <option value="{{ brand.name }}" {% if history and history.lens_brand == brand.name %}selected{% endif %}>{{ brand.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Tipo de Montura (Opcional)</label>
                            <select name="frame_type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% for frame in frame_types %}
                                <option value="{{ frame.name }}" {% if history and history.frame_type == frame.name %}selected{% endif %}>{{ frame.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Medicamentos -->
                <div class="bg-white p-3 rounded">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-pills mr-1"></i> Medicamentos
                        <button type="button" onclick="openMedicationModal()" class="text-pink-600 hover:text-pink-700 ml-1 text-xs" title="Agregar nuevo medicamento">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                    </label>
                    
                    <!-- Área de medicamentos seleccionados -->
                    <div class="mb-3">
                        <p class="text-xs font-medium text-gray-600 mb-1">Medicamentos seleccionados:</p>
                        <div id="selected-medications-visual" class="space-y-2 min-h-[50px] p-2 bg-gray-50 rounded border border-gray-200"></div>
                    </div>
                    
                    <!-- Listado de medicamentos disponibles -->
                    <p class="text-xs font-medium text-gray-600 mb-1">Seleccionar de la lista:</p>
                    <select id="medication_select_visual" multiple
                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 mb-2"
                            style="height: 100px;"
                            onchange="updateSelectedMedicationsVisual()">
                        <option value="">-- Seleccionar medicamento --</option>
                        {% for med in medications %}
                        <option value="{{ med.name }}" 
                                data-description="{{ med.description|default:'' }}"
                                data-dosage="{{ med.dosage|default:'' }}"
                                data-frequency="{{ med.frequency|default:'' }}"
                                data-duration="{{ med.duration|default:'' }}"
                                data-route="{{ med.get_administration_route_display|default:'' }}">
                            {{ med.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-info-circle"></i> Mantén Ctrl/Cmd para seleccionar múltiples medicamentos
                    </p>
                    
                    <!-- Campo oculto para enviar los datos -->
                    <textarea name="medication_details" id="medication_details" rows="3" class="hidden">{% if history %}{{ history.medication_details }}{% endif %}</textarea>
                </div>

                <!-- 🔍 LENTES DE CONTACTO (Opcional) -->
                <div class="bg-white p-3 rounded shadow-sm border-l-4 border-teal-500">
                    <h4 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-eye text-teal-600 mr-2"></i> Lentes de Contacto <span class="text-xs text-gray-500 ml-2 font-normal">(Opcional)</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Tipo de LC</label>
                            <select name="contact_lens_type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% for cl in contact_lens_types %}
                                <option value="{{ cl.name }}" {% if history and history.contact_lens_type == cl.name %}selected{% endif %}>{{ cl.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Marca de LC</label>
                            <select name="contact_lens_brand" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% for brand in contact_lens_brands %}
                                <option value="{{ brand.name }}" {% if history and history.contact_lens_brand == brand.name %}selected{% endif %}>{{ brand.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Material LC</label>
                            <select name="contact_lens_material" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% for mat in contact_lens_materials %}
                                <option value="{{ mat.name }}" {% if history and history.contact_lens_material == mat.name %}selected{% endif %}>{{ mat.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Régimen de Uso</label>
                            <select name="contact_lens_wearing" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% for wear in contact_lens_wearings %}
                                <option value="{{ wear.name }}" {% if history and history.contact_lens_wearing == wear.name %}selected{% endif %}>{{ wear.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 🎯 TRATAMIENTOS Y TERAPIAS (Opcional) -->
                <div class="bg-white p-3 rounded shadow-sm border-l-4 border-indigo-500">
                    <h4 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-heartbeat text-indigo-600 mr-2"></i> Tratamientos y Terapias <span class="text-xs text-gray-500 ml-2 font-normal">(Opcional)</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Terapias Coadyuvantes</label>
                            <select name="therapy" multiple class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500" style="height: 50px;">
                                {% for therapy in therapies %}
                                <option value="{{ therapy.name }}" data-description="{{ therapy.description|default:'' }}" {% if history and history.therapy and therapy.name in history.therapy %}selected{% endif %}>{{ therapy.name }}</option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle"></i> Ctrl+Clic para seleccionar múltiples</p>
                            {% if history and history.therapy %}
                            <div class="mt-2 flex flex-wrap gap-1">
                                {% for item in history.therapy|split:", " %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800">
                                    <i class="fas fa-check-circle mr-1"></i> {{ item }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Terapias Visuales</label>
                            <select name="visual_therapy" multiple class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500" style="height: 50px;">
                                {% for vt in visual_therapies %}
                                <option value="{{ vt.name }}" data-description="{{ vt.description|default:'' }}" {% if history and history.visual_therapy and vt.name in history.visual_therapy %}selected{% endif %}>{{ vt.name }}</option>
                                {% endfor %}
                            </select>
                            {% if history and history.visual_therapy %}
                            <div class="mt-2 flex flex-wrap gap-1">
                                {% for item in history.visual_therapy|split:", " %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800">
                                    <i class="fas fa-check-circle mr-1"></i> {{ item }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 📋 EXÁMENES COMPLEMENTARIOS (Opcional) -->
                <div class="bg-white p-3 rounded shadow-sm border-l-4 border-yellow-500">
                    <h4 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-microscope text-yellow-600 mr-2"></i> Exámenes Complementarios <span class="text-xs text-gray-500 ml-2 font-normal">(Opcional)</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Exámenes Especializados</label>
                            <select name="complementary_exam" multiple class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500" style="height: 50px;">
                                {% for exam in complementary_exams %}
                                <option value="{{ exam.name }}" data-description="{{ exam.description|default:'' }}" {% if history and history.complementary_exam and exam.name in history.complementary_exam %}selected{% endif %}>{{ exam.name }}</option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle"></i> OCT, Campo Visual, Topografía, etc.</p>
                            {% if history and history.complementary_exam %}
                            <div class="mt-2 flex flex-wrap gap-1">
                                {% for item in history.complementary_exam|split:", " %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-microscope mr-1"></i> {{ item }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Exámenes de Laboratorio</label>
                            <select name="lab_test" multiple class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500" style="height: 50px;">
                                {% for lab in lab_tests %}
                                <option value="{{ lab.name }}" data-description="{{ lab.description|default:'' }}" {% if history and history.lab_test and lab.name in history.lab_test %}selected{% endif %}>{{ lab.name }}</option>
                                {% endfor %}
                            </select>
                            {% if history and history.lab_test %}
                            <div class="mt-2 flex flex-wrap gap-1">
                                {% for item in history.lab_test|split:", " %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-vial mr-1"></i> {{ item }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 🎓 RECOMENDACIONES Y SEGUIMIENTO -->
                <div class="bg-white p-3 rounded shadow-sm border-l-4 border-green-500">
                    <h4 class="text-sm font-semibold text-gray-800 mb-2 flex items-center">
                        <i class="fas fa-lightbulb text-green-600 mr-2"></i> Recomendaciones y Seguimiento
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Recomendaciones</label>
                            <select name="recommendation" multiple class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500" style="height: 50px;">
                                {% for rec in recommendations %}
                                <option value="{{ rec.name }}" data-description="{{ rec.description|default:'' }}" {% if history and history.recommendation and rec.name in history.recommendation %}selected{% endif %}>{{ rec.name }}</option>
                                {% endfor %}
                            </select>
                            {% if history and history.recommendation %}
                            <div class="mt-2 flex flex-wrap gap-1">
                                {% for item in history.recommendation|split:", " %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">
                                    <i class="fas fa-lightbulb mr-1"></i> {{ item }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Motivo de Seguimiento</label>
                            <select name="follow_up_reason" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                                <option value="">Seleccionar...</option>
                                {% for reason in follow_up_reasons %}
                                <option value="{{ reason.name }}" {% if history and history.follow_up_reason == reason.name %}selected{% endif %}>{{ reason.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Remisión a Especialista (Opcional)</label>
                        <select name="referral_specialty" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                            <option value="">No requiere remisión</option>
                            {% for spec in referral_specialties %}
                            <option value="{{ spec.name }}" {% if history and history.referral_specialty == spec.name %}selected{% endif %}>{{ spec.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- 📝 OBSERVACIONES GENERALES -->
                <div class="bg-white p-3 rounded shadow-sm">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-comment-dots mr-1"></i> Observaciones Generales / Plan de Tratamiento
                    </label>
                    <textarea name="treatment_plan" rows="3"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                              placeholder="Indicaciones, recomendaciones generales, plan de seguimiento, fecha próxima cita...">{% if history %}{{ history.treatment_plan }}{% endif %}</textarea>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex gap-3 pt-4 border-t">
            <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors font-medium">
                <i class="fas fa-save mr-2"></i>
                {% if history %}Actualizar Examen Visual{% else %}Guardar Examen Visual{% endif %}
            </button>
            <button type="button" onclick="clearLocalStorageDraft(); showRestorationNotification('✓ Borrador eliminado');"
                    class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors font-medium" title="Limpiar borrador guardado">
                <i class="fas fa-eraser mr-2"></i>Limpiar Borrador
            </button>
            <a href="{% url 'dashboard:patient_detail' patient.id %}" 
               class="px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors font-medium">
                <i class="fas fa-times mr-2"></i>Cancelar
            </a>
        </div>

        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Autoguardado activado:</strong> Los datos se guardan automáticamente cada 10 segundos en tu navegador. Si cierras accidentalmente la página, los datos se restaurarán al volver a abrirla.
            </p>
        </div>
    </form>
</div>

<script>
// ============ PRE-CARGAR DATOS AL EDITAR ============
{% if history %}
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔍 Pre-cargando datos del examen ID: {{ history.id }}');
    console.log('📊 DEBUG - Objeto History completo:');
    console.log('  - Doctor: {{ history.doctor }}');
    console.log('  - Fecha: {{ history.date }}');
    console.log('📊 Datos de Refracción en context:');
    console.log('  - Esfera OD: "{{ history.refraction_od_sphere }}" (tipo: {{ history.refraction_od_sphere|default:"vacío" }})');
    console.log('  - Esfera OI: "{{ history.refraction_os_sphere }}" (tipo: {{ history.refraction_os_sphere|default:"vacío" }})');
    console.log('  - Cilindro OD: "{{ history.refraction_od_cylinder }}" (None? {% if history.refraction_od_cylinder is None %}SI{% else %}NO{% endif %})');
    console.log('  - Cilindro OI: "{{ history.refraction_os_cylinder }}" (None? {% if history.refraction_os_cylinder is None %}SI{% else %}NO{% endif %})');
    console.log('  - Eje OD: "{{ history.refraction_od_axis }}" (None? {% if history.refraction_od_axis is None %}SI{% else %}NO{% endif %})');
    console.log('  - Eje OI: "{{ history.refraction_os_axis }}" (None? {% if history.refraction_os_axis is None %}SI{% else %}NO{% endif %})');
    console.log('  - ADD OD: "{{ history.refraction_od_add }}" (None? {% if history.refraction_od_add is None %}SI{% else %}NO{% endif %})');
    console.log('  - ADD OI: "{{ history.refraction_os_add }}" (None? {% if history.refraction_os_add is None %}SI{% else %}NO{% endif %})');
    console.log('  - PD OD: "{{ history.pd_od }}"');
    console.log('  - PD OI: "{{ history.pd_os }}"');
    console.log('📊 Agudeza Visual:');
    console.log('  - VA OD SC: "{{ history.va_od_sc_distance }}"');
    console.log('  - VA OI SC: "{{ history.va_os_sc_distance }}"');
    console.log('  - VA OD CC: "{{ history.va_od_cc_distance }}"');
    console.log('  - VA OI CC: "{{ history.va_os_cc_distance }}"');
    
    // Esperar un momento adicional para asegurar que el DOM esté completamente listo
    setTimeout(function() {
        console.log('🔄 Iniciando carga de datos...');
        
        // Agudeza Visual
        {% if history.va_od_sc_distance %}
        var va_od_sc = document.getElementById('va_od_sc');
        if (va_od_sc) va_od_sc.value = "{{ history.va_od_sc_distance }}";
        {% endif %}
        {% if history.va_os_sc_distance %}
        var va_os_sc = document.getElementById('va_os_sc');
        if (va_os_sc) va_os_sc.value = "{{ history.va_os_sc_distance }}";
        {% endif %}
        {% if history.va_ou_distance %}
        var va_ou_sc = document.getElementById('va_ou_sc');
        if (va_ou_sc) va_ou_sc.value = "{{ history.va_ou_distance }}";
        {% endif %}
        {% if history.va_od_cc_distance %}
        var va_od_cc = document.getElementById('va_od_cc');
        if (va_od_cc) va_od_cc.value = "{{ history.va_od_cc_distance }}";
        {% endif %}
        {% if history.va_os_cc_distance %}
        var va_os_cc = document.getElementById('va_os_cc');
        if (va_os_cc) va_os_cc.value = "{{ history.va_os_cc_distance }}";
        {% endif %}
        {% if history.va_ou_cc_distance %}
        var va_ou_cc = document.getElementById('va_ou_cc');
        if (va_ou_cc) va_ou_cc.value = "{{ history.va_ou_cc_distance }}";
        {% endif %}
        
        // Refracción OD - Los valores ya están en el HTML con el atributo value, 
        // solo forzamos la carga si por alguna razón no se cargaron
        var sph_od = document.getElementById('refraction_od_sphere');
        if (sph_od && !sph_od.value && "{{ history.refraction_od_sphere|default:'' }}") {
            sph_od.value = "{{ history.refraction_od_sphere|default:'' }}";
        }
        
        var cyl_od = document.getElementById('refraction_od_cylinder');
        if (cyl_od && !cyl_od.value && "{{ history.refraction_od_cylinder|default:'' }}") {
            cyl_od.value = "{{ history.refraction_od_cylinder|default:'' }}";
        }
        
        var axis_od = document.getElementById('refraction_od_axis');
        if (axis_od && !axis_od.value && "{{ history.refraction_od_axis|default:'' }}") {
            axis_od.value = "{{ history.refraction_od_axis|default:'' }}";
        }
        
        var add_od = document.getElementById('refraction_od_add');
        if (add_od && !add_od.value && "{{ history.refraction_od_add|default:'' }}") {
            add_od.value = "{{ history.refraction_od_add|default:'' }}";
        }
        
        {% if history.refraction_od_prism %}
        var prism_od = document.getElementById('refraction_od_prism');
        if (prism_od && !prism_od.value) prism_od.value = "{{ history.refraction_od_prism }}";
        {% endif %}
        
        // DNP ya se carga directamente desde el template con el atributo value
        
        // Refracción OS - Los valores ya están en el HTML con el atributo value
        var sph_os = document.getElementById('refraction_os_sphere');
        if (sph_os && !sph_os.value && "{{ history.refraction_os_sphere|default:'' }}") {
            sph_os.value = "{{ history.refraction_os_sphere|default:'' }}";
        }
        
        var cyl_os = document.getElementById('refraction_os_cylinder');
        if (cyl_os && !cyl_os.value && "{{ history.refraction_os_cylinder|default:'' }}") {
            cyl_os.value = "{{ history.refraction_os_cylinder|default:'' }}";
        }
        
        var axis_os = document.getElementById('refraction_os_axis');
        if (axis_os && !axis_os.value && "{{ history.refraction_os_axis|default:'' }}") {
            axis_os.value = "{{ history.refraction_os_axis|default:'' }}";
        }
        
        var add_os = document.getElementById('refraction_os_add');
        if (add_os && !add_os.value && "{{ history.refraction_os_add|default:'' }}") {
            add_os.value = "{{ history.refraction_os_add|default:'' }}";
        }
        
        {% if history.refraction_os_prism %}
        var prism_os = document.getElementById('refraction_os_prism');
        if (prism_os && !prism_os.value) prism_os.value = "{{ history.refraction_os_prism }}";
        {% endif %}
        
        // DNP ya se carga directamente desde el template con el atributo value
        
        // Queratometría OD
        {% if history.keratometry_od_k1 %}
        var k1_od = document.querySelector('input[name="keratometry_od_k1"]');
        if (k1_od && !k1_od.value) k1_od.value = "{{ history.keratometry_od_k1 }}";
        {% endif %}
        {% if history.keratometry_od_k2 %}
        var k2_od = document.querySelector('input[name="keratometry_od_k2"]');
        if (k2_od && !k2_od.value) k2_od.value = "{{ history.keratometry_od_k2 }}";
        {% endif %}
        {% if history.keratometry_od_k1_axis %}
        var kaxis_od = document.querySelector('input[name="keratometry_od_axis"]');
        if (kaxis_od && !kaxis_od.value) kaxis_od.value = "{{ history.keratometry_od_k1_axis }}";
        {% endif %}
        
        // Queratometría OS
        {% if history.keratometry_os_k1 %}
        var k1_os = document.querySelector('input[name="keratometry_os_k1"]');
        if (k1_os && !k1_os.value) k1_os.value = "{{ history.keratometry_os_k1 }}";
        {% endif %}
        {% if history.keratometry_os_k2 %}
        var k2_os = document.querySelector('input[name="keratometry_os_k2"]');
        if (k2_os && !k2_os.value) k2_os.value = "{{ history.keratometry_os_k2 }}";
        {% endif %}
        {% if history.keratometry_os_k1_axis %}
        var kaxis_os = document.querySelector('input[name="keratometry_os_axis"]');
        if (kaxis_os && !kaxis_os.value) kaxis_os.value = "{{ history.keratometry_os_k1_axis }}";
        {% endif %}
        
        // Observaciones
        {% if history.observations %}
        var obs = document.querySelector('textarea[name="exam_notes"]');
        if (obs) obs.value = `{{ history.observations|escapejs }}`;
        {% endif %}
        
        // Verificar valores cargados
        console.log('🔍 Verificando valores cargados en campos:');
        console.log('  - refraction_od_sphere:', document.getElementById('refraction_od_sphere')?.value);
        console.log('  - refraction_os_sphere:', document.getElementById('refraction_os_sphere')?.value);
        console.log('  - refraction_od_cylinder:', document.getElementById('refraction_od_cylinder')?.value);
        console.log('  - refraction_os_cylinder:', document.getElementById('refraction_os_cylinder')?.value);
        console.log('  - refraction_od_axis:', document.getElementById('refraction_od_axis')?.value);
        console.log('  - refraction_os_axis:', document.getElementById('refraction_os_axis')?.value);
        console.log('  - refraction_od_add:', document.getElementById('refraction_od_add')?.value);
        console.log('  - refraction_os_add:', document.getElementById('refraction_os_add')?.value);
        console.log('  - va_od_cc:', document.getElementById('va_od_cc')?.value);
        console.log('  - va_os_cc:', document.getElementById('va_os_cc')?.value);
        
        // Actualizar gráficos después de cargar datos (con más delay)
        setTimeout(function() {
            try {
                if (typeof updateRadarChart === 'function') updateRadarChart();
                if (typeof updatePolarChart === 'function') updatePolarChart();
                if (typeof updateSeverityIndicators === 'function') updateSeverityIndicators();
                console.log('✅ Gráficos actualizados');
            } catch (e) {
                console.log('⚠️ Error actualizando gráficos:', e.message);
            }
        }, 500);
        
        console.log('✅ Pre-carga completada');
    }, 100); // Delay de 100ms para asegurar que el DOM esté listo
});
{% endif %}

// ============ FUNCIONES DE UTILIDAD ============

// Validar entrada de esfera (permite números y N/A)
function validateSphereInput(input) {
    // Permitir cualquier texto: N, NLP, CD, PL, números como +2.00, -1.50, etc.
    // No se aplica ninguna restricción - el campo acepta cualquier entrada
    input.classList.remove('border-red-500');
}

// Establecer valor en un campo específico
function setValue(fieldId, value) {
    document.getElementById(fieldId).value = value;
}

// Establecer el mismo valor en todos los campos de agudeza visual
function setAllVA(value) {
    ['va_od_sc', 'va_os_sc', 'va_ou_sc', 'va_od_cc', 'va_os_cc', 'va_ou_cc'].forEach(id => {
        document.getElementById(id).value = value;
    });
    showNotification('Agudeza visual establecida a ' + value, 'success');
}

// Limpiar todos los campos de agudeza visual
function clearVA() {
    ['va_od_sc', 'va_os_sc', 'va_ou_sc', 'va_od_cc', 'va_os_cc', 'va_ou_cc'].forEach(id => {
        document.getElementById(id).value = '';
    });
    showNotification('Agudeza visual limpiada', 'info');
}

// Copiar valores de refracción de OD a OI
function copyODtoOI() {
    const odFields = ['refraction_od_sphere', 'refraction_od_cylinder', 'refraction_od_axis', 
                      'refraction_od_add', 'refraction_od_dnp'];
    const oiFields = ['refraction_os_sphere', 'refraction_os_cylinder', 'refraction_os_axis', 
                      'refraction_os_add', 'refraction_os_dnp'];
    
    odFields.forEach((odField, index) => {
        const odValue = document.getElementsByName(odField)[0].value;
        if (odValue) {
            document.getElementsByName(oiFields[index])[0].value = odValue;
        }
    });
    
    showNotification('Valores copiados de OD a OI', 'success');
}

// Establecer valores en Plano (0.00)
function setPlano() {
    ['refraction_od_sphere', 'refraction_od_cylinder', 'refraction_os_sphere', 'refraction_os_cylinder'].forEach(name => {
        document.getElementsByName(name)[0].value = '0.00';
    });
    ['refraction_od_axis', 'refraction_os_axis'].forEach(name => {
        document.getElementsByName(name)[0].value = '0';
    });
    showNotification('Refracción establecida en Plano', 'success');
}

// Limpiar todos los campos de refracción
function clearRefraction() {
    ['refraction_od_sphere', 'refraction_od_cylinder', 'refraction_od_axis', 'refraction_od_add', 'refraction_od_dnp',
     'refraction_os_sphere', 'refraction_os_cylinder', 'refraction_os_axis', 'refraction_os_add', 'refraction_os_dnp'].forEach(name => {
        document.getElementsByName(name)[0].value = '';
    });
    showNotification('Refracción limpiada', 'info');
}

// Rellenar campo con N/A
function fillWithNA(fieldName) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (field && !field.value.trim()) {
        field.value = 'N/A';
        field.focus();
        field.blur(); // Trigger autosave
    }
}

// Rellenar solo ANTECEDENTES GENERALES con N/A
function fillGeneralHistoryWithNA() {
    const fieldsToFill = [
        'pathological_history',
        'pharmacological_history',
        'surgical_history',
        'allergic_history',
        'trauma_history',
        'other_general_history'
    ];
    
    let filledCount = 0;
    
    fieldsToFill.forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field && !field.value.trim()) {
            field.value = 'N/A';
            filledCount++;
            
            // Efecto visual
            field.classList.add('bg-amber-100', 'transition-all', 'duration-300');
            setTimeout(() => {
                field.classList.remove('bg-amber-100');
            }, 1000);
        }
    });
    
    if (filledCount > 0) {
        showNotification(`✅ ${filledCount} campo(s) de Antecedentes Generales rellenado(s) con "N/A"`, 'success');
        // Trigger autosave
        saveFormDataToLocalStorage();
    } else {
        showNotification('ℹ️ No hay campos vacíos en Antecedentes Generales', 'info');
    }
}

// Rellenar solo ANTECEDENTES OCULARES con N/A
function fillOcularHistoryWithNA() {
    const fieldsToFill = [
        'ocular_pathological_history',
        'ocular_pharmacological_history',
        'ocular_surgical_history',
        'ocular_trauma_history',
        'lensometry_notes'
    ];
    
    let filledCount = 0;
    
    fieldsToFill.forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field && !field.value.trim()) {
            field.value = 'N/A';
            filledCount++;
            
            // Efecto visual
            field.classList.add('bg-teal-100', 'transition-all', 'duration-300');
            setTimeout(() => {
                field.classList.remove('bg-teal-100');
            }, 1000);
        }
    });
    
    if (filledCount > 0) {
        showNotification(`✅ ${filledCount} campo(s) de Antecedentes Oculares rellenado(s) con "N/A"`, 'success');
        // Trigger autosave
        saveFormDataToLocalStorage();
    } else {
        showNotification('ℹ️ No hay campos vacíos en Antecedentes Oculares', 'info');
    }
}

// Rellenar TODOS los campos textarea vacíos con N/A
function fillAllWithNA() {
    if (!confirm('¿Desea rellenar TODOS los campos de texto vacíos con "N/A"?\n\nEsto incluye:\n- Anamnesis\n- Antecedentes\n- Segmento Anterior/Posterior\n- Diagnóstico\n- Observaciones\n\nLos campos que ya tienen datos NO serán afectados.')) {
        return;
    }
    
    let filledCount = 0;
    
    // Lista de campos a rellenar con N/A
    const fieldsToFill = [
        // Anamnesis
        'chief_complaint',
        'current_illness',
        
        // Antecedentes Generales
        'pathological_history',
        'pharmacological_history',
        'allergies',
        'other_history',
        
        // Antecedentes Oculares
        'ocular_pathology',
        'ocular_pharmacology',
        
        // Segmento Anterior - OD
        'biomicroscopy_od_lids',
        'biomicroscopy_od_conjunctiva',
        'biomicroscopy_od_cornea',
        'biomicroscopy_od_anterior_chamber',
        'biomicroscopy_od_iris',
        'biomicroscopy_od_lens',
        'biomicroscopy_od_pupil',
        
        // Segmento Anterior - OS
        'biomicroscopy_os_lids',
        'biomicroscopy_os_conjunctiva',
        'biomicroscopy_os_cornea',
        'biomicroscopy_os_anterior_chamber',
        'biomicroscopy_os_iris',
        'biomicroscopy_os_lens',
        'biomicroscopy_os_pupil',
        
        // Segmento Posterior - OD
        'fundoscopy_od_optic_disc',
        'fundoscopy_od_macula',
        'fundoscopy_od_vessels',
        'fundoscopy_od_periphery',
        
        // Segmento Posterior - OS
        'fundoscopy_os_optic_disc',
        'fundoscopy_os_macula',
        'fundoscopy_os_vessels',
        'fundoscopy_os_periphery',
        
        // Diagnóstico
        'diagnosis_text',
        'treatment_plan',
        
        // Observaciones y Conducta
        'exam_notes',
        'recommendations_text',
        'additional_notes'
    ];
    
    fieldsToFill.forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field && !field.value.trim()) {
            field.value = 'N/A';
            filledCount++;
            
            // Efecto visual
            field.classList.add('bg-yellow-100', 'transition-all', 'duration-300');
            setTimeout(() => {
                field.classList.remove('bg-yellow-100');
            }, 1000);
        }
    });
    
    if (filledCount > 0) {
        showNotification(`✅ ${filledCount} campo(s) rellenado(s) con "N/A"`, 'success');
        // Trigger autosave
        saveFormDataToLocalStorage();
    } else {
        showNotification('ℹ️ No hay campos vacíos para rellenar', 'info');
    }
}

// Rellenar valores normales para Segmento Anterior (Biomicroscopía)
function fillAnteriorSegmentDefaults() {
    const defaults = {
        'biomicroscopy_od_lids': 'Normal',
        'biomicroscopy_od_conjunctiva': 'Normal',
        'biomicroscopy_od_cornea': 'Transparente',
        'biomicroscopy_od_anterior_chamber': 'Formada, profunda',
        'biomicroscopy_od_iris': 'Normal',
        'biomicroscopy_od_lens': 'Transparente',
        'biomicroscopy_od_pupil': 'Redonda, reactiva',
        'biomicroscopy_os_lids': 'Normal',
        'biomicroscopy_os_conjunctiva': 'Normal',
        'biomicroscopy_os_cornea': 'Transparente',
        'biomicroscopy_os_anterior_chamber': 'Formada, profunda',
        'biomicroscopy_os_iris': 'Normal',
        'biomicroscopy_os_lens': 'Transparente',
        'biomicroscopy_os_pupil': 'Redonda, reactiva'
    };
    
    let filledCount = 0;
    Object.keys(defaults).forEach(fieldName => {
        const input = document.querySelector(`input[name="${fieldName}"]`);
        if (input && !input.value.trim()) {
            input.value = defaults[fieldName];
            filledCount++;
            input.classList.add('bg-green-100');
            setTimeout(() => {
                input.classList.remove('bg-green-100');
            }, 1000);
        }
    });
    
    if (filledCount > 0) {
        showRestorationNotification(`✓ ${filledCount} campos rellenados con valores normales`);
    }
}

// Rellenar valores normales para Segmento Posterior (Fondo de Ojo)
function fillPosteriorSegmentDefaults() {
    const defaults = {
        'fundoscopy_od_vitreous': 'Transparente',
        'fundoscopy_od_optic_disc': 'Rosado, bien definido',
        'fundoscopy_od_cup_disc_ratio': '0.3',
        'fundoscopy_od_macula': 'Reflejo foveolar presente',
        'fundoscopy_od_vessels': 'Normales, AV 2:3',
        'fundoscopy_od_retina': 'Aplicada, sin lesiones',
        'fundoscopy_os_vitreous': 'Transparente',
        'fundoscopy_os_optic_disc': 'Rosado, bien definido',
        'fundoscopy_os_cup_disc_ratio': '0.3',
        'fundoscopy_os_macula': 'Reflejo foveolar presente',
        'fundoscopy_os_vessels': 'Normales, AV 2:3',
        'fundoscopy_os_retina': 'Aplicada, sin lesiones'
    };
    
    let filledCount = 0;
    Object.keys(defaults).forEach(fieldName => {
        const input = document.querySelector(`input[name="${fieldName}"]`);
        if (input && !input.value.trim()) {
            input.value = defaults[fieldName];
            filledCount++;
            input.classList.add('bg-indigo-100');
            setTimeout(() => {
                input.classList.remove('bg-indigo-100');
            }, 1000);
        }
    });
    
    if (filledCount > 0) {
        showRestorationNotification(`✓ ${filledCount} campos rellenados con valores normales`);
    }
}

// Cargar datos previos del fondo de ojo
function loadPreviousFundoscopy() {
    fetch(`/dashboard/patients/{{ patient.id }}/clinical-history/latest-fundoscopy/`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.fundoscopy) {
                // OD
                if (data.fundoscopy.od_vitreous) document.querySelector('input[name="fundoscopy_od_vitreous"]').value = data.fundoscopy.od_vitreous;
                if (data.fundoscopy.od_optic_disc) document.querySelector('input[name="fundoscopy_od_optic_disc"]').value = data.fundoscopy.od_optic_disc;
                if (data.fundoscopy.od_cup_disc_ratio) document.querySelector('input[name="fundoscopy_od_cup_disc_ratio"]').value = data.fundoscopy.od_cup_disc_ratio;
                if (data.fundoscopy.od_macula) document.querySelector('input[name="fundoscopy_od_macula"]').value = data.fundoscopy.od_macula;
                if (data.fundoscopy.od_vessels) document.querySelector('input[name="fundoscopy_od_vessels"]').value = data.fundoscopy.od_vessels;
                if (data.fundoscopy.od_retina) document.querySelector('input[name="fundoscopy_od_retina"]').value = data.fundoscopy.od_retina;
                
                // OS
                if (data.fundoscopy.os_vitreous) document.querySelector('input[name="fundoscopy_os_vitreous"]').value = data.fundoscopy.os_vitreous;
                if (data.fundoscopy.os_optic_disc) document.querySelector('input[name="fundoscopy_os_optic_disc"]').value = data.fundoscopy.os_optic_disc;
                if (data.fundoscopy.os_cup_disc_ratio) document.querySelector('input[name="fundoscopy_os_cup_disc_ratio"]').value = data.fundoscopy.os_cup_disc_ratio;
                if (data.fundoscopy.os_macula) document.querySelector('input[name="fundoscopy_os_macula"]').value = data.fundoscopy.os_macula;
                if (data.fundoscopy.os_vessels) document.querySelector('input[name="fundoscopy_os_vessels"]').value = data.fundoscopy.os_vessels;
                if (data.fundoscopy.os_retina) document.querySelector('input[name="fundoscopy_os_retina"]').value = data.fundoscopy.os_retina;
                
                showRestorationNotification('✓ Datos del fondo de ojo cargados exitosamente');
            } else {
                console.log(data.message || 'No hay registros previos de fondo de ojo');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// Mostrar detalles del material seleccionado
function showMaterialDetails(select) {
    const option = select.options[select.selectedIndex];
    const detailsDiv = document.getElementById('material-details');
    
    if (!detailsDiv) return;
    
    if (option.value) {
        const description = option.getAttribute('data-description');
        const category = option.getAttribute('data-category');
        let details = '';
        
        if (category && category !== 'None' && category !== '') {
            details += `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-2"><i class="fas fa-tag mr-1"></i>${category}</span>`;
        }
        if (description && description !== 'None' && description !== '') {
            details += `<span class="text-gray-600"><i class="fas fa-info-circle mr-1"></i>${description}</span>`;
        }
        
        if (details) {
            detailsDiv.innerHTML = details;
            detailsDiv.classList.remove('hidden');
            detailsDiv.classList.add('mt-2', 'p-2', 'bg-blue-50', 'rounded', 'border', 'border-blue-200');
        } else {
            detailsDiv.classList.add('hidden');
        }
    } else {
        detailsDiv.classList.add('hidden');
    }
}

// Actualizar tratamientos seleccionados con detalles y botones X
function updateSelectedTreatmentsVisual() {
    const select = document.getElementById('lens_coating');
    const container = document.getElementById('selected-treatments-visual');
    
    if (!select || !container) return;
    
    container.innerHTML = '';
    
    const selectedOptions = Array.from(select.selectedOptions).filter(opt => opt.value !== '');
    
    selectedOptions.forEach(option => {
        const description = option.getAttribute('data-description');
        const category = option.getAttribute('data-category');
        
        const card = document.createElement('div');
        card.className = 'bg-purple-50 border border-purple-200 rounded p-2 text-xs';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex justify-between items-start';
        
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'flex-1';
        
        const nameP = document.createElement('p');
        nameP.className = 'font-semibold text-purple-900';
        nameP.innerHTML = `<i class="fas fa-shield-alt mr-1"></i>${option.text}`;
        detailsDiv.appendChild(nameP);
        
        if (category && category !== 'None' && category !== '') {
            const categoryP = document.createElement('p');
            categoryP.className = 'text-gray-600';
            categoryP.innerHTML = `<i class="fas fa-tag mr-1"></i>${category}`;
            detailsDiv.appendChild(categoryP);
        }
        
        if (description && description !== 'None' && description !== '') {
            const descP = document.createElement('p');
            descP.className = 'text-gray-600 leading-relaxed';
            descP.innerHTML = `<i class="fas fa-info-circle mr-1"></i>${description}`;
            detailsDiv.appendChild(descP);
        }
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center ml-2 flex-shrink-0';
        removeBtn.title = 'Quitar';
        removeBtn.innerHTML = '<i class="fas fa-times text-sm"></i>';
        removeBtn.onclick = function() { removeTreatmentVisual(option.value); };
        
        contentDiv.appendChild(detailsDiv);
        contentDiv.appendChild(removeBtn);
        card.appendChild(contentDiv);
        container.appendChild(card);
    });
    
    // Si no hay tratamientos seleccionados, mostrar mensaje
    if (selectedOptions.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'text-xs text-gray-500 italic';
        emptyMsg.innerHTML = '<i class="fas fa-arrow-down mr-1"></i>Selecciona tratamientos del listado';
        container.appendChild(emptyMsg);
    }
}

function removeTreatmentVisual(value) {
    const select = document.getElementById('lens_coating');
    if (!select) return;
    
    const option = Array.from(select.options).find(opt => opt.value === value);
    if (option) {
        option.selected = false;
        updateSelectedTreatmentsVisual();
    }
}

// Agregar listener de click además del onchange para mejor UX
document.addEventListener('DOMContentLoaded', function() {
    const treatmentSelect = document.getElementById('lens_coating');
    if (treatmentSelect) {
        // Escuchar clicks en el select
        treatmentSelect.addEventListener('click', function() {
            setTimeout(updateSelectedTreatmentsVisual, 50);
        });
        
        // Escuchar cambios con teclado
        treatmentSelect.addEventListener('keyup', function(e) {
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || e.key === ' ') {
                setTimeout(updateSelectedTreatments, 50);
            }
        });
    }
});

// Mostrar detalles del medicamento seleccionado
function showMedicationDetails(select) {
    const option = select.options[select.selectedIndex];
    const detailsDiv = document.getElementById('medication-details');
    
    if (!detailsDiv) return;
    
    if (option.value) {
        const description = option.getAttribute('data-description');
        const dosage = option.getAttribute('data-dosage');
        const frequency = option.getAttribute('data-frequency');
        const duration = option.getAttribute('data-duration');
        const route = option.getAttribute('data-route');
        
        let details = `<div class="p-2 bg-green-50 rounded border border-green-200">`;
        details += `<div class="font-medium text-green-800"><i class="fas fa-pills mr-1"></i>${option.value}</div>`;
        
        if (dosage && dosage !== 'None' && dosage !== '') {
            details += `<div class="mt-1"><span class="text-gray-500">Dosis:</span> <span class="text-gray-800">${dosage}</span></div>`;
        }
        if (frequency && frequency !== 'None' && frequency !== '') {
            details += `<div class="mt-1"><span class="text-gray-500">Frecuencia:</span> <span class="text-gray-800">${frequency}</span></div>`;
        }
        if (duration && duration !== 'None' && duration !== '') {
            details += `<div class="mt-1"><span class="text-gray-500">Duración:</span> <span class="text-gray-800">${duration}</span></div>`;
        }
        if (route && route !== 'None' && route !== '') {
            details += `<div class="mt-1"><span class="text-gray-500">Vía:</span> <span class="text-gray-800">${route}</span></div>`;
        }
        if (description && description !== 'None' && description !== '') {
            details += `<div class="mt-1 text-xs text-gray-600"><i class="fas fa-info-circle mr-1"></i>${description}</div>`;
        }
        details += `</div>`;
        
        detailsDiv.innerHTML = details;
        detailsDiv.classList.remove('hidden');
    } else {
        detailsDiv.innerHTML = '';
        detailsDiv.classList.add('hidden');
    }
}

// Actualizar medicamentos seleccionados con detalles y botones X
function updateSelectedMedicationsVisual() {
    const select = document.getElementById('medication_select_visual');
    const container = document.getElementById('selected-medications-visual');
    const textarea = document.getElementById('medication_details');
    
    if (!select || !container) return;
    
    container.innerHTML = '';
    
    const selectedOptions = Array.from(select.selectedOptions).filter(opt => opt.value !== '');
    
    // Construir el texto para el textarea
    let medicationText = [];
    
    selectedOptions.forEach(option => {
        const dosage = option.getAttribute('data-dosage');
        const frequency = option.getAttribute('data-frequency');
        const duration = option.getAttribute('data-duration');
        const route = option.getAttribute('data-route');
        
        const card = document.createElement('div');
        card.className = 'bg-pink-50 border border-pink-200 rounded p-2 text-xs';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex justify-between items-start';
        
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'flex-1';
        
        const nameP = document.createElement('p');
        nameP.className = 'font-semibold text-pink-900';
        nameP.innerHTML = `<i class="fas fa-pills mr-1"></i>${option.text}`;
        detailsDiv.appendChild(nameP);
        
        // Construir texto para textarea
        let medText = option.text;
        
        if (dosage && dosage !== 'None' && dosage !== '') {
            const dosageP = document.createElement('p');
            dosageP.className = 'text-gray-600';
            dosageP.innerHTML = `<i class="fas fa-prescription-bottle mr-1"></i>${dosage}`;
            detailsDiv.appendChild(dosageP);
            medText += ` - ${dosage}`;
        }
        if (frequency && frequency !== 'None' && frequency !== '') {
            const freqP = document.createElement('p');
            freqP.className = 'text-gray-600';
            freqP.innerHTML = `<i class="fas fa-clock mr-1"></i>${frequency}`;
            detailsDiv.appendChild(freqP);
            medText += `, ${frequency}`;
        }
        if (duration && duration !== 'None' && duration !== '') {
            const durP = document.createElement('p');
            durP.className = 'text-gray-600';
            durP.innerHTML = `<i class="fas fa-calendar mr-1"></i>${duration}`;
            detailsDiv.appendChild(durP);
            medText += `, ${duration}`;
        }
        if (route && route !== 'None' && route !== '') {
            const routeP = document.createElement('p');
            routeP.className = 'text-gray-600';
            routeP.innerHTML = `<i class="fas fa-syringe mr-1"></i>${route}`;
            detailsDiv.appendChild(routeP);
        }
        
        medicationText.push(medText);
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center ml-2 flex-shrink-0';
        removeBtn.title = 'Quitar';
        removeBtn.innerHTML = '<i class="fas fa-times text-sm"></i>';
        removeBtn.onclick = function() { removeMedicationVisual(option.value); };
        
        contentDiv.appendChild(detailsDiv);
        contentDiv.appendChild(removeBtn);
        card.appendChild(contentDiv);
        container.appendChild(card);
    });
    
    // Actualizar textarea
    if (textarea) {
        textarea.value = medicationText.join('\n');
    }
    
    // Si no hay medicamentos seleccionados, mostrar mensaje
    if (selectedOptions.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.className = 'text-xs text-gray-500 italic';
        emptyMsg.innerHTML = '<i class="fas fa-arrow-down mr-1"></i>Selecciona medicamentos del listado';
        container.appendChild(emptyMsg);
        if (textarea) textarea.value = '';
    }
}

function removeMedicationVisual(value) {
    const select = document.getElementById('medication_select_visual');
    if (!select) return;
    
    const option = Array.from(select.options).find(opt => opt.value === value);
    if (option) {
        option.selected = false;
        updateSelectedMedicationsVisual();
    }
}

// ==================== AUTOGUARDADO LOCAL ====================
const AUTOSAVE_KEY = 'visual_exam_draft_{{ patient.id }}';
const AUTOSAVE_INTERVAL = 10000; // 10 segundos
let autosaveTimer;

// Guardar formulario en LocalStorage
function saveFormToLocalStorage() {
    const form = document.getElementById('visualExamForm');
    const formData = new FormData(form);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        if (key !== 'csrfmiddlewaretoken') {
            data[key] = value;
        }
    }
    
    // Guardar checkboxes
    form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        data[checkbox.name] = checkbox.checked;
    });
    
    // Agregar timestamp
    data._timestamp = new Date().toISOString();
    
    try {
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
        console.log('✓ Autoguardado exitoso:', new Date().toLocaleTimeString());
        showAutosaveIndicator();
    } catch (e) {
        console.error('Error al autoguardar:', e);
    }
}

// Restaurar formulario desde LocalStorage
function loadFormFromLocalStorage() {
    try {
        const savedData = localStorage.getItem(AUTOSAVE_KEY);
        if (!savedData) return false;
        
        const data = JSON.parse(savedData);
        const form = document.getElementById('visualExamForm');
        
        const hasExistingData = {% if history %}true{% else %}false{% endif %};
        
        if (hasExistingData) {
            console.log('✓ Usando datos de la base de datos');
            return false;
        }
        
        let restoredCount = 0;
        Object.keys(data).forEach(key => {
            if (key === '_timestamp') return;
            
            const element = form.querySelector(`[name="${key}"]`);
            if (!element) return;
            
            if (element.type === 'checkbox') {
                if (!element.checked) {
                    element.checked = data[key] === true || data[key] === 'true';
                    restoredCount++;
                }
            } else if (element.type === 'radio') {
                if (!element.checked && element.value === data[key]) {
                    element.checked = true;
                    restoredCount++;
                }
            } else {
                if (!element.value || element.value === '') {
                    element.value = data[key] || '';
                    if (data[key]) restoredCount++;
                }
            }
        });
        
        if (restoredCount > 0) {
            const timestamp = new Date(data._timestamp);
            showRestorationNotification(`${restoredCount} campos restaurados del borrador (${timestamp.toLocaleTimeString()})`);
            console.log(`✓ ${restoredCount} campos restaurados desde localStorage`);
            return true;
        }
        return false;
    } catch (e) {
        console.error('Error al restaurar datos:', e);
        return false;
    }
}

// Limpiar borrador del LocalStorage
function clearLocalStorageDraft() {
    try {
        localStorage.removeItem(AUTOSAVE_KEY);
        console.log('✓ Borrador eliminado');
    } catch (e) {
        console.error('Error al eliminar borrador:', e);
    }
}

// Mostrar indicador visual de autoguardado
function showAutosaveIndicator() {
    let indicator = document.getElementById('autosave-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'autosave-indicator';
        indicator.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
        `;
        indicator.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Guardado automáticamente';
        document.body.appendChild(indicator);
    }
    
    indicator.style.opacity = '1';
    setTimeout(() => {
        indicator.style.opacity = '0';
    }, 2000);
}

// Mostrar notificación de restauración
function showRestorationNotification(message) {
    let indicator = document.getElementById('restoration-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'restoration-indicator';
        indicator.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: #3b82f6;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 300px;
        `;
        document.body.appendChild(indicator);
    }
    
    indicator.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
    indicator.style.opacity = '1';
    
    setTimeout(() => {
        indicator.style.opacity = '0';
    }, 4000);
}

// Configurar autoguardado automático
function setupAutosave() {
    const form = document.getElementById('visualExamForm');
    
    form.addEventListener('input', function() {
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(saveFormToLocalStorage, 2000);
    });
    
    form.addEventListener('change', function(e) {
        if (e.target.type === 'checkbox' || e.target.type === 'radio' || e.target.tagName === 'SELECT') {
            saveFormToLocalStorage();
        }
    });
    
    setInterval(saveFormToLocalStorage, AUTOSAVE_INTERVAL);
    
    form.addEventListener('submit', function() {
        setTimeout(clearLocalStorageDraft, 1000);
    });
}

// Actualizar gráficos visuales en tiempo real
function updateRefractionDisplay() {
    // OD (Ojo Derecho)
    const odSphereInput = document.querySelector('input[name="refraction_od_sphere"]')?.value || '';
    const odSphere = odSphereInput.toUpperCase() === 'N/A' ? 0 : (parseFloat(odSphereInput) || 0);
    const odCyl = parseFloat(document.querySelector('input[name="refraction_od_cylinder"]')?.value) || 0;
    const odAxis = parseFloat(document.querySelector('input[name="refraction_od_axis"]')?.value) || 0;
    const odAV = document.querySelector('input[name="va_od_cc_distance"]')?.value || '--';
    
    // OS (Ojo Izquierdo)
    const osSphereInput = document.querySelector('input[name="refraction_os_sphere"]')?.value || '';
    const osSphere = osSphereInput.toUpperCase() === 'N/A' ? 0 : (parseFloat(osSphereInput) || 0);
    const osCyl = parseFloat(document.querySelector('input[name="refraction_os_cylinder"]')?.value) || 0;
    const osAxis = parseFloat(document.querySelector('input[name="refraction_os_axis"]')?.value) || 0;
    const osAV = document.querySelector('input[name="va_os_cc_distance"]')?.value || '--';
    
    // Actualizar displays OD
    const odSphereDisplay = odSphereInput.toUpperCase() === 'N/A' ? 'N/A' : (odSphere !== 0 ? (odSphere > 0 ? '+' : '') + odSphere.toFixed(2) : '--');
    if (document.getElementById('od-sphere-display')) {
        document.getElementById('od-sphere-display').textContent = odSphereDisplay;
    }
    if (document.getElementById('od-cyl-display')) {
        document.getElementById('od-cyl-display').textContent = odCyl !== 0 ? 'Cil: ' + (odCyl > 0 ? '+' : '') + odCyl.toFixed(2) + ' x ' + odAxis + '°' : '--';
    }
    if (document.getElementById('od-av-display')) {
        document.getElementById('od-av-display').textContent = odAV;
    }
    
    // Actualizar displays OS
    const osSphereDisplay = osSphereInput.toUpperCase() === 'N/A' ? 'N/A' : (osSphere !== 0 ? (osSphere > 0 ? '+' : '') + osSphere.toFixed(2) : '--');
    if (document.getElementById('os-sphere-display')) {
        document.getElementById('os-sphere-display').textContent = osSphereDisplay;
    }
    if (document.getElementById('os-cyl-display')) {
        document.getElementById('os-cyl-display').textContent = osCyl !== 0 ? 'Cil: ' + (osCyl > 0 ? '+' : '') + osCyl.toFixed(2) + ' x ' + osAxis + '°' : '--';
    }
    if (document.getElementById('os-av-display')) {
        document.getElementById('os-av-display').textContent = osAV;
    }
    
    // Interpretación
    let interpretation = '';
    const avgSphere = (odSphere + osSphere) / 2;
    const avgCyl = (Math.abs(odCyl) + Math.abs(osCyl)) / 2;
    
    if (avgSphere < -0.5) {
        interpretation += 'Miopía';
    } else if (avgSphere > 0.5) {
        interpretation += 'Hipermetropía';
    } else {
        interpretation += 'Emetropía';
    }
    
    if (avgCyl >= 0.5) {
        interpretation += ' con Astigmatismo';
        if (avgCyl >= 2.0) interpretation += ' Alto';
        else if (avgCyl >= 1.0) interpretation += ' Moderado';
        else interpretation += ' Bajo';
    }
    
    // Verificar presbicia (si hay adición)
    const odAdd = parseFloat(document.querySelector('input[name="refraction_od_add"]')?.value) || 0;
    const osAdd = parseFloat(document.querySelector('input[name="refraction_os_add"]')?.value) || 0;
    if (odAdd > 0 || osAdd > 0) {
        interpretation += ' + Presbicia';
    }
    
    if (interpretation === '') {
        interpretation = 'Ingrese valores de refracción para ver la interpretación';
    }
    
    if (document.getElementById('refraction-interpretation')) {
        document.getElementById('refraction-interpretation').innerHTML = '<i class="fas fa-info-circle mr-1"></i>' + interpretation;
    }
}

// Agregar event listeners a los campos de refracción
const refractionInputs = [
    'refraction_od_sphere', 'refraction_od_cylinder', 'refraction_od_axis', 'refraction_od_add',
    'refraction_os_sphere', 'refraction_os_cylinder', 'refraction_os_axis', 'refraction_os_add',
    'va_od_cc_distance', 'va_os_cc_distance'
];

document.addEventListener('DOMContentLoaded', function() {
    refractionInputs.forEach(function(inputName) {
        const input = document.querySelector(`input[name="${inputName}"]`);
        if (input) {
            input.addEventListener('input', updateRefractionDisplay);
            input.addEventListener('change', updateRefractionDisplay);
        }
    });
    
    // Inicializar display
    updateRefractionDisplay();
    
    // Inicializar medicamentos seleccionados
    updateSelectedMedicationsVisual();
    
    // Inicializar tratamientos seleccionados
    updateSelectedTreatmentsVisual();
    
    // Intentar restaurar datos guardados
    const restored = loadFormFromLocalStorage();
    
    // Configurar autoguardado
    setupAutosave();
    
    // Si se restauraron datos, actualizar displays
    if (restored) {
        updateRefractionDisplay();
        if (typeof updateRadarChart === 'function') updateRadarChart();
        if (typeof updateSelectedTreatmentsVisual === 'function') updateSelectedTreatmentsVisual();
    }
    
    // Inicializar visualización de tratamientos si hay pre-seleccionados
    if (typeof updateSelectedTreatmentsVisual === 'function') {
        setTimeout(function() {
            updateSelectedTreatmentsVisual();
        }, 100);
        if (typeof updatePolarChart === 'function') updatePolarChart();
        if (typeof updateSeverityIndicators === 'function') updateSeverityIndicators();
    }
});

// Mostrar notificación temporal
function showNotification(message, type = 'info') {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in-out`;
    notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 2000);
}

// Atajos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+S para guardar
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('visualExamForm').requestSubmit();
    }
    // Ctrl+D para copiar OD a OI
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        copyODtoOI();
    }
});

// Submit del formulario con validación y feedback
document.getElementById('visualExamForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Deshabilitar botón y mostrar loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    submitBtn.classList.add('opacity-75');
    
    const formData = new FormData(this);
    
    fetch('', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>¡Guardado!';
            submitBtn.classList.remove('bg-purple-600');
            submitBtn.classList.add('bg-green-600');
            showNotification('Examen guardado exitosamente', 'success');
            
            setTimeout(() => {
                window.location.href = '{% url "dashboard:patient_detail" patient.id %}';
            }, 1000);
        } else {
            showNotification('Error: ' + (data.message || 'No se pudo guardar el examen'), 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            submitBtn.classList.remove('opacity-75');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al guardar el examen visual', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        submitBtn.classList.remove('opacity-75');
    });
});

// ============ VISUALIZACIONES MÉDICAS AVANZADAS ============

let radarChart = null;
let polarChart = null;

// Inicializar gráficos al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    initRadarChart();
    initPolarChart();
    attachRealtimeListeners();
});

// Gráfico Radar: Comparación OD vs OI
function initRadarChart() {
    const ctx = document.getElementById('radarChart').getContext('2d');
    
    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Esfera', 'Cilindro', 'Add', 'Prism', 'DNP', 'Agudeza'],
            datasets: [
                {
                    label: 'OD',
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: 'rgba(239, 68, 68, 0.2)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(239, 68, 68, 1)',
                    pointRadius: 5,
                    pointHoverRadius: 7
                },
                {
                    label: 'OI',
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(59, 130, 246, 1)',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 10,
                    ticks: {
                        stepSize: 2,
                        font: { size: 10 }
                    },
                    pointLabels: {
                        font: { size: 11, weight: 'bold' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.r.toFixed(2);
                        }
                    }
                }
            },
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            }
        }
    });
}

// Gráfico Polar: Eje de Astigmatismo
function initPolarChart() {
    const ctx = document.getElementById('polarChart').getContext('2d');
    
    polarChart = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: ['0°', '30°', '60°', '90°', '120°', '150°', '180°'],
            datasets: [
                {
                    label: 'OD Eje',
                    data: [0, 0, 0, 0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.6)',
                        'rgba(239, 68, 68, 0.5)',
                        'rgba(239, 68, 68, 0.4)',
                        'rgba(239, 68, 68, 0.3)',
                        'rgba(239, 68, 68, 0.2)',
                        'rgba(239, 68, 68, 0.1)',
                        'rgba(239, 68, 68, 0.05)'
                    ],
                    borderWidth: 2,
                    borderColor: 'rgba(239, 68, 68, 0.8)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        display: false
                    },
                    pointLabels: {
                        font: { size: 12, weight: 'bold' }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            },
            animation: {
                duration: 600,
                easing: 'easeInOutCubic'
            }
        }
    });
}

// Actualizar gráfico radar con valores reales
function updateRadarChart() {
    const odSphere = Math.abs(parseFloat(document.getElementById('refraction_od_sphere')?.value) || 0);
    const oiSphere = Math.abs(parseFloat(document.getElementById('refraction_os_sphere')?.value) || 0);
    const odCyl = Math.abs(parseFloat(document.getElementById('refraction_od_cylinder')?.value) || 0);
    const oiCyl = Math.abs(parseFloat(document.getElementById('refraction_os_cylinder')?.value) || 0);
    const odAdd = Math.abs(parseFloat(document.getElementById('refraction_od_add')?.value) || 0);
    const oiAdd = Math.abs(parseFloat(document.getElementById('refraction_os_add')?.value) || 0);
    const odPrism = Math.abs(parseFloat(document.getElementById('refraction_od_prism')?.value) || 0);
    const oiPrism = Math.abs(parseFloat(document.getElementById('refraction_os_prism')?.value) || 0);
    const odDnp = Math.abs(parseFloat(document.getElementById('refraction_od_dnp')?.value) || 0);
    const oiDnp = Math.abs(parseFloat(document.getElementById('refraction_os_dnp')?.value) || 0);
    
    // Convertir agudeza visual a valor numérico
    const odVa = convertVAtoNumber(document.getElementById('va_od_cc')?.value);
    const oiVa = convertVAtoNumber(document.getElementById('va_os_cc')?.value);
    
    radarChart.data.datasets[0].data = [odSphere, odCyl, odAdd, odPrism, odDnp/10, odVa];
    radarChart.data.datasets[1].data = [oiSphere, oiCyl, oiAdd, oiPrism, oiDnp/10, oiVa];
    radarChart.update('none'); // Sin animación para actualizaciones en tiempo real
}

// Actualizar gráfico polar con ejes de astigmatismo
function updatePolarChart() {
    const odAxis = parseFloat(document.getElementById('refraction_od_axis')?.value) || 0;
    const oiAxis = parseFloat(document.getElementById('refraction_os_axis')?.value) || 0;
    const odCyl = Math.abs(parseFloat(document.getElementById('refraction_od_cylinder')?.value) || 0);
    const oiCyl = Math.abs(parseFloat(document.getElementById('refraction_os_cylinder')?.value) || 0);
    
    // Actualizar labels
    document.getElementById('odAxisLabel').textContent = odAxis ? odAxis + '°' : '--°';
    document.getElementById('oiAxisLabel').textContent = oiAxis ? oiAxis + '°' : '--°';
    
    // Crear array de datos para visualizar el eje
    const data = [0, 0, 0, 0, 0, 0, 0];
    
    // OD: Determinar en qué segmento cae el eje
    if (odCyl > 0) {
        const segment = Math.floor(odAxis / 30);
        data[segment] = odCyl * 2; // Multiplicar para mejor visualización
    }
    
    polarChart.data.datasets[0].data = data;
    
    // Actualizar colores basado en OI
    if (oiCyl > 0) {
        const oiSegment = Math.floor(oiAxis / 30);
        polarChart.data.datasets[0].backgroundColor = data.map((val, idx) => {
            if (idx === oiSegment) {
                return 'rgba(59, 130, 246, 0.6)'; // Azul para OI
            } else if (val > 0) {
                return 'rgba(239, 68, 68, 0.6)'; // Rojo para OD
            }
            return 'rgba(200, 200, 200, 0.2)';
        });
    }
    
    polarChart.update('none');
}

// Convertir agudeza visual a valor numérico
function convertVAtoNumber(va) {
    if (!va) return 0;
    if (va === 'NPL') return 0;
    if (va === 'PL') return 1;
    if (va === 'MM') return 2;
    if (va === 'CD') return 3;
    
    // Formato 20/XX
    const match = va.match(/20\/(\d+)/);
    if (match) {
        const denominator = parseInt(match[1]);
        return Math.max(0, 10 - (denominator - 20) / 10);
    }
    return 0;
}

// Actualizar indicadores de severidad
function updateSeverityIndicators() {
    // Esfera OD - manejar "N/A" y valores de texto
    const odSphereValue = document.getElementById('refraction_od_sphere')?.value || '';
    const odSphere = odSphereValue.toUpperCase() === 'N/A' || odSphereValue === '' ? 0 : parseFloat(odSphereValue) || 0;
    console.log('Actualizando Esfera OD:', odSphereValue, '→', odSphere);
    updateSphereIndicator('od', odSphere);
    
    // Esfera OI - manejar "N/A" y valores de texto
    const oiSphereValue = document.getElementById('refraction_os_sphere')?.value || '';
    const oiSphere = oiSphereValue.toUpperCase() === 'N/A' || oiSphereValue === '' ? 0 : parseFloat(oiSphereValue) || 0;
    console.log('Actualizando Esfera OI:', oiSphereValue, '→', oiSphere);
    updateSphereIndicator('oi', oiSphere);
    
    // Cilindro OD
    const odCyl = parseFloat(document.getElementById('refraction_od_cylinder')?.value) || 0;
    console.log('Actualizando Cilindro OD:', document.getElementById('refraction_od_cylinder')?.value, '→', odCyl);
    updateCylinderIndicator('od', Math.abs(odCyl)); // Usar valor absoluto para el indicador
    
    // Cilindro OI
    const oiCyl = parseFloat(document.getElementById('refraction_os_cylinder')?.value) || 0;
    console.log('Actualizando Cilindro OI:', document.getElementById('refraction_os_cylinder')?.value, '→', oiCyl);
    updateCylinderIndicator('oi', Math.abs(oiCyl)); // Usar valor absoluto para el indicador
    
    // Agudeza Visual OD
    const odVa = document.getElementById('va_od_cc')?.value;
    updateVAIndicator('od', odVa);
    
    // Agudeza Visual OI
    const oiVa = document.getElementById('va_os_cc')?.value;
    updateVAIndicator('oi', oiVa);
}

// Actualizar indicador de esfera
function updateSphereIndicator(eye, value) {
    const bar = document.getElementById(eye + 'SphereBar');
    const status = document.getElementById(eye + 'SphereStatus');
    
    if (!bar || !status) return;
    
    const absValue = Math.abs(value);
    let percent, color, text;
    
    if (value === 0) {
        // Sin datos o valor 0
        percent = 0;
        color = 'from-gray-300 to-gray-400';
        text = '--';
    } else if (value < -6) {
        percent = 100;
        color = 'from-red-600 to-red-700';
        text = 'Miopía Alta';
    } else if (value < -3) {
        percent = 75;
        color = 'from-orange-500 to-orange-600';
        text = 'Miopía Moderada';
    } else if (value < -0.5) {
        percent = 60;
        color = 'from-yellow-400 to-yellow-500';
        text = 'Miopía Baja';
    } else if (value > 5) {
        percent = 100;
        color = 'from-purple-600 to-purple-700';
        text = 'Hipermetropía Alta';
    } else if (value > 2) {
        percent = 75;
        color = 'from-blue-500 to-blue-600';
        text = 'Hipermetropía Moderada';
    } else if (value > 0.5) {
        percent = 60;
        color = 'from-cyan-400 to-cyan-500';
        text = 'Hipermetropía Baja';
    } else {
        percent = 50;
        color = 'from-green-400 to-green-500';
        text = 'Normal';
    }
    
    bar.style.width = percent + '%';
    bar.className = 'h-full bg-gradient-to-r ' + color + ' transition-all duration-500';
    status.textContent = text;
}

// Actualizar indicador de cilindro
function updateCylinderIndicator(eye, value) {
    const bar = document.getElementById(eye + 'CylBar');
    const status = document.getElementById(eye + 'CylStatus');
    
    if (!bar || !status) return;
    
    const absValue = Math.abs(value);
    let percent, color, text;
    
    if (absValue >= 4) {
        percent = 100;
        color = 'from-red-600 to-red-700';
        text = 'Astigmatismo Alto';
    } else if (absValue >= 2) {
        percent = 75;
        color = 'from-orange-500 to-orange-600';
        text = 'Astigmatismo Moderado';
    } else if (absValue >= 0.5) {
        percent = 50;
        color = 'from-yellow-400 to-yellow-500';
        text = 'Astigmatismo Bajo';
    } else if (absValue > 0.01) {
        // Hay un valor pero es muy pequeño (menos de 0.5)
        percent = 25;
        color = 'from-lime-400 to-lime-500';
        text = 'Astigmatismo Mínimo';
    } else {
        percent = 0;
        color = 'from-gray-300 to-gray-400';
        text = '--';
    }
    
    bar.style.width = percent + '%';
    bar.className = 'h-full bg-gradient-to-r ' + color + ' transition-all duration-500';
    status.textContent = text;
}

// Actualizar indicador de agudeza visual
function updateVAIndicator(eye, value) {
    const bar = document.getElementById(eye + 'VaBar');
    const status = document.getElementById(eye + 'VaStatus');
    
    if (!value) {
        bar.style.width = '0%';
        status.textContent = '--';
        return;
    }
    
    let percent, color;
    
    if (value === '20/15' || value === '20/20') {
        percent = 100;
        color = 'from-green-500 to-green-600';
    } else if (value === '20/25' || value === '20/30') {
        percent = 80;
        color = 'from-lime-500 to-lime-600';
    } else if (value === '20/40' || value === '20/50') {
        percent = 60;
        color = 'from-yellow-500 to-yellow-600';
    } else if (value === '20/60' || value === '20/70') {
        percent = 40;
        color = 'from-orange-500 to-orange-600';
    } else if (value === '20/80' || value === '20/100') {
        percent = 30;
        color = 'from-red-500 to-red-600';
    } else if (value === '20/200' || value === '20/400') {
        percent = 20;
        color = 'from-red-600 to-red-700';
    } else if (value === 'CD' || value === 'MM') {
        percent = 10;
        color = 'from-red-700 to-red-800';
    } else if (value === 'PL' || value === 'NPL') {
        percent = 5;
        color = 'from-gray-700 to-gray-800';
    } else {
        percent = 50;
        color = 'from-blue-400 to-blue-500';
    }
    
    bar.style.width = percent + '%';
    bar.className = 'h-full bg-gradient-to-r ' + color + ' transition-all duration-500';
    status.textContent = value;
}

// Adjuntar listeners para actualización en tiempo real
function attachRealtimeListeners() {
    const fieldsToWatch = [
        'refraction_od_sphere', 'refraction_os_sphere',
        'refraction_od_cylinder', 'refraction_os_cylinder',
        'refraction_od_axis', 'refraction_os_axis',
        'refraction_od_add', 'refraction_os_add',
        'refraction_od_prism', 'refraction_os_prism',
        'refraction_od_dnp', 'refraction_os_dnp',
        'va_od_cc', 'va_os_cc'
    ];
    
    fieldsToWatch.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function() {
                updateRadarChart();
                updatePolarChart();
                updateSeverityIndicators();
            });
        }
    });
}

// Añadir animación CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes fade-in-out {
        0% { opacity: 0; transform: translateY(-20px); }
        10% { opacity: 1; transform: translateY(0); }
        90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-20px); }
    }
    .animate-fade-in-out {
        animation: fade-in-out 2s ease-in-out;
    }
    
    @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 5px rgba(147, 51, 234, 0.5); }
        50% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.8); }
    }
`;
document.head.appendChild(style);

// ============================================================
// FUNCIONES DE MODALES PARA AGREGAR PARÁMETROS
// ============================================================

// MODALES
function openMaterialModal() {
    document.getElementById('materialModal').classList.remove('hidden');
}

function closeMaterialModal() {
    document.getElementById('materialModal').classList.add('hidden');
    document.getElementById('materialForm').reset();
}

function openTreatmentModal() {
    document.getElementById('treatmentModal').classList.remove('hidden');
}

function closeTreatmentModal() {
    document.getElementById('treatmentModal').classList.add('hidden');
    document.getElementById('treatmentForm').reset();
}

function openMedicationModal() {
    document.getElementById('medicationModal').classList.remove('hidden');
}

function closeMedicationModal() {
    document.getElementById('medicationModal').classList.add('hidden');
    document.getElementById('medicationForm').reset();
}

// Guardar Material
function saveMaterial() {
    const form = document.getElementById('materialForm');
    const formData = new FormData(form);
    const btn = document.getElementById('saveMaterialBtn');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    
    fetch('/dashboard/configuration/clinical-parameters/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar al select
            const select = document.getElementById('lens_material');
            const option = new Option(data.parameter.name, data.parameter.id, true, true);
            select.add(option);
            
            // Notificación
            showNotification('Material agregado exitosamente', 'success');
            closeMaterialModal();
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Error al guardar el material', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar';
    });
}

// Guardar Tratamiento
function saveTreatment() {
    const form = document.getElementById('treatmentForm');
    const formData = new FormData(form);
    const btn = document.getElementById('saveTreatmentBtn');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    
    fetch('/dashboard/configuration/clinical-parameters/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar al select
            const select = document.getElementById('lens_coating');
            const option = new Option(data.parameter.name, data.parameter.id, true, true);
            select.add(option);
            
            // Notificación
            showNotification('Tratamiento agregado exitosamente', 'success');
            closeTreatmentModal();
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Error al guardar el tratamiento', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar';
    });
}

// Guardar Medicamento
function saveMedication() {
    const form = document.getElementById('medicationForm');
    const formData = new FormData(form);
    const btn = document.getElementById('saveMedicationBtn');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
    
    fetch('/dashboard/configuration/clinical-parameters/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar al textarea de medicamentos
            const textarea = document.getElementById('medication_details');
            const medInfo = `${data.parameter.name}`;
            if (textarea.value) {
                textarea.value += `\n${medInfo}`;
            } else {
                textarea.value = medInfo;
            }
            
            // Notificación
            showNotification('Medicamento agregado exitosamente', 'success');
            closeMedicationModal();
        } else {
            showNotification('Error: ' + data.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Error al guardar el medicamento', 'error');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-2"></i>Guardar';
    });
}

// Función de notificación
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Cerrar modales con ESC
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMaterialModal();
        closeTreatmentModal();
        closeMedicationModal();
    }
});
</script>

<!-- Modal Material -->
<div id="materialModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-plus-circle text-pink-600 mr-2"></i>Agregar Material
            </h3>
            <button onclick="closeMaterialModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="materialForm" onsubmit="event.preventDefault(); saveMaterial();">
            <input type="hidden" name="parameter_type" value="lens_material">
            <input type="hidden" name="display_order" value="0">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Policarbonato">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Características del material"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <input type="text" name="category"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Alto índice">
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="button" onclick="saveMaterial()" id="saveMaterialBtn"
                        class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <button type="button" onclick="closeMaterialModal()"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Tratamiento -->
<div id="treatmentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-plus-circle text-pink-600 mr-2"></i>Agregar Tratamiento
            </h3>
            <button onclick="closeTreatmentModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="treatmentForm" onsubmit="event.preventDefault(); saveTreatment();">
            <input type="hidden" name="parameter_type" value="treatment">
            <input type="hidden" name="display_order" value="0">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Antireflejo, Blue Light, Fotocromatico">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Beneficios del tratamiento"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                        <option value="">Sin Descripción</option>
                        <option value="Protección">Protección</option>
                        <option value="Filtro">Filtro</option>
                        <option value="Antireflejo">Antireflejo</option>
                        <option value="Endurecimiento">Endurecimiento</option>
                        <option value="Transición">Transición</option>
                        <option value="Medicamento">Medicamento</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="button" onclick="saveTreatment()" id="saveTreatmentBtn"
                        class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <button type="button" onclick="closeTreatmentModal()"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Medicamento -->
<div id="medicationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-plus-circle text-pink-600 mr-2"></i>Agregar Medicamento
            </h3>
            <button onclick="closeMedicationModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="medicationForm" onsubmit="event.preventDefault(); saveMedication();">
            <input type="hidden" name="parameter_type" value="medication">
            <input type="hidden" name="display_order" value="0">
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Medicamento *</label>
                    <input type="text" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                           placeholder="Ej: Dorzolamida 2%">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dosis</label>
                        <input type="text" name="dosage"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                               placeholder="1 gota">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                        <input type="text" name="frequency"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                               placeholder="Cada 8 horas">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Duración</label>
                        <input type="text" name="duration"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                               placeholder="7 días">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Vía</label>
                        <select name="administration_route"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500">
                            <option value="">Seleccionar...</option>
                            <option value="topical">Tópico</option>
                            <option value="oral">Oral</option>
                            <option value="parenteral">Parenteral</option>
                            <option value="sublingual">Sublingual</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción / Indicaciones</label>
                    <textarea name="description" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                              placeholder="Indicaciones especiales"></textarea>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button type="button" onclick="saveMedication()" id="saveMedicationBtn"
                        class="flex-1 bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <button type="button" onclick="closeMedicationModal()"
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// ============ AUTOCOMPLETAR CAMPOS SEGÚN CARTILLA SELECCIONADA ============
document.addEventListener('DOMContentLoaded', function() {
    const distanceChartSelect = document.getElementById('distance_chart');
    const nearChartSelect = document.getElementById('near_chart');
    
    // Valores por defecto según cada cartilla
    const chartValues = {
        'Snellen metros': {
            distance: ['6/6', '6/9', '6/12', '6/15', '6/18', '6/24', '6/30', '6/60'],
            unit: 'm'
        },
        'Snellen pies': {
            distance: ['20/20', '20/25', '20/30', '20/40', '20/50', '20/60', '20/80', '20/100', '20/200'],
            unit: 'pies'
        },
        'ETDRS logMAR': {
            distance: ['0.0', '0.1', '0.2', '0.3', '0.4', '0.5', '0.6', '0.7', '0.8', '0.9', '1.0'],
            unit: 'logMAR'
        },
        'Decimal': {
            distance: ['1.0', '0.9', '0.8', '0.7', '0.6', '0.5', '0.4', '0.3', '0.2', '0.1'],
            unit: 'decimal'
        },
        'Jaeger': {
            near: ['J1 a 40cm', 'J2 a 40cm', 'J3 a 40cm', 'J4 a 40cm', 'J5 a 40cm', 'J6 a 40cm'],
            unit: 'cm'
        },
        'Rosenbaum': {
            near: ['20/20 a 35cm', '20/25 a 35cm', '20/30 a 35cm', '20/40 a 35cm', '20/50 a 35cm'],
            unit: 'cm'
        },
        'Snellen cerca': {
            near: ['20/20 a 40cm', '20/25 a 40cm', '20/30 a 40cm', '20/40 a 40cm'],
            unit: 'cm'
        }
    };
    
    // Actualizar placeholders según cartilla de lejos
    if (distanceChartSelect) {
        distanceChartSelect.addEventListener('change', function() {
            const selectedChart = this.value;
            const chartData = chartValues[selectedChart];
            
            if (chartData && chartData.distance) {
                const exampleValue = chartData.distance[0]; // Primer valor como ejemplo
                const inputs = [
                    'va_od_sc_distance',
                    'va_od_cc_distance',
                    'va_os_sc_distance',
                    'va_os_cc_distance'
                ];
                
                inputs.forEach(inputName => {
                    const input = document.querySelector(`input[name="${inputName}"]`);
                    if (input) {
                        input.placeholder = exampleValue;
                        // Mostrar tooltipcon opciones disponibles
                        input.title = `Valores comunes: ${chartData.distance.slice(0, 5).join(', ')}...`;
                    }
                });
                
                console.log(`✓ Cartilla de lejos seleccionada: ${selectedChart} (${chartData.unit})`);
            }
        });
    }
    
    // Actualizar placeholders según cartilla de cerca
    if (nearChartSelect) {
        nearChartSelect.addEventListener('change', function() {
            const selectedChart = this.value;
            const chartData = chartValues[selectedChart];
            
            if (chartData && chartData.near) {
                const exampleValue = chartData.near[0]; // Primer valor como ejemplo
                const inputs = [
                    'va_od_sc_near',
                    'va_od_cc_near',
                    'va_os_sc_near',
                    'va_os_cc_near'
                ];
                
                inputs.forEach(inputName => {
                    const input = document.querySelector(`input[name="${inputName}"]`);
                    if (input) {
                        input.placeholder = exampleValue;
                        // Mostrar tooltip con opciones disponibles
                        input.title = `Valores comunes: ${chartData.near.slice(0, 4).join(', ')}...`;
                    }
                });
                
                console.log(`✓ Cartilla de cerca seleccionada: ${selectedChart} (${chartData.unit})`);
            }
        });
    }
    
    // Trigger inicial si ya hay una cartilla seleccionada
    if (distanceChartSelect && distanceChartSelect.value) {
        distanceChartSelect.dispatchEvent(new Event('change'));
    }
    if (nearChartSelect && nearChartSelect.value) {
        nearChartSelect.dispatchEvent(new Event('change'));
    }
});

// ========== MODAL PARA CREAR TIPO DE LENTE ==========
function showCreateLensTypeModal() {
    const modalHtml = `
        <div id="lensTypeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeLensTypeModal(event)">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="bg-indigo-600 text-white px-6 py-4 rounded-t-lg flex items-center justify-between">
                    <h3 class="text-lg font-bold flex items-center">
                        <i class="fas fa-glasses mr-2"></i>
                        Crear Nuevo Tipo de Lente
                    </h3>
                    <button type="button" onclick="closeLensTypeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <form id="lensTypeForm" onsubmit="submitLensType(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Nombre del Tipo de Lente <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="lens_type_name" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                       placeholder="Ej: Monofocal, Bifocal, Progresivo, etc.">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Código/Abreviatura
                                </label>
                                <input type="text" id="lens_type_code"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                       placeholder="Ej: MONO, BIF, PROG">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Descripción
                                </label>
                                <textarea id="lens_type_description" rows="2"
                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                          placeholder="Descripción opcional del tipo de lente"></textarea>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeLensTypeModal()"
                                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium">
                                Cancelar
                            </button>
                            <button type="submit"
                                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium">
                                <i class="fas fa-save mr-1"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    document.getElementById('lens_type_name').focus();
}

function closeLensTypeModal(event) {
    if (!event || event.target.id === 'lensTypeModal') {
        const modal = document.getElementById('lensTypeModal');
        if (modal) {
            modal.remove();
        }
    }
}

function submitLensType(event) {
    event.preventDefault();
    
    const name = document.getElementById('lens_type_name').value.trim();
    const code = document.getElementById('lens_type_code').value.trim();
    const description = document.getElementById('lens_type_description').value.trim();
    
    if (!name) {
        alert('Por favor ingrese el nombre del tipo de lente');
        return;
    }
    
    // Preparar datos
    const formData = new FormData();
    formData.append('parameter_type', 'lens_type');
    formData.append('name', name);
    formData.append('code', code);
    formData.append('description', description);
    formData.append('is_active', 'true');
    
    // Enviar a servidor
    fetch('{% url "dashboard:clinical_parameter_create" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Agregar nueva opción al select
            const select = document.getElementById('lensometry_lens_type');
            const option = new Option(data.parameter.name, data.parameter.id, true, true);
            select.add(option);
            
            // Cerrar modal
            closeLensTypeModal();
            
            // Mostrar mensaje de éxito
            showSuccessMessage('Tipo de lente creado exitosamente');
        } else {
            alert('Error al crear tipo de lente: ' + (data.message || data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error capturado:', error);
        let errorMsg = 'Error al crear tipo de lente.';
        
        if (error.message) {
            errorMsg += ' ' + error.message;
        } else if (error.errors) {
            errorMsg += ' ' + JSON.stringify(error.errors);
        }
        
        alert(errorMsg + ' Por favor intente nuevamente.');
    });
}

function showSuccessMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
    messageDiv.innerHTML = `
        <i class="fas fa-check-circle mr-2"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// ============ TOGGLE EXÁMENES REFRACTIVOS ADICIONALES ============
function toggleExamSection(examType, isChecked) {
    const section = document.getElementById('section_' + examType);
    if (section) {
        section.style.display = isChecked ? 'block' : 'none';
    }
}

// ============ COPIAR DATOS A RX FINAL ============
function copyToFinalRx(sourceExam) {
    // Definir los campos a copiar (OD y OS)
    const fields = ['sphere', 'cylinder', 'axis', 'add'];
    const eyes = ['od', 'os'];
    
    let copiedFields = 0;
    
    // Copiar cada campo de OD y OS
    eyes.forEach(eye => {
        fields.forEach(field => {
            const sourceField = document.querySelector(`input[name="${sourceExam}_${eye}_${field}"]`);
            const targetField = document.querySelector(`input[name="final_rx_${eye}_${field}"]`);
            
            if (sourceField && targetField) {
                const value = sourceField.value.trim();
                if (value !== '') {
                    targetField.value = value;
                    // Efecto visual de cambio
                    targetField.classList.add('bg-green-100');
                    setTimeout(() => {
                        targetField.classList.remove('bg-green-100');
                    }, 1000);
                    copiedFields++;
                }
            }
        });
    });
    
    // Mensaje de confirmación moderno
    if (copiedFields > 0) {
        const examNames = {
            'retinoscopy': 'Retinoscopia',
            'subjective': 'Subjetivo',
            'refinement': 'Afinación',
            'cycloplegic': 'Subjetivo Ciclopléjico'
        };
        
        showModernNotification(`Datos copiados desde ${examNames[sourceExam]} a RX Final (${copiedFields} campos)`, 'success');
    } else {
        showModernNotification(`No hay datos en ${sourceExam} para copiar. Por favor ingresa los datos primero.`, 'warning');
    }
}

// ============ NOTIFICACIÓN MODERNA ============
function showModernNotification(message, type = 'info') {
    // Eliminar notificación anterior si existe
    const existingNotification = document.getElementById('modern-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Configuración de colores según tipo
    const config = {
        success: {
            bg: 'bg-gradient-to-r from-green-500 to-emerald-600',
            icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        },
        error: {
            bg: 'bg-gradient-to-r from-red-500 to-pink-600',
            icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        },
        warning: {
            bg: 'bg-gradient-to-r from-yellow-500 to-orange-600',
            icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'
        },
        info: {
            bg: 'bg-gradient-to-r from-blue-500 to-indigo-600',
            icon: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        }
    };
    
    const { bg, icon } = config[type] || config.info;
    
    // Crear notificación
    const notification = document.createElement('div');
    notification.id = 'modern-notification';
    notification.className = `fixed top-20 right-4 ${bg} text-white px-6 py-4 rounded-lg shadow-2xl z-50 flex items-center gap-3 transform transition-all duration-300 ease-out translate-x-0`;
    notification.style.minWidth = '300px';
    notification.style.maxWidth = '500px';
    notification.innerHTML = `
        <div class="flex-shrink-0">${icon}</div>
        <div class="flex-1 text-sm font-medium">${message}</div>
        <button onclick="this.parentElement.remove()" class="flex-shrink-0 hover:bg-white/20 rounded p-1 transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    
    // Agregar al DOM
    document.body.appendChild(notification);
    
    // Animación de entrada
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto-ocultar después de 4 segundos
    setTimeout(() => {
        notification.style.transform = 'translateX(120%)';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 4000);
}

// Inicializar el estado de las secciones al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    const exams = ['retinoscopy', 'subjective', 'refinement', 'cycloplegic', 'final_rx'];
    exams.forEach(exam => {
        const checkbox = document.getElementById('check_' + exam);
        if (checkbox) {
            toggleExamSection(exam, checkbox.checked);
        }
    });
});
</script>

{% endblock %}
