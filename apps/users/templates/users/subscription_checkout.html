{% extends "dashboard/base.html" %}

{% block title %}Checkout - {{ plan.name }}{% endblock %}

{% block extra_head %}
<script src="https://checkout.wompi.co/widget.js"></script>
<style>
    .card-option {
        transition: all 0.3s ease;
    }
    .card-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .card-option.selected {
        border-color: #6366f1;
        background-color: #eef2ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6">
        <a href="{% url 'organizations:subscription_plans' %}" class="text-indigo-600 hover:text-indigo-800 flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Volver a planes
        </a>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            <i class="fas fa-shopping-cart mr-3 text-indigo-600"></i>Checkout
        </h1>

        <!-- Resumen del Plan -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg p-6 mb-8 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold mb-2">{{ plan.name }}</h2>
                    <p class="text-indigo-100">{{ plan.description }}</p>
                </div>
                <div class="text-right">
                    <p class="text-3xl font-bold">${{ amount|floatformat:0 }} COP</p>
                    <p class="text-indigo-100">{% if billing_cycle == 'yearly' %}Anual{% else %}Mensual{% endif %}</p>
                </div>
            </div>
        </div>

        <form id="payment-form" method="POST" action="{% url 'users:process_subscription_payment' plan.id %}">
            {% csrf_token %}
            <input type="hidden" name="billing_cycle" value="{{ billing_cycle }}">
            <input type="hidden" name="card_token" id="card_token">
            <input type="hidden" name="card_last_four" id="card_last_four">
            <input type="hidden" name="card_brand" id="card_brand">
            <input type="hidden" name="card_holder_name" id="card_holder_name">
            <input type="hidden" name="card_type" id="card_type">

            <!-- Métodos de Pago Guardados -->
            {% if payment_methods %}
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-credit-card mr-2 text-indigo-600"></i>Tus tarjetas guardadas
                </h3>
                
                <div class="space-y-3">
                    {% for method in payment_methods %}
                    <label class="card-option cursor-pointer block border-2 border-gray-200 rounded-lg p-4 hover:border-indigo-400">
                        <div class="flex items-center">
                            <input type="radio" name="payment_method_id" value="{{ method.id }}" 
                                   class="mr-4 h-5 w-5 text-indigo-600" 
                                   {% if method.is_default %}checked{% endif %}>
                            <div class="flex-1 flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-credit-card text-2xl mr-4 text-gray-600"></i>
                                    <div>
                                        <p class="font-semibold">{{ method.card_brand }} **** {{ method.card_last_four }}</p>
                                        <p class="text-sm text-gray-600">{{ method.card_holder_name }}</p>
                                    </div>
                                </div>
                                {% if method.is_default %}
                                <span class="bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full">
                                    Predeterminada
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Nueva Tarjeta -->
            <div class="mb-8">
                <label class="card-option cursor-pointer block border-2 border-gray-200 rounded-lg p-4 hover:border-indigo-400">
                    <div class="flex items-center mb-4">
                        <input type="radio" name="payment_method_id" value="" id="new-card-radio" 
                               {% if not payment_methods %}checked{% endif %}
                               class="mr-4 h-5 w-5 text-indigo-600">
                        <h3 class="text-xl font-semibold text-gray-800">
                            <i class="fas fa-plus-circle mr-2 text-indigo-600"></i>Usar nueva tarjeta
                        </h3>
                    </div>
                </label>
                
                <div id="new-card-fields" class="mt-4 p-6 bg-indigo-50 border-2 border-indigo-400 rounded-lg" style="display: {% if not payment_methods %}block{% else %}none{% endif %};">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Número de Tarjeta -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Número de Tarjeta
                            </label>
                            <input type="text" id="card-number" maxlength="19" placeholder="1234 5678 9012 3456"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">Ingresa tu número de tarjeta</p>
                        </div>
                        
                        <!-- Nombre del Titular -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nombre del Titular
                            </label>
                            <input type="text" id="card-holder" placeholder="Juan Pérez"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        
                        <!-- Fecha de Expiración -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Fecha de Expiración
                            </label>
                            <input type="text" id="card-expiry" placeholder="12/25" maxlength="5"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        
                        <!-- CVV -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                CVV
                            </label>
                            <input type="text" id="card-cvv" placeholder="123" maxlength="4"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Tu información está protegida. Pagos procesados por Wompi.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Botón de Pago -->
            <div class="flex justify-between items-center pt-6 border-t">
                <div>
                    <p class="text-sm text-gray-600">Total a pagar:</p>
                    <p class="text-3xl font-bold text-gray-800">${{ amount|floatformat:0 }} COP</p>
                </div>
                
                <button type="submit" id="pay-button"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition duration-200 flex items-center">
                    <i class="fas fa-lock mr-2"></i>
                    Procesar Pago
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('payment-form');
    const payButton = document.getElementById('pay-button');
    const cardNumber = document.getElementById('card-number');
    const cardHolder = document.getElementById('card-holder');
    const cardExpiry = document.getElementById('card-expiry');
    const cardCvv = document.getElementById('card-cvv');
    const newCardFields = document.getElementById('new-card-fields');
    const paymentMethodRadios = document.querySelectorAll('input[name="payment_method_id"]');
    
    // Mostrar/ocultar campos de nueva tarjeta
    paymentMethodRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === '') {
                newCardFields.style.display = 'block';
            } else {
                newCardFields.style.display = 'none';
            }
        });
    });
    
    // Formatear número de tarjeta
    if (cardNumber) {
        cardNumber.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
            
            // Detectar tipo de tarjeta
            const firstDigit = value[0];
            let brand = 'VISA';
            if (firstDigit === '5') brand = 'MASTERCARD';
            else if (firstDigit === '3') brand = 'AMEX';
            
            document.getElementById('card_brand').value = brand;
            document.getElementById('card_last_four').value = value.slice(-4);
        });
    }
    
    // Formatear fecha de expiración
    if (cardExpiry) {
        cardExpiry.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });
    }
    
    // Solo números en CVV
    if (cardCvv) {
        cardCvv.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
    }
    
    // Tokenizar tarjeta con Wompi
    async function tokenizeCard() {
        const number = cardNumber.value.replace(/\s/g, '');
        const holder = cardHolder.value.trim();
        const expiry = cardExpiry.value.split('/');
        const cvv = cardCvv.value;
        
        // Asegurar que el mes y año tengan el formato correcto
        const expMonth = expiry[0].trim().padStart(2, '0');
        const expYear = expiry[1].trim().padStart(2, '0');
        
        const cardData = {
            number: number,
            cvc: cvv,
            exp_month: expMonth,
            exp_year: expYear,
            card_holder: holder
        };
        
        console.log('Tokenizando tarjeta con datos:', cardData);
        
        try {
            const response = await fetch('https://production.wompi.co/v1/tokens/cards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer {{ wompi_public_key }}'
                },
                body: JSON.stringify(cardData)
            });
            
            const result = await response.json();
            console.log('Respuesta de Wompi:', result);
            
            if (result.status === 'CREATED' && result.data && result.data.id) {
                return result.data.id;
            } else if (result.data && result.data.id) {
                // A veces el status no viene, pero el token sí
                return result.data.id;
            } else {
                // Mostrar error detallado
                let errorMsg = 'Error al tokenizar la tarjeta';
                if (result.error) {
                    if (result.error.messages) {
                        errorMsg = Object.values(result.error.messages).flat().join(', ');
                    } else if (result.error.reason) {
                        errorMsg = result.error.reason;
                    }
                }
                throw new Error(errorMsg);
            }
        } catch (error) {
            console.error('Error tokenizando tarjeta:', error);
            if (error instanceof TypeError && error.message.includes('fetch')) {
                throw new Error('Error de conexión con Wompi. Verifica tu conexión a internet.');
            }
            throw error;
        }
    }
    
    // Validar formulario antes de enviar
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const selectedMethod = document.querySelector('input[name="payment_method_id"]:checked');
        
        // Si es nueva tarjeta, validar y tokenizar
        if (!selectedMethod || selectedMethod.value === '') {
            const number = cardNumber.value.replace(/\s/g, '');
            const holder = cardHolder.value.trim();
            const expiry = cardExpiry.value;
            const cvv = cardCvv.value;
            
            if (!number || number.length < 13) {
                alert('Por favor ingresa un número de tarjeta válido');
                cardNumber.focus();
                return false;
            }
            
            if (!holder) {
                alert('Por favor ingresa el nombre del titular');
                cardHolder.focus();
                return false;
            }
            
            if (!expiry || expiry.length !== 5) {
                alert('Por favor ingresa una fecha de expiración válida (MM/YY)');
                cardExpiry.focus();
                return false;
            }
            
            if (!cvv || cvv.length < 3) {
                alert('Por favor ingresa un CVV válido');
                cardCvv.focus();
                return false;
            }
            
            // Deshabilitar botón mientras tokeniza
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando tarjeta...';
            
            try {
                // Tokenizar la tarjeta
                const token = await tokenizeCard();
                
                // Llenar campos ocultos
                document.getElementById('card_token').value = token;
                document.getElementById('card_holder_name').value = holder;
                document.getElementById('card_type').value = 'CREDIT';
                
                // Enviar formulario
                payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando pago...';
                form.submit();
            } catch (error) {
                alert('Error al procesar la tarjeta: ' + error.message);
                payButton.disabled = false;
                payButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Procesar Pago';
            }
        } else {
            // Usar método de pago guardado
            payButton.disabled = true;
            payButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';
            form.submit();
        }
    });
});
</script>
{% endblock %}
